@using APIs.Steam
@using Microsoft.AspNetCore.Identity
@using pepeizqs_deals_blazor_web.Componentes.Interfaz
@using pepeizqs_deals_web.Data

@inject AuthenticationStateProvider AuthenticationStateProvider

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <base href="/" />

    <ResourcePreloader />
    <link rel="stylesheet" href="@Assets["/css/bundle.css"]" type="text/css" media="print" onload="this.media='all'" />

    <ImportMap />

    <link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-icon-152x152.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-icon-180x180.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/favicons/android-icon-192x192.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="96x96" href="/favicons/favicon-96x96.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="msapplication-TileColor" content="#007272" />
    <meta name="msapplication-TileImage" content="/favicons/ms-icon-144x144.png" />
    <meta name="theme-color" content="#007272" />

    <HeadOutlet @rendermode="renderizacion" />
</head>

<body class="cuerpo" id="cuerpazo" style="margin: 0px;">
    <Cabecera idioma="@idioma" usuarioId="@usuarioId" userAgent="@userAgent" usuarioAdmin="@usuarioAdmin" dominio="@dominio" />

    <main role="main">
        <Routes @rendermode="renderizacion" />
    </main>

    <PiePagina idioma="@idioma" usuarioId="@usuarioId"/>

    @if (Herramientas.Bots.UserAgentEsBot(userAgent) == false)
    {
        <script async src="@Assets["~/superjs.js"]"></script>

        if (enlaceBase.Contains("/game/") == true)
        {
            <script async src="@Assets["/video.js"]"></script>
        }
        
        <div id="reconnect-modal" style="display: none;"></div>
        <script src="@Assets["/_framework/blazor.web.js"]" autostart="false"></script>
        <script src="@Assets["/inicio.js"]"></script>
        <script>navigator.serviceWorker.register('service-worker.js', { updateViaCache: 'none' });</script>
    }
    else
    {
        <script async src="@Assets["/arreglarFalloGoogle.js"]"></script>

        <script>
            arreglarFalloGoogle();
        </script>
    }

    <script>
        function moverScroll(id) {
            const element = document.getElementById(id);
            const y = element.getBoundingClientRect().top;

            window.scrollTo({ top: y, behavior: 'smooth' });
        }
    </script>
</body>

</html>

@code {

    #nullable disable

    [CascadingParameter]
    private HttpContext contexto { get; set; } = default!;

    private IComponentRenderMode renderizacion => contexto.AcceptsInteractiveRouting() ? InteractiveServer : null;

    private string enlaceBase = null;
    private string idioma = "en";
    private string usuarioId = null;
    private string userAgent = null;
    private string dominio = null;
    private bool usuarioAdmin = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        usuarioId = user.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value;

        if (contexto != null)
        {
            idioma = contexto?.Request?.Headers["Accept-Language"].ToString().Split(";").FirstOrDefault()?.Split(",").FirstOrDefault();
            usuarioId = contexto?.User?.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value;
            userAgent = contexto?.Request?.Headers.UserAgent.ToString();
            dominio = contexto?.Request?.Host.Value;

            var path = contexto?.Request?.Path.ToString();
            enlaceBase = path.EndsWith("/") ? path : path + "/";
        }

        if (string.IsNullOrEmpty(usuarioId) == false)
        {
            usuarioAdmin = await BaseDatos.Usuarios.Buscar.RolDios(usuarioId);
            idioma = await BaseDatos.Usuarios.Buscar.IdiomaSobreescribir(usuarioId);

            Usuario usuario = await BaseDatos.Usuarios.Buscar.OpcionesApp(usuarioId);

            if (usuario != null)
            {
                if (usuario?.EmailConfirmed == true)
                {
                    bool patreonActivo = Herramientas.Patreon.VerificarActivo(usuario.PatreonLastCheck);

                    TimeSpan tiempoActualizar = TimeSpan.FromDays(7);

                    if (patreonActivo == true)
                    {
                        tiempoActualizar = TimeSpan.FromDays(1);
                    }

                    if (string.IsNullOrEmpty(usuario.SteamAccount) == false && string.IsNullOrEmpty(usuario.SteamAccountLastCheck) == false)
                    {
                        bool tiempo = true;

                        if (string.IsNullOrEmpty(usuario.SteamAccountLastCheck) == false)
                        {
                            if (Convert.ToDateTime(usuario.SteamAccountLastCheck) + tiempoActualizar > DateTime.Now)
                            {
                                tiempo = false;
                            }
                        }

                        if (tiempo == true)
                        {
                            await BaseDatos.UsuariosActualizar.Insertar.Ejecutar(usuario.Id, "Steam");
                        }
                    }

                    if (string.IsNullOrEmpty(usuario.GogAccount) == false && usuario.GogAccountLastCheck != null)
                    {
                        bool tiempo = true;

                        if (usuario.GogAccountLastCheck + tiempoActualizar > DateTime.Now)
                        {
                            tiempo = false;
                        }

                        if (tiempo == true)
                        {
                            await BaseDatos.UsuariosActualizar.Insertar.Ejecutar(usuario.Id, "GOG");
                        }
                    }

                    if (patreonActivo == true)
                    {
                        if (usuario.PatreonLastLogin == null)
                        {
                            await BaseDatos.Usuarios.Actualizar.Opcion("PatreonLastLogin", DateTime.Now, usuarioId);
                            await BaseDatos.Usuarios.Actualizar.Opcion("PatreonCoins", 2, usuarioId);

                            await BaseDatos.Recompensas.Historial.Insertar(usuario.Id, 2, "Daily", DateTime.Now);
                        }
                        else
                        {
                            if (usuario.PatreonContribution > 0)
                            {
                                if (usuario.PatreonCoins < 120)
                                {
                                    if (usuario.PatreonLastLogin?.DayOfYear != DateTime.Now.DayOfYear)
                                    {
                                        await BaseDatos.Usuarios.Actualizar.Opcion("PatreonLastLogin", DateTime.Now, usuarioId);
                                        await BaseDatos.Usuarios.Actualizar.Opcion("PatreonCoins", (int)usuario.PatreonCoins + 2, usuarioId);

                                        await BaseDatos.Recompensas.Historial.Insertar(usuario.Id, 2, "Daily", DateTime.Now);
                                    }
                                }
                            }
                            else
                            {
                                if (usuario.PatreonCoins < 20)
                                {
                                    if (usuario.PatreonLastLogin?.DayOfYear != DateTime.Now.DayOfYear)
                                    {
                                        await BaseDatos.Usuarios.Actualizar.Opcion("PatreonLastLogin", DateTime.Now, usuarioId);
                                        await BaseDatos.Usuarios.Actualizar.Opcion("PatreonCoins", (int)usuario.PatreonCoins + 2, usuarioId);

                                        await BaseDatos.Recompensas.Historial.Insertar(usuario.Id, 2, "Daily", DateTime.Now);
                                    }
                                }
                            }
                        }
                    }
                }

                if (string.IsNullOrEmpty(idioma) == false)
                {
                    await BaseDatos.Usuarios.Actualizar.Opcion("Language", idioma, usuarioId);
                }
            } 
        }
    }
}