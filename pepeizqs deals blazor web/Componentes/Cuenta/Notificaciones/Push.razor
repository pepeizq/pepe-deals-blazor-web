@page "/push-setup"

@using pepeizqs_deals_web.Data

@inject IJSRuntime JS
@inject HttpClient Http
@inject IConfiguration Config
@inject pepeizqs_deals_webContext Db
@inject AuthenticationStateProvider AuthenticationStateProvider

<h3>Configurar Notificaciones Push</h3>


@if (!supportsNotifications)
{
    <p style="color: red;">Tu navegador no soporta notificaciones push.</p>
}
else
{
    @if (!isSubscribed)
    {
        <button class="btn btn-primary" @onclick="ActivarNotificaciones">
            Activar Notificaciones
        </button>
    }
    else
    {
        <p style="color: green;">✓ Notificaciones activadas</p>
        <button class="btn btn-danger" @onclick="DesactivarNotificaciones">
            Desactivar Notificaciones
        </button>
    }
}

@code {


    private bool supportsNotifications = true;
    private bool isSubscribed = false;
    private bool isInitialized = false;
    private string userId = null;

    protected override async Task OnAfterRenderAsync(bool primerRender)
    {
        if (primerRender == true)
        {
            try
            {
                supportsNotifications = await JS.InvokeAsync<bool>("supportsNotifications");

                if (supportsNotifications == true)
                {
                    var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                    userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

                    if (!string.IsNullOrEmpty(userId))
                    {
                        var existingSubscription = Db.PushSubscriptions.FirstOrDefault(s => s.UserId == userId && s.Activa);

                        if (existingSubscription != null)
                        {
                            isSubscribed = true;
                        }
                    }
                }

                isInitialized = true;
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error supportsNotifications: {ex.Message}");
            }
        }
    }

    private async Task ActivarNotificaciones()
    {
        if (string.IsNullOrEmpty(userId))
        {
            // errorMessage = "Usuario no autenticado";
            return;
        }

        try
        {
            var publicKey = Config["NotificacionesPush:PublicKey"];

            if (string.IsNullOrEmpty(publicKey) == false)
            {
                var subscriptionJson = await JS.InvokeAsync<string>("registerServiceWorker", publicKey);

                if (string.IsNullOrEmpty(subscriptionJson))
                {
                    // errorMessage = "El usuario rechazó las notificaciones";
                    return;
                }

                if (subscriptionJson != null)
                {
                    var existingSubscription = Db.PushSubscriptions.FirstOrDefault(s => s.UserId == userId);

                    if (existingSubscription != null)
                    {
                        existingSubscription.SubscriptionJson = subscriptionJson;
                        existingSubscription.FechaCreacion = DateTime.UtcNow;
                        existingSubscription.Activa = true;
                        Db.PushSubscriptions.Update(existingSubscription);
                    }
                    else
                    {
                        // Crea una nueva
                        var subscription = new PushSubscription
                        {
                            UserId = userId,
                            SubscriptionJson = subscriptionJson,
                            FechaCreacion = DateTime.UtcNow,
                            Activa = true
                        };

                        Db.PushSubscriptions.Add(subscription);
                    }

                    await Db.SaveChangesAsync();
                    isSubscribed = true;
                }
            }  
        }
        catch (Exception ex)
        {
            BaseDatos.Errores.Insertar.Mensaje("Activar Notificaciones Push", ex, false);
        }
    }

    private async Task DesactivarNotificaciones()
    {
        if (string.IsNullOrEmpty(userId))
        {
            // errorMessage = "Usuario no autenticado";
            return;
        }

        try
        {
            var subscription = Db.PushSubscriptions.FirstOrDefault(s => s.UserId == userId && s.Activa);

            if (subscription != null)
            {
                Db.PushSubscriptions.Remove(subscription);
                await Db.SaveChangesAsync();
            }

            isSubscribed = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            BaseDatos.Errores.Insertar.Mensaje("Desactivar Notificaciones Push", ex, false);
        }
    
    }
}
