@page "/last-news"

@using Microsoft.AspNetCore.Components.Web
@using Microsoft.VisualBasic
@using pepeizqs_deals_blazor_web.Componentes.Interfaz

@inject IHttpContextAccessor Contexto

@{
	string keywords = "news";
	string jsonContenido = string.Empty;

	if (noticiasMostrar?.Count > 0)
	{
		int i = 0;
		foreach (var noticiaMostrar in noticiasMostrar)
		{
			if (i < 3)
			{
				string[] keywordsEnBruto = Herramientas.Buscador.LimpiarNombre(noticiaMostrar.TituloEn, false).Split(' ');
				List<string> keywordsLista = new List<string>();
				keywordsLista.AddRange(keywordsEnBruto);

				foreach (var keyword in keywordsLista)
				{
					if (keywords.Contains(keyword) == false && keyword.Length > 3)
					{
						keywords = keywords + ", " + keyword;
					}
				}
			}

			string jsonAñadir = @"{
				""@type"": ""ListItem"",
				""position"": @posicion,
				""name"": ""@titulo"",
				""item"": ""@enlace""
				}";

			jsonAñadir = jsonAñadir.Replace("@posicion", i.ToString());
			jsonAñadir = jsonAñadir.Replace("@titulo", noticiaMostrar.TituloEn);
			jsonAñadir = jsonAñadir.Replace("@enlace", "https://" + dominio + "/news/" + noticiaMostrar.Id.ToString() + "/" + Herramientas.EnlaceAdaptador.Nombre(noticiaMostrar.TituloEn + "/"));

			if (i < noticiasMostrar.Count - 1)
			{
				jsonAñadir = jsonAñadir + ",";
			}

			jsonContenido = jsonContenido + jsonAñadir;

			i += 1;
		}
	}

	<Titulo tipo="@Titulo.Tipo.UltimasNoticias" idioma="@idioma" dominio="@dominio" keywords="@keywords" contenidoJsonUltimasNoticias="@jsonContenido"/>
}

<style>
	.imagen-expandir {
		transition: transform .2s;
	}

		.imagen-expandir:hover {
			transform: scale(1.01);
		}
</style>

<style>
	:root {
		--glaseadoBorde: #FFFFFF1A;
		--glaseadoFondo: rgba(45, 47, 54, 0.70);
		--botonSeleccionado: rgba(13, 22, 33, 0.75);
	}

	.caja-noticias {
		box-shadow: 0 22px 34px 0 rgba(0, 0, 0, 0.25);
		background-blend-mode: overlay;
		border-radius: 100px;
		border: 2px solid var(--glaseadoBorde);
		width: fit-content;
		background-color: var(--fondoSubcabecera);
		backdrop-filter: blur(25px);
		display: flex;
		align-items: center;
		gap: 20px;
		padding: 5px;
	}

	.caja-noticias-animacion {
		opacity: 0;
		transition: all 0.5s ease, transform .2s ease;
		pointer-events: none;
		transform: scaleX(0);
		transform-origin: left;
		max-width: 0;
	}

		.caja-noticias-animacion.visible {
			opacity: 1;
			pointer-events: auto;
			transform: scaleX(1);
			max-width: fit-content;
		}

	.boton-noticias {
		transition: backdrop-filter 0.2s ease;
	}

		.boton-noticias:hover {
			backdrop-filter: brightness(50%);
		}
</style>

<style>
	.caja-noticia-contenido {
		background-color: var(--fondoSubsubcabecera);
		box-shadow: 0px 4px 8px 0px rgba(0, 0, 0, 0.28),0px 0px 2px 0px rgba(0, 0, 0, 0.24);
		border: 1px solid var(--glaseadoBorde);
		border-radius: 20px;
	}

	.caja-archivo-titulo {
		background: color-mix(in srgb, var(--fondoSubcabecera) 45%, var(--fondoBotonPequeño));
		padding: 20px 30px;
		border-top-left-radius: inherit;
		border-top-right-radius: inherit;
	}
</style>

@if (noticiasMostrar?.Count > 0)
{
	<div style="display: flex; align-items: center; justify-content: center; margin-top: 40px; transition: transform 0.3s ease, opacity 0.3s ease; flex-wrap: wrap;">
		<div class="caja-noticias">
			<button @onclick="@(e => CambiarTipo(e, Noticias.NoticiaTipo.Desconocido, false))" class="boton-noticias" style="@CambiarEstilo(Noticias.NoticiaTipo.Desconocido, false) border: 0px; height: 50px; padding: 15px 25px; display: inline-flex; align-items: center; color: var(--colorTexto); border-radius: inherit;">
				<div>
					<h1 style="font-size: 16px; margin: 0px;">
						@Herramientas.Idiomas.BuscarTexto(idioma, "Title", "LastNews")
					</h1>
				</div>
			</button>

			@if (mostrarArchivo == false && tiposActuales.Count > 0 && Herramientas.Bots.UserAgentEsBot(userAgent) == false)
			{
				foreach (var tipo in tiposActuales)
				{
					if (tipo != Noticias.NoticiaTipo.Desconocido)
					{
						<button @onclick="@(e => CambiarTipo(e, tipo, false))" class="boton-noticias" style="@CambiarEstilo(tipo, false) border: 0px; height: 50px; padding: 15px 25px; display: inline-flex; align-items: center; color: var(--colorTexto); border-radius: inherit;">
							@Noticias.NoticiasCargar.Traduccion(tipo, idioma)
						</button>
					}
				}
			}
		</div>

		<div class="tooltip-juego" onmousemove="enseñarTooltip(event, 'tooltip-news-archive')">
			<button @onclick="@(e => CambiarTipo(e, Noticias.NoticiaTipo.Desconocido, true))" style="@CambiarEstilo(Noticias.NoticiaTipo.Desconocido, true) border: 0px; @(mostrarArchivo ? "margin-left: 35px;" : "margin-left: 25px;") padding: 10px 15px; border-radius: 10px; display: flex; align-items: center; gap: 10px;">
				<div style="width: 24px; height: 24px;">
					<svg class="svg-boton" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
						<path d="M64 128C64 110.3 78.3 96 96 96L544 96C561.7 96 576 110.3 576 128L576 160C576 177.7 561.7 192 544 192L96 192C78.3 192 64 177.7 64 160L64 128zM96 240L544 240L544 480C544 515.3 515.3 544 480 544L160 544C124.7 544 96 515.3 96 480L96 240zM248 304C234.7 304 224 314.7 224 328C224 341.3 234.7 352 248 352L392 352C405.3 352 416 341.3 416 328C416 314.7 405.3 304 392 304L248 304z" />
					</svg>
				</div>

				@if (mostrarArchivo == true)
				{
					<div style="color: var(--colorTexto);">
						@Herramientas.Idiomas.BuscarTexto(idioma, "String1", "LastNews")
					</div>
				}
			</button>

			<div id="tooltip-news-archive" class="tooltip-relleno">
				<div style="margin: 8px; max-width: 300px; font-size: 14px;">
					@Herramientas.Idiomas.BuscarTexto(idioma, "String1", "LastNews")
				</div>
			</div>
		</div>
	</div>

	<div style="margin: 30px;">
		<RedesSociales idioma="@idioma" />
	</div>

	@if (mostrarArchivo == false)
	{
		<div class="cuerpo-ancho" style="display: flex; flex-direction: column; gap: 40px; margin-top: 40px; margin-bottom: 40px;">
			@foreach (var noticiaMostrar in noticiasMostrar)
			{
				<div class="caja-noticia-contenido" style="padding: 30px; display: flex; align-items: center; gap: 30px;">
					<div style="width: 50%;">
						<a href="/news/@noticiaMostrar.Id.ToString()/@Herramientas.EnlaceAdaptador.Nombre(Herramientas.Idiomas.ElegirTexto(idioma, noticiaMostrar.TituloEn, noticiaMostrar.TituloEs))/">
							<img src="@noticiaMostrar.Imagen" class="imagen-expandir" style="width: 100%; height: 100%; border: 1px solid var(--fondoBotonPequeño);" />
						</a>
					</div>

					<div style="width: 100%; display: flex; flex-direction: column; gap: 20px;">
						<div style="font-size: 20px;">
							@Herramientas.Idiomas.ElegirTexto(idioma, noticiaMostrar.TituloEn, noticiaMostrar.TituloEs)
						</div>

						<div style="font-size: 18px;">
							@noticiaMostrar.FechaEmpieza.Day.ToString()/@noticiaMostrar.FechaEmpieza.Month.ToString()/@noticiaMostrar.FechaEmpieza.Year.ToString()
						</div>

						<div>
							@{
								string texto = Herramientas.Idiomas.ElegirTexto(idioma, noticiaMostrar.ContenidoEn, noticiaMostrar.ContenidoEs);

								if (string.IsNullOrEmpty(texto) == false)
								{
									if (texto.Contains("</div>") == true)
									{
										int int1 = texto.IndexOf("</div>");
										texto = texto.Remove(int1, texto.Length - int1);

										if (texto.Contains("<div") == true)
										{
											int int2 = texto.IndexOf(">");
											texto = texto.Remove(0, int2 + 1);
										}
									}
									else
									{
										if (texto.Contains("<") == true)
										{
											int int1 = texto.IndexOf("<");
											texto = texto.Remove(int1, texto.Length - int1);
										}
									}
								}

								<div>
									@((MarkupString)texto)
								</div>

								if (noticiaMostrar.NoticiaTipo == Noticias.NoticiaTipo.Bundles)
								{
									<a href="/news/@noticiaMostrar.Id.ToString()/@Herramientas.EnlaceAdaptador.Nombre(Herramientas.Idiomas.ElegirTexto(idioma, noticiaMostrar.TituloEn, noticiaMostrar.TituloEs))/" class="boton-pequeño" style="width: auto; margin-top: 20px; padding: 10px 15px;">
										@Herramientas.Idiomas.BuscarTexto(idioma, "String2", "LastNews")
									</a>
								}
								else
								{
									<a href="/news/@noticiaMostrar.Id.ToString()/@Herramientas.EnlaceAdaptador.Nombre(Herramientas.Idiomas.ElegirTexto(idioma, noticiaMostrar.TituloEn, noticiaMostrar.TituloEs))/" class="boton-pequeño" style="width: auto; margin-top: 20px; padding: 10px 15px;">
										@Herramientas.Idiomas.BuscarTexto(idioma, "String3", "LastNews")
									</a>
								}
							}
						</div>
					</div>
				</div>
			}
		</div>
	}
	else
	{
		<div class="caja-noticia-contenido cuerpo-ancho" style="margin-top: 40px; margin-bottom: 40px; padding: 20px;">
			<div style="display: flex; align-items: start; gap: 15px;">
				@foreach (var año in años)
				{
					<div>
						<button @onclick="@(e => CambiarAño(e, año))" class="boton-pequeño" style="padding: 6px 10px; width: auto;">
							@año
						</button>

						@if (añoSeleccionado == año)
						{
							<div style="background: var(--colorTexto); padding: 2px;" />
						}
					</div>
				}
			</div>
		</div>
		
		@if (noticiasAntiguas?.Count > 0)
		{
			List<Noticias.Noticia> noticiasAño = new List<Noticias.Noticia>();

			foreach (var noticiaAntigua in noticiasAntiguas)
			{
				if (noticiaAntigua.FechaEmpieza.Year.ToString() == añoSeleccionado)
				{
					noticiasAño.Add(noticiaAntigua);
				}
			}

			if (noticiasAño.Count > 0)
			{
				<div style="display: flex; flex-direction: column; gap: 30px; margin-bottom: 40px;">
					@{
						int i = 1;
						while (i < 13)
						{
							List<Noticias.Noticia> noticiasMensual = new List<Noticias.Noticia>();

							foreach (var noticia in noticiasAño)
							{
								if (noticia.FechaEmpieza.Month == i)
								{
									noticiasMensual.Add(noticia);
								}
							}

							if (noticiasMensual.Count > 0)
							{
								noticiasMensual.Reverse();

								<div class="caja-noticia-contenido cuerpo-ancho" style="width: 100%;">
									<div class="caja-archivo-titulo">
										@Herramientas.Idiomas.BuscarTexto(idioma, "Month." + i.ToString(), "Months")
									</div>

									<ul>
										@foreach (var noticiaMensual in noticiasMensual)
										{
											<li>
												<a href="/news/@noticiaMensual.Id.ToString()/@Herramientas.EnlaceAdaptador.Nombre(Herramientas.Idiomas.ElegirTexto(idioma, noticiaMensual.TituloEn, noticiaMensual.TituloEs))/" style="text-decoration: none;">@Herramientas.Idiomas.ElegirTexto(idioma, noticiaMensual.TituloEn, noticiaMensual.TituloEs)</a> (@noticiaMensual.FechaEmpieza.Day/@noticiaMensual.FechaEmpieza.Month/@noticiaMensual.FechaEmpieza.Year)
											</li>
										}
									</ul>
								</div>
							}

							i += 1;
						}
					}
				</div>
			}
		}
	}
}

@code {

	#nullable disable

	private string idioma = "en";
	private string usuarioId = null;
	private string userAgent = null;
	private string dominio = null;

	private List<string> fechas = new List<string>();
	[PersistentState] public List<Noticias.Noticia> noticiasMostrar { get; set; }
	[PersistentState] public List<Noticias.Noticia> noticiasAntiguas { get; set; }

	private List<string> años = new List<string>();
	private string añoSeleccionado = null;

	protected override async Task OnInitializedAsync()
	{
		Herramientas.ContextoUsuarioDatos datos = Herramientas.ContextoUsuario.Leer(Contexto);
		idioma = datos.Idioma;
		usuarioId = datos.UsuarioId;
		userAgent = datos.UserAgent;
        dominio = datos.Dominio;

		if (string.IsNullOrEmpty(usuarioId) == false)
		{
			idioma = await BaseDatos.Usuarios.Buscar.IdiomaSobreescribir(usuarioId);
		}

		//--------------------------------------------------------------------

		noticiasMostrar ??= await BaseDatos.Noticias.Buscar.Actuales(tipoSeleccionado);

		if (noticiasMostrar?.Count > 0)
		{
			foreach (var noticia in noticiasMostrar)
			{
				bool añadirTipo = true;

				if (tiposActuales.Count > 0)
				{
					foreach (var tipoActual in tiposActuales)
					{
						if (tipoActual == noticia.NoticiaTipo)
						{
							añadirTipo = false;
						}
					}
				}

				if (añadirTipo == true)
				{
					tiposActuales.Add(noticia.NoticiaTipo);
				}
			}
		}

		//--------------------------------------------------------------------

		DateTime arranque = new DateTime(2023, 9, 1);

		int i = 0;
		while (i < 100)
		{
			if (arranque.Year != DateTime.Now.Year)
			{
				años.Add(arranque.Year.ToString());
				arranque = arranque.AddYears(1);
			}
			i += 1;
		}

		años.Add(DateTime.Now.Year.ToString());
		años.Reverse();
	}

	private Noticias.NoticiaTipo tipoSeleccionado = Noticias.NoticiaTipo.Desconocido;
	private List<Noticias.NoticiaTipo> tiposActuales = new List<Noticias.NoticiaTipo>();
	private bool mostrarArchivo = false;

	private async Task CambiarTipo(MouseEventArgs e, Noticias.NoticiaTipo nuevoTipo, bool esArchivo)
	{
		mostrarArchivo = esArchivo;

		if (esArchivo == false)
		{
			tipoSeleccionado = nuevoTipo;
			noticiasMostrar = await BaseDatos.Noticias.Buscar.Actuales(tipoSeleccionado);
		}
		else
		{
			añoSeleccionado = DateTime.Now.Year.ToString();
			noticiasAntiguas = await BaseDatos.Noticias.Buscar.Año(añoSeleccionado);
		}
	}

	private string CambiarEstilo(Noticias.NoticiaTipo nuevoTipo, bool esArchivo)
	{
		if (mostrarArchivo == true && esArchivo == true)
		{
			if (nuevoTipo != Noticias.NoticiaTipo.Desconocido)
			{
				return "background-color: transparent;";
			}
			else
			{
				return "background-color: var(--botonSeleccionado);";
			}
		}
		else
		{
			if (tipoSeleccionado == nuevoTipo && mostrarArchivo == false && esArchivo == false)
			{
				return "background-color: var(--botonSeleccionado);";
			}
			else
			{
				return "background-color: transparent;";
			}
		}
	}

	private async Task CambiarAño(MouseEventArgs e, string nuevoAño)
	{
		añoSeleccionado = nuevoAño;

		noticiasAntiguas = await BaseDatos.Noticias.Buscar.Año(añoSeleccionado);
	}
}
