@page "/subscriptions/"
@page "/subscriptions/{suscripcionSeleccionadaTexto}/"

@using APIs.Steam
@using Juegos
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Microsoft.AspNetCore.Identity
@using Microsoft.VisualBasic
@using pepeizqs_deals_blazor_web.Componentes.Interfaz
@using pepeizqs_deals_web.Data
@using System.Text.Json

@inject IHttpContextAccessor Contexto
@inject IJSRuntime JavaScript

@if (mostrarArchivo == false && mostrarUltimas == false)
{
    if (suscripcionSeleccionada != Suscripciones2.SuscripcionTipo.Desconocido)
    {
        <Titulo tipo="@Titulo.Tipo.Suscripciones" idioma="@idioma" dominio="@dominio" tituloSuscripciones="@Suscripciones2.SuscripcionesCargar.DevolverSuscripcion(suscripcionSeleccionada).Nombre" enlaceSuscripciones="@Herramientas.EnlaceAdaptador.Nombre(suscripcionSeleccionada.ToString().ToLower())" />
    }
    else
    {
        <Titulo tipo="@Titulo.Tipo.Suscripciones" idioma="@idioma" dominio="@dominio" />
    }
}
else
{
    if (mostrarArchivo == true)
    {
        <Titulo tipo="@Titulo.Tipo.Suscripciones" idioma="@idioma" dominio="@dominio" tituloSuscripciones="@(Herramientas.Idiomas.BuscarTexto(idioma, "String1", "Subscriptions") + " (" + Herramientas.Idiomas.BuscarTexto(idioma, "Title", "Subscriptions") + ")")" enlaceSuscripciones="archive" />
    }

    if (mostrarUltimas == true)
    {
        <Titulo tipo="@Titulo.Tipo.Suscripciones" idioma="@idioma" dominio="@dominio" tituloSuscripciones="@(Herramientas.Idiomas.BuscarTexto(idioma, "String11", "Subscriptions") + " (" + Herramientas.Idiomas.BuscarTexto(idioma, "Title", "Subscriptions") + ")")" enlaceSuscripciones="last-added" />
    }
}

<script>
    function enseñarTooltip(e, id) {
        var x = e.clientX,
            y = e.clientY;

        var tooltip = document.getElementById(id);

        if (screen.width / 2 > x) {
            tooltip.style.top = (y + 10) + 'px';
            tooltip.style.left = (x + 20) + 'px';
        }
        else {
            tooltip.style.top = (y - 10) + 'px';
            tooltip.style.left = (x - 20 - tooltip.getBoundingClientRect().width) + 'px';
        };
    }
</script>

<script>
    function moverScroll(id) {
        const yOffset = -90;
        const element = document.getElementById(id);
        const y = element.getBoundingClientRect().top + window.pageYOffset + yOffset;

        window.scrollTo({ top: y, behavior: 'smooth' });
    }
</script>

<script>
    window.ChangeUrl = function (url) {
        history.pushState(null, '', url);
    }
</script>

<style>
    .suscripciones-grid {
        gap: 30px;
    }

    .suscripcion-grid {
        padding: 30px;
        gap: 30px;
    }

    @@media (max-width: 800px) {
        .suscripciones-grid {
            gap: 15px;
        }

        .suscripcion-grid {
            padding: 15px;
            gap: 15px;
        }
    }
</style>

<style>
    :root {
        --glaseadoBorde: #FFFFFF1A;
        --glaseadoFondo: rgba(45, 47, 54, 0.70);
        --noResultados: rgba(132, 32, 41, 0.5);
        --botonSeleccionado: rgba(13, 22, 33, 0.75);
    }

    .caja-suscripciones {
        box-shadow: 0 22px 34px 0 rgba(0, 0, 0, 0.25);
        background-blend-mode: overlay;
        border-radius: 100px;
        border: 2px solid var(--glaseadoBorde);
        width: fit-content;
        background-color: @colorSuscripcion;
        backdrop-filter: blur(25px);
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 5px;
        flex-wrap: wrap;
    }

    .caja-suscripciones-animacion {
        opacity: 0;
        transition: all 0.5s ease, transform .2s ease;
        pointer-events: none;
        transform: scaleX(0);
        transform-origin: left;
        max-width: 0;
    }

        .caja-suscripciones-animacion.visible {
            opacity: 1;
            pointer-events: auto;
            transform: scaleX(1);
            max-width: fit-content;
        }

    .boton-suscripciones {
        backdrop-filter: brightness(100%);
        transition: backdrop-filter 0.2s ease;
    }

        .boton-suscripciones:hover {
            backdrop-filter: brightness(50%);
        }
</style>

<style>
    .caja-archivo-contenido {
        background-color: var(--fondoSubsubcabecera);
        box-shadow: 0px 4px 8px 0px rgba(0, 0, 0, 0.28),0px 0px 2px 0px rgba(0, 0, 0, 0.24);
        border: 1px solid var(--glaseadoBorde);
        border-radius: 20px;
    }

    .caja-archivo-titulo {
        background: color-mix(in srgb, var(--fondoSubcabecera) 45%, var(--fondoBotonPequeño));
        padding: 20px 30px;
        border-top-left-radius: inherit;
        border-top-right-radius: inherit;
    }
</style>

<div>
	<img class="juego-fondo" src="@imagenFondo" alt="Background Subscriptions" fetchpriority="high" />

    <div>
        <div style="display: flex; align-items: center; justify-content: center; margin-top: 40px; transition: transform 0.3s ease, opacity 0.3s ease; flex-wrap: wrap;">
            <div class="caja-suscripciones">
                <button @onclick="@(e => SuscripcionAbrir(e, Suscripciones2.SuscripcionTipo.Desconocido))" class="boton-suscripciones" style="@CambiarEstilo(Suscripciones2.SuscripcionTipo.Desconocido) border: 0px; height: 50px; padding: 15px 25px; display: inline-flex; align-items: center; color: var(--colorTexto); border-radius: inherit;">
                    <div>
                        <h1 style="font-size: 16px; margin: 0px;">
                            @Herramientas.Idiomas.BuscarTexto(idioma, "Title", "Subscriptions")
                        </h1>
                    </div>
                </button>

                @if (mostrarArchivo == false && mostrarUltimas == false && Herramientas.Bots.UserAgentEsBot(userAgent) == false)
                {
                    foreach (var suscripcion in Suscripciones2.SuscripcionesCargar.GenerarListado())
                    {
                        if (suscripcionSeleccionada == Suscripciones2.SuscripcionTipo.Desconocido)
                        {
                            bool esHija = false;

                            foreach (var suscripcionHija in Suscripciones2.SuscripcionesCargar.GenerarListado())
                            {
                                if (suscripcionHija.SuscripcionesRelacionadas?.Count > 0)
                                {
                                    foreach (var suscripcionHija2 in suscripcionHija.SuscripcionesRelacionadas)
                                    {
                                        if (suscripcionHija2 == suscripcion.Id)
                                        {
                                            esHija = true;
                                        }
                                    }
                                }
                            }

                            if (suscripcion.UsuarioPuedeAbrir == true && suscripcion.Id != Suscripciones2.SuscripcionTipo.Desconocido && esHija == false)
                            {
                                <button @onclick="@(e => SuscripcionAbrir(e, suscripcion.Id))" class="boton-suscripciones" style="@CambiarEstilo(suscripcion.Id) border: 0px; height: 50px; padding: 15px 25px; display: inline-flex; align-items: center; color: var(--colorTexto); border-radius: inherit;">
                                    <img src="@suscripcion.ImagenIcono" style="width: 20px; height: 20px;" alt="@suscripcion.Nombre" />
                                </button>
                            }
                        }
                        else
                        {
                            if (suscripcionSeleccionada == suscripcion.Id)
                            {
                                <button @onclick="@(e => SuscripcionAbrir(e, suscripcion.Id))" class="boton-suscripciones" style="@CambiarEstilo(suscripcion.Id) border: 0px; height: 50px; padding: 15px 25px; display: inline-flex; align-items: center; gap: 10px; color: var(--colorTexto); border-radius: inherit;">
                                    <img src="@suscripcion.ImagenIcono" style="width: 20px; height: 20px;" alt="@suscripcion.Nombre" />

                                    <div>
                                        @suscripcion.Nombre
                                    </div>
                                </button>
                            }
                        }
                    }
                }
            </div>

            @if (suscripcionSeleccionada == Suscripciones2.SuscripcionTipo.Desconocido)
            {
                if (mostrarArchivo == false)
                {
                    <button class="boton-pequeño" style="@(mostrarUltimas ? "background-color: var(--botonSeleccionado)" : "background-color: transparent"); width: fit-content; margin-left: 30px; padding: 10px 15px; border-radius: 10px; box-shadow: none;" @onclick="@(e => CargarUltimas(e))">
                        <div style="font-size: 16px;">
                            @Herramientas.Idiomas.BuscarTexto(idioma, "String11", "Subscriptions")
                        </div>
                    </button>
                }

                if (mostrarUltimas == false)
                {
                    <div class="tooltip-juego" onmousemove="enseñarTooltip(event, 'tooltip-subscriptions-archive')">
                        <button @onclick="@(e => CargarArchivo(e))" style="border: 0px; @(mostrarArchivo ? "background-color: var(--botonSeleccionado); margin-left: 30px" : "background-color: transparent; margin-left: 20px"); padding: 10px 15px; border-radius: 10px; display: flex; align-items: center; gap: 10px;">
                            <div style="width: 24px; height: 24px;">
                                <svg class="svg-boton" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                                    <path d="M64 128C64 110.3 78.3 96 96 96L544 96C561.7 96 576 110.3 576 128L576 160C576 177.7 561.7 192 544 192L96 192C78.3 192 64 177.7 64 160L64 128zM96 240L544 240L544 480C544 515.3 515.3 544 480 544L160 544C124.7 544 96 515.3 96 480L96 240zM248 304C234.7 304 224 314.7 224 328C224 341.3 234.7 352 248 352L392 352C405.3 352 416 341.3 416 328C416 314.7 405.3 304 392 304L248 304z" />
                                </svg>
                            </div>

                            @if (mostrarArchivo == true)
                            {
                                <div style="color: var(--colorTexto);">
                                    @Herramientas.Idiomas.BuscarTexto(idioma, "String1", "Subscriptions")
                                </div>
                            }
                        </button>

                        <div id="tooltip-subscriptions-archive" class="tooltip-relleno">
                            <div style="margin: 8px; max-width: 300px; font-size: 14px;">
                                @Herramientas.Idiomas.BuscarTexto(idioma, "String1", "Subscriptions")
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                if (suscripcionSeleccionada2.Precio > 0)
                {
                    <div style="font-size: 15px; padding: 8px 30px;">
                        @string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String8", "Subscriptions"), Herramientas.Precios.Euro((decimal)suscripcionSeleccionada2.Precio))
                    </div>
                }

                <div class="tooltip-juego" onmousemove="enseñarTooltip(event, 'tooltip-bundles-order')">
                    <button @onclick="MostrarOcultarOrdenar" style="background: transparent; border: 0px;">
                        <div style="width: 24px; height: 24px;">
                            <svg class="svg-boton" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                                <path d="M130.4 268.2C135.4 280.2 147 288 160 288L480 288C492.9 288 504.6 280.2 509.6 268.2C514.6 256.2 511.8 242.5 502.7 233.3L342.7 73.3C330.2 60.8 309.9 60.8 297.4 73.3L137.4 233.3C128.2 242.5 125.5 256.2 130.5 268.2zM130.4 371.7C125.4 383.7 128.2 397.4 137.3 406.6L297.3 566.6C309.8 579.1 330.1 579.1 342.6 566.6L502.6 406.6C511.8 397.4 514.5 383.7 509.5 371.7C504.5 359.7 492.9 352 480 352L160 352C147.1 352 135.4 359.8 130.4 371.8z" />
                            </svg>
                        </div>
                    </button>

                    <div id="tooltip-bundles-order" class="tooltip-relleno">
                        <div style="margin: 8px; max-width: 300px; font-size: 14px;">
                            @Herramientas.Idiomas.BuscarTexto(idioma, "String15", "Subscriptions")
                        </div>
                    </div>
                </div>

                <div style="display: flex; align-items: center; gap: 25px; max-width: 500px; height: 45px; margin-left: 20px; @anchoBuscador">
                    <div class="tooltip-juego" onmousemove="enseñarTooltip(event, 'tooltip-subscriptions-search')">
                        <button @onclick="MostrarOcultarBuscador" style="background: transparent; border: 0px;">
                            <div style="width: 24px; height: 24px;">
                                <svg class="svg-boton" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                                    <path d="M480 272C480 317.9 465.1 360.3 440 394.7L566.6 521.4C579.1 533.9 579.1 554.2 566.6 566.7C554.1 579.2 533.8 579.2 521.3 566.7L394.7 440C360.3 465.1 317.9 480 272 480C157.1 480 64 386.9 64 272C64 157.1 157.1 64 272 64C386.9 64 480 157.1 480 272zM272 416C351.5 416 416 351.5 416 272C416 192.5 351.5 128 272 128C192.5 128 128 192.5 128 272C128 351.5 192.5 416 272 416z" />
                                </svg>
                            </div>
                        </button>

                        <div id="tooltip-subscriptions-search" class="tooltip-relleno">
                            <div style="margin: 8px; max-width: 300px; font-size: 14px;">
                                @Herramientas.Idiomas.BuscarTexto(idioma, "String13", "Subscriptions")
                            </div>
                        </div>
                    </div>

                    <div class="caja-suscripciones caja-suscripciones-animacion @(mostrarBuscador ? "visible" : "")">
                        <input type="text" @bind-value="textoBuscador" @bind-value:event="oninput" @bind-value:after="TextoCambiaBuscador" @onclick="ClickBuscador" @onfocusout="PerderBuscador" class="entrada-texto" style="border-radius: inherit; color: var(--colorTexto); padding: 5px 15px; border: 0px; transition: background-color 1000ms linear; @fondoBuscador" placeholder="@Herramientas.Idiomas.BuscarTexto(idioma, "String13", "Subscriptions")" />
                    </div>
                </div>
            }
        </div>

        @if (suscripcionSeleccionada != Suscripciones2.SuscripcionTipo.Desconocido)
        {
            var grupos = Suscripciones2.SuscripcionesCargar.GenerarListado()
                .Where(s =>
                s.Id == suscripcionSeleccionada ||
                s.SuscripcionesRelacionadas?.Contains(suscripcionSeleccionada) == true ||
                (suscripcionSeleccionada2.SuscripcionesRelacionadas?.Contains(s.Id) == true)
                ).ToList();

            suscripcionesRelacionadas = grupos
                .SelectMany(s => new[] { s.Id }
                .Concat(s.SuscripcionesRelacionadas ?? Enumerable.Empty<Suscripciones2.SuscripcionTipo>()))
                .Where(id => id != suscripcionSeleccionada)
                .Distinct()
                .Select(id => Suscripciones2.SuscripcionesCargar.DevolverSuscripcion(id))
                .ToList();

            if (suscripcionesRelacionadas?.Count > 0)
            {
                <div style="margin-top: 30px; display: flex; align-items: center; justify-content: center;">
                    <div style="font-size: 14px;">
                        <label style="margin-right: 5px;">@Herramientas.Idiomas.BuscarTexto(idioma, "String19", "Subscriptions")</label>

                        @{
                            int i = 0;

                            foreach (var relacionada in suscripcionesRelacionadas)
                            {
                                if (i > 0 && suscripcionesRelacionadas.Count > 1)
                                {
                                    if (i == suscripcionesRelacionadas.Count - 1)
                                    {
                                        @(" " + Herramientas.Idiomas.BuscarTexto(idioma, "String20", "Subscriptions") + " ")
                                    }
                                    else
                                    {
                                        @(" ,")
                                    }
                                }

                                <a href="/subscriptions/@Herramientas.EnlaceAdaptador.Nombre(relacionada.Id.ToString().ToLower())/" @onclick="@(e => SuscripcionAbrir(e, relacionada.Id))">@relacionada.Nombre</a>

                                i += 1;
                            }
                        }
                    </div>
                </div>
            }
        }

        @if (mostrarArchivo == false)
        {
            if (mostrarUltimas == false)
            {
                if (suscripcionSeleccionada == Suscripciones2.SuscripcionTipo.Desconocido)
                {
                    <div class="cuerpo-ancho caja-archivo-contenido" style="margin-top: 40px; margin-bottom: 40px; display: flex; flex-direction: column;">
                        <div class="caja-archivo-titulo" style="display: flex; align-items: center; padding: 30px; gap: 30px;">
                            <div style="min-width: 30px; height: 30px;">
                                <svg class="svg-boton" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                                    <path d="M528 320C528 205.1 434.9 112 320 112C205.1 112 112 205.1 112 320C112 434.9 205.1 528 320 528C434.9 528 528 434.9 528 320zM64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576C178.6 576 64 461.4 64 320zM320 240C302.3 240 288 254.3 288 272C288 285.3 277.3 296 264 296C250.7 296 240 285.3 240 272C240 227.8 275.8 192 320 192C364.2 192 400 227.8 400 272C400 319.2 364 339.2 344 346.5L344 350.3C344 363.6 333.3 374.3 320 374.3C306.7 374.3 296 363.6 296 350.3L296 342.2C296 321.7 310.8 307 326.1 302C332.5 299.9 339.3 296.5 344.3 291.7C348.6 287.5 352 281.7 352 272.1C352 254.4 337.7 240.1 320 240.1zM288 432C288 414.3 302.3 400 320 400C337.7 400 352 414.3 352 432C352 449.7 337.7 464 320 464C302.3 464 288 449.7 288 432z" />
                                </svg>
                            </div>

                            <div>
                                @Herramientas.Idiomas.BuscarTexto(idioma, "String7", "Subscriptions")
                            </div>
                        </div>

                        <div class="suscripciones-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; padding: 30px;">
                            @foreach (var suscripcion in Suscripciones2.SuscripcionesCargar.GenerarListado())
                            {
                                if (suscripcion.UsuarioPuedeAbrir == true && suscripcion.Id != Suscripciones2.SuscripcionTipo.Desconocido)
                                {
                                    <button @onclick="@(e => SuscripcionAbrir(e, suscripcion.Id))" class="boton-pequeño suscripcion-grid" style="display: flex; align-items: center; gap: 20px; justify-content: space-evenly;">
                                        <div style="width: 200px; height: 70px; display: flex; justify-content: center;">
                                            <img src="@Herramientas.Ficheros.Imagenes.ServidorExterno(suscripcion.ImagenLogo, 200, 70)" alt="@suscripcion.Nombre" style="max-width: 100%; max-height: 100%; object-fit: contain;" />
                                        </div>

                                        @if (suscripcion.Precio > 0)
                                        {
                                            <div style="font-size: 18px;">
                                                @Herramientas.Precios.Euro((decimal)suscripcion.Precio)
                                            </div>
                                        }
                                    </button>
                                }
                            }
                        </div>
                    </div>
                }
                else
                {
                    var elegido = Suscripciones2.SuscripcionesCargar.DevolverSuscripcion(suscripcionSeleccionada);

                    <div class="cuerpo-ancho" style="display: flex; flex-direction: column;">
                        @if (elegido.UsuarioEnlacesEspecificos == false)
                        {
                            <div style="position: sticky; top: var(--alturaCabecera); z-index: 1000; @(suscripcionesRelacionadas?.Count > 0 ? "margin-top: 30px;" : "margin-top: 40px;")">
                                <a href="@Herramientas.EnlaceAcortador.Generar(elegido.Enlace, elegido.Id, usuarioPatreon, false)" class="boton-pequeño" style="text-align: center; padding: 15px 20px; font-size: 20px; border: 1px solid rgba(0,255,255,0.15);" target="_blank">
                                    @Herramientas.Idiomas.BuscarTexto(idioma, "String5", "Subscriptions")
                                </a>
                            </div>
                        }

                        <div class="caja-archivo-contenido" style="@(suscripcionesRelacionadas?.Count > 0 ? "margin: 30px 0px 40px 0px;" : "margin: 40px 0px;")">
                            @if (elegido.SoloStreaming == true)
                            {
                                <div class="caja-archivo-titulo" style="padding: 30px; display: flex; align-items: center; gap: 30px;">
                                    <div style="width: 30px; height: 30px;">
                                        <svg class="svg-boton" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                                            <path d="M528 320C528 205.1 434.9 112 320 112C205.1 112 112 205.1 112 320C112 434.9 205.1 528 320 528C434.9 528 528 434.9 528 320zM64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576C178.6 576 64 461.4 64 320zM320 240C302.3 240 288 254.3 288 272C288 285.3 277.3 296 264 296C250.7 296 240 285.3 240 272C240 227.8 275.8 192 320 192C364.2 192 400 227.8 400 272C400 319.2 364 339.2 344 346.5L344 350.3C344 363.6 333.3 374.3 320 374.3C306.7 374.3 296 363.6 296 350.3L296 342.2C296 321.7 310.8 307 326.1 302C332.5 299.9 339.3 296.5 344.3 291.7C348.6 287.5 352 281.7 352 272.1C352 254.4 337.7 240.1 320 240.1zM288 432C288 414.3 302.3 400 320 400C337.7 400 352 414.3 352 432C352 449.7 337.7 464 320 464C302.3 464 288 449.7 288 432z" />
                                        </svg>
                                    </div>

                                    <div>
                                        @Herramientas.Idiomas.BuscarTexto(idioma, "String14", "Subscriptions")
                                    </div>
                                </div>
                            }

                            @if (juegosActuales?.Count > 0)
                            {
                                <div style="padding: 30px; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 30px;">
                                    @foreach (var juego in juegosActuales)
                                    {
                                        string enlaceSuscripcion = Herramientas.EnlaceAcortador.Generar(juego.Enlace, juego.Tipo, usuarioPatreon, false);

                                        if (elegido.UsuarioEnlacesEspecificos == false)
                                        {
                                            enlaceSuscripcion = Herramientas.EnlaceAcortador.Generar(elegido.Enlace, elegido.Id, usuarioPatreon, false);
                                        }

                                        <CajaJuego idSuscripcion="@juego.Id" tipoSuscripcion="@elegido.Id" enlaceSuscripcion="@enlaceSuscripcion" drmSuscripcion="@juego.DRM" idioma="@idioma" juego="@juego.Juego" juegosUsuario="@juegosUsuario" usuarioDeseadosSteam="@deseadosUsuario?.SteamWishlist" usuarioDeseadosWeb="@deseadosUsuario?.Wishlist" usuarioDeseadosGog="@deseadosUsuario?.GogWishlist" tipo="CajaJuego.Tipo.Suscripciones" userAgent="@userAgent" />
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="cuerpo-ancho" style="margin-top: 40px; margin-bottom: 40px; display: flex; flex-direction: column; gap: 30px;">
                    @if (suscripcionesUltimas?.Count > 0)
                    {
                        var gruposPorDia = suscripcionesUltimas.GroupBy(x => x.FechaEmpieza.Date).OrderByDescending(g => g.Key).Select(g => new
                        {
                            Fecha = g.Key,
                            GruposPorElegido = g.Select(j => new
                            {
                                Juego = j,
                                Elegido = Suscripciones2.SuscripcionesCargar.DevolverSuscripcion(j.Tipo)
                            })
                        .OrderBy(x => x.Elegido.Nombre)
                        .GroupBy(x => x.Elegido.Id)
                        .Select(eg => new
                        {
                            Elegido = eg.First().Elegido,
                            Juegos = eg
                        .Select(x => x.Juego)
                        .OrderBy(x => x.Juego.Nombre)
                        .ToList()
                        }).ToList()
                        }).ToList();

                        foreach (var grupo in gruposPorDia)
                        {
                            DateTime dia = grupo.Fecha;

                            <div class="caja-archivo-contenido">
                                <div class="caja-archivo-titulo" style="display: flex; align-items: center; gap: 5px;">
                                    <div style="font-size: 18px;">
                                        @dia.Day.ToString()/@dia.Month.ToString()/@dia.Year.ToString()
                                    </div>

                                    <div>
                                        - @Herramientas.Calculadora.DiferenciaTiempo(dia, idioma)
                                    </div>
                                </div>

                                <div style="padding: 30px; display: flex; flex-direction: column; gap: 40px;">
                                    @foreach (var grupoElegido in grupo.GruposPorElegido)
                                    {
                                        <div>
                                            <div style="display: flex; align-items: center; gap: 15px;">
                                                <div>
                                                    <img src="@grupoElegido.Elegido.ImagenIcono" style="width: 24px; height: 24px;" />
                                                </div>

                                                <div>
                                                    @grupoElegido.Elegido.Nombre
                                                </div>
                                            </div>

                                            <hr />

                                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 30px;">
                                                @foreach (var juego in grupoElegido.Juegos)
                                                {
                                                    var elegido = Suscripciones2.SuscripcionesCargar.DevolverSuscripcion(juego.Tipo);
                                                    string enlaceSuscripcion = Herramientas.EnlaceAcortador.Generar(juego.Enlace, juego.Tipo, usuarioPatreon, false);

                                                    if (elegido.UsuarioEnlacesEspecificos == false)
                                                    {
                                                        enlaceSuscripcion = Herramientas.EnlaceAcortador.Generar(elegido.Enlace, elegido.Id, usuarioPatreon, false);
                                                    }

                                                    <CajaJuego idSuscripcion="@juego.Id" tipoSuscripcion="@elegido.Id" enlaceSuscripcion="@enlaceSuscripcion" drmSuscripcion="@juego.DRM" idioma="@idioma" juego="@juego.Juego" juegosUsuario="@juegosUsuario" usuarioDeseadosSteam="@deseadosUsuario?.SteamWishlist" usuarioDeseadosWeb="@deseadosUsuario?.Wishlist" usuarioDeseadosGog="@deseadosUsuario?.GogWishlist" tipo="CajaJuego.Tipo.Suscripciones" userAgent="@userAgent" />
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        @Herramientas.Idiomas.BuscarTexto(idioma, "String12", "Subscriptions")
                    }
                </div>
            }
        }
        else
        {
            <div class="caja-archivo-contenido cuerpo-ancho" style="margin-top: 40px; margin-bottom: 40px; padding: 20px;">
                <div style="display: flex; align-items: start; gap: 15px; flex-wrap: wrap;">
                    @foreach (var año in años)
                    {
                        <div>
                            <button @onclick="@(e => CambiarAño(e, año))" class="boton-pequeño" style="padding: 6px 10px; width: fit-content;">
                                @año
                            </button>

                            @if (añoSeleccionado == año)
                            {
                                <div style="background: var(--colorTexto); padding: 2px;" />
                            }
                        </div>
                    }
                </div>

                @if (string.IsNullOrEmpty(añoSeleccionado) == false)
                {
                    <hr />

                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <div style="padding: 6px 10px;">
                            @añoSeleccionado:
                        </div>

                        @foreach (var suscripcionPasada in suscripcionesPasadas)
                        {
                            List<Juegos.JuegoSuscripcion> suscripcionAño = new List<Juegos.JuegoSuscripcion>();

                            foreach (var juego in suscripcionPasada.Juegos)
                            {
                                if (juego.FechaEmpieza.Year.ToString() == añoSeleccionado)
                                {
                                    suscripcionAño.Add(juego);
                                }
                            }

                            if (suscripcionAño.Count > 0)
                            {
                                <div>
                                    <a onclick="moverScroll('pasado-@suscripcionPasada.Tipo.Id.ToString()')" class="boton-pequeño" style="color: var(--colorTexto); text-decoration: none; cursor: pointer; padding: 6px 10px;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <img src="@suscripcionPasada.Tipo.ImagenIcono" style="width: 22px; height: 22px;" alt="@suscripcionPasada.Tipo.Nombre" />

                                            <div style="font-size: 14px;">
                                                @suscripcionAño.Count.ToString()
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            }
                        }
                    </div>
                }
            </div>

            @if (string.IsNullOrEmpty(añoSeleccionado) == false)
            {
                <div class="cuerpo-ancho" style="display: flex; flex-direction: column; gap: 40px; margin-top: 40px; margin-bottom: 40px;">
                    @foreach (var suscripcionPasada in suscripcionesPasadas)
                    {
                        List<Juegos.JuegoSuscripcion> suscripcionesAño = new List<Juegos.JuegoSuscripcion>();

                        foreach (var juego in suscripcionPasada.Juegos)
                        {
                            if (juego.FechaEmpieza.Year.ToString() == añoSeleccionado)
                            {
                                suscripcionesAño.Add(juego);
                            }
                        }

                        if (suscripcionesAño.Count > 0)
                        {
                            <div class="caja-archivo-contenido">
                                <div id="pasado-@suscripcionPasada.Tipo.Id.ToString()" class="caja-archivo-titulo">
                                    <img src="@suscripcionPasada.Tipo.ImagenLogo" alt="@suscripcionPasada.Tipo.Nombre" style="max-width: 150px; max-height: 70px; object-fit: contain;" />
                                </div>

                                <div style="padding: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; justify-content: flex-start;">
                                    @{
                                        int i = 1;
                                        while (i < 13)
                                        {
                                            List<Juegos.JuegoSuscripcion> suscripcionesMensual = new List<Juegos.JuegoSuscripcion>();

                                            foreach (var juego in suscripcionesAño)
                                            {
                                                if (juego.FechaEmpieza.Month == i)
                                                {
                                                    suscripcionesMensual.Add(juego);
                                                }
                                            }

                                            if (suscripcionesMensual.Count > 0)
                                            {
                                                suscripcionesMensual = suscripcionesMensual.OrderBy(s => s.Nombre).ToList();

                                                <div>
                                                    <label>@Herramientas.Idiomas.BuscarTexto(idioma, "Month." + i.ToString(), "Months") (@suscripcionesMensual.Count.ToString())</label>

                                                    <ul>
                                                        @foreach (var juegoMensual in suscripcionesMensual)
                                                        {
                                                            <li style="margin-bottom: 5px;">
                                                                <a href="/game/@juegoMensual.JuegoId/@Herramientas.EnlaceAdaptador.Nombre(juegoMensual.Nombre)/" style="text-decoration: none;">
                                                                    @juegoMensual.Nombre (@Juegos.JuegoDRM2.DevolverDRM(juegoMensual.DRM))
                                                                </a>
                                                            </li>
                                                        }
                                                    </ul>
                                                </div>
                                            }

                                            i += 1;
                                        }
                                    }
                                </div>
                            </div>
                        }
                    }
                </div>
            }
        }

        @if (mostrarOrdenar == true)
        {
            <div class="opciones-panel">
                <div style="max-width: 500px; width: 100%; background-color: var(--fondoSubcabecera); border: 2px solid var(--fondoSubcabecera); margin: 20px auto; overflow-y: scroll; position: relative; justify-content: center; scrollbar-color: var(--fondoCodigo) var(--fondoOscuro); border-radius: 20px; box-shadow: 0px 4px 8px 0px rgba(0, 0, 0, 0.28),0px 0px 2px 0px rgba(0, 0, 0, 0.24);">
                    <div style="display: flex; align-items: center; gap: 30px; padding: 20px 30px; background: color-mix(in srgb, var(--fondoSubcabecera) 55%, var(--fondoBotonPequeño)); justify-content: center;">
                        <button class="boton-pequeño" @onclick="MostrarOcultarOrdenar" style="width: fit-content; padding: 10px 15px; position: absolute; left: 30px;">
                            <div style="max-width: 24px; max-height: 24px;">
                                <svg class="svg-icono" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                    <path d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.2 288 416 288c17.7 0 32-14.3 32-32s-14.3-32-32-32l-306.7 0L214.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z" />
                                </svg>
                            </div>
                        </button>

                        <div style="font-size: 20px;">
                            @Herramientas.Idiomas.BuscarTexto(idioma, "String15", "Subscriptions")
                        </div>
                    </div>

                    <div style="padding: 30px; display: flex; flex-direction: column; gap: 20px;">
                        <button @onclick="@(e => OrdenarPor(e, 0))" class="boton-pequeño" style="padding: 15px 25px; text-align: center;">
                            @Herramientas.Idiomas.BuscarTexto(idioma, "String16", "Subscriptions")
                        </button>
                        <button @onclick="@(e => OrdenarPor(e, 1))" class="boton-pequeño" style="padding: 15px 25px; text-align: center;">
                            @Herramientas.Idiomas.BuscarTexto(idioma, "String17", "Subscriptions")
                        </button>
                        <button @onclick="@(e => OrdenarPor(e, 2))" class="boton-pequeño" style="padding: 15px 25px; text-align: center;">
                            @Herramientas.Idiomas.BuscarTexto(idioma, "String18", "Subscriptions")
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {

    #nullable disable

    private string idioma = "en";
    private string usuarioId = null;
    private string userAgent = null;
    private string dominio = null;

    [PersistentState] public Herramientas.UsuarioListadosJuegos juegosUsuario { get; set; }
    [PersistentState] public Usuario deseadosUsuario { get; set; }
    private bool usuarioPatreon = false;
    private bool usuarioAdmin = false;

    [PersistentState] public List<Juegos.JuegoSuscripcion> juegosActuales { get; set; }
    [PersistentState] public List<JuegoSuscripcion> suscripcionesUltimas { get; set; }

    [Parameter] 
    public string suscripcionSeleccionadaTexto { get; set; }

    private Suscripciones2.SuscripcionTipo suscripcionSeleccionada = Suscripciones2.SuscripcionTipo.Desconocido;
    private Suscripciones2.Suscripcion suscripcionSeleccionada2 = new Suscripciones2.Suscripcion();
    public int ordenarPor { get; set; } = 0;

    private bool mostrarArchivo = false;
    private bool mostrarUltimas = false;

    private List<Suscripciones2.Suscripcion> suscripcionesRelacionadas = null;
    private string imagenFondo = string.Empty;
    private string colorSuscripcion = "var(--fondoSubcabecera)";

    protected override async Task OnInitializedAsync()
    {
        Herramientas.ContextoUsuarioDatos datos = Herramientas.ContextoUsuario.Leer(Contexto);
        idioma = datos.Idioma;
        usuarioId = datos.UsuarioId;
        userAgent = datos.UserAgent;
        dominio = datos.Dominio;

        if (string.IsNullOrEmpty(usuarioId) == false)
        {
            idioma = await BaseDatos.Usuarios.Buscar.IdiomaSobreescribir(usuarioId);
            juegosUsuario ??= await Herramientas.UsuarioJuegos.Cargar(usuarioId);
            deseadosUsuario ??= await BaseDatos.Usuarios.Buscar.DeseadosTiene(usuarioId);
            usuarioPatreon = Herramientas.Patreon.VerificarActivo(await BaseDatos.Usuarios.Buscar.FechaPatreon(usuarioId));
            usuarioAdmin = await BaseDatos.Usuarios.Buscar.RolDios(usuarioId);
        }

        //--------------------------------------------------------------------

        DateTime arranque = new DateTime(2015, 1, 1);

        int i = 0;
        while (i < 100)
        {
            if (arranque.Year != DateTime.Now.Year)
            {
                años.Add(arranque.Year.ToString());
                arranque = arranque.AddYears(1);
            }
            i += 1;
        }

        años.Add(DateTime.Now.Year.ToString());
        años.Reverse();

        //--------------------------------------------------------------------

        if (string.IsNullOrEmpty(suscripcionSeleccionadaTexto) == false)
        {
            foreach (var suscripcion in Suscripciones2.SuscripcionesCargar.GenerarListado())
            {
                if (suscripcion.Id != Suscripciones2.SuscripcionTipo.Desconocido)
                {
                    if (Herramientas.EnlaceAdaptador.Nombre(suscripcion.Id.ToString().ToLower()) == suscripcionSeleccionadaTexto)
                    {
                        suscripcionSeleccionada = suscripcion.Id;
                        break;
                    }
                }
            }

            if (suscripcionSeleccionada != Suscripciones2.SuscripcionTipo.Desconocido)
            {
                await SuscripcionAbrir(suscripcionSeleccionada);
            }
            else
            {
                imagenFondo = string.Empty;
                colorSuscripcion = "var(--fondoSubcabecera)";
            }

            if (suscripcionSeleccionadaTexto == "archive")
            {
                mostrarArchivo = true;
                añoSeleccionado = DateTime.Now.Year.ToString();
                await GenerarArchivo();
            }

            if (suscripcionSeleccionadaTexto == "last-added")
            {
                mostrarUltimas = true;
                suscripcionesUltimas ??= await BaseDatos.Suscripciones.Buscar.UltimasAñadidas();
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool primerRender)
    {
        if (primerRender == true)
        {
            if (suscripcionSeleccionada != Suscripciones2.SuscripcionTipo.Desconocido)
            {
                await CambiarEnlace(suscripcionSeleccionada);
            }
        }
    }

    private async Task SuscripcionAbrir(MouseEventArgs e, Suscripciones2.SuscripcionTipo suscripcion)
    {
        suscripcionSeleccionada = suscripcion;

        if (suscripcionSeleccionada != Suscripciones2.SuscripcionTipo.Desconocido)
        {
            await CambiarEnlace(suscripcionSeleccionada);
            await SuscripcionAbrir(suscripcionSeleccionada);
        }
        else
        {
            mostrarArchivo = false;
            mostrarUltimas = false;

            imagenFondo = string.Empty;
            colorSuscripcion = "var(--fondoSubcabecera)";

            juegosActuales?.Clear();
            await JavaScript.InvokeVoidAsync("ChangeUrl", "/subscriptions/");
        }
    }

    private async Task SuscripcionAbrir(Suscripciones2.SuscripcionTipo suscripcion)
    {
        suscripcionSeleccionada = suscripcion;
        suscripcionSeleccionada2 = Suscripciones2.SuscripcionesCargar.DevolverSuscripcion(suscripcionSeleccionada);
        imagenFondo = suscripcionSeleccionada2.ImagenFondo;
        colorSuscripcion = suscripcionSeleccionada2.ColorDestacado;

        juegosActuales = await BaseDatos.Suscripciones.Buscar.Actuales(suscripcionSeleccionada, ordenarPor, textoBuscador);
    }

    private async Task CambiarEnlace(Suscripciones2.SuscripcionTipo suscripcion)
    {
        await JavaScript.InvokeVoidAsync("ChangeUrl", $"/subscriptions/{Herramientas.EnlaceAdaptador.Nombre(suscripcion.ToString().ToLower())}/");
    }

    private string CambiarEstilo(Suscripciones2.SuscripcionTipo suscripcion)
    {
        if (suscripcion != suscripcionSeleccionada || mostrarArchivo == true || mostrarUltimas == true)
        {
            return "background-color: transparent;";
        }
        else
        {
            return "background-color: var(--botonSeleccionado);";
        }
    }

    private bool mostrarOrdenar = false;

    private async Task MostrarOcultarOrdenar()
    {
        mostrarOrdenar = !mostrarOrdenar;
    }

    private async Task OrdenarPor(MouseEventArgs e, int nuevoOrdenar)
    {
        ordenarPor = nuevoOrdenar;

        await SuscripcionAbrir(suscripcionSeleccionada);
    }

    private async Task CargarArchivo(MouseEventArgs e)
    {
        mostrarArchivo = true;
        añoSeleccionado = DateTime.Now.Year.ToString();

        await JavaScript.InvokeVoidAsync("ChangeUrl", "/subscriptions/archive/");
        await GenerarArchivo();
    }

    private async Task CargarUltimas(MouseEventArgs e)
    {
        mostrarUltimas = true;

        await JavaScript.InvokeVoidAsync("ChangeUrl", "/subscriptions/last-added/");

        suscripcionesUltimas = await BaseDatos.Suscripciones.Buscar.UltimasAñadidas();
    }

    #region Archivo

    private List<Suscripciones2.SuscripcionComponente> suscripcionesPasadas = new List<Suscripciones2.SuscripcionComponente>();
    private List<string> años = new List<string>();
    private string añoSeleccionado = string.Empty;

    private async Task CambiarAño(MouseEventArgs e, string nuevoAño)
    {
        añoSeleccionado = nuevoAño;
        await GenerarArchivo();
    }

    private async Task GenerarArchivo()
    {
        List<Juegos.JuegoSuscripcion> juegosPasados = await BaseDatos.Suscripciones.Buscar.Año(añoSeleccionado);

        if (juegosPasados.Count > 0)
        {
            suscripcionesPasadas.Clear();

            foreach (var suscripcion in Suscripciones2.SuscripcionesCargar.GenerarListado())
            {
                List<Juegos.JuegoSuscripcion> juegos2 = new List<Juegos.JuegoSuscripcion>();

                foreach (var juego in juegosPasados)
                {
                    if (juego.Tipo == suscripcion.Id)
                    {
                        juegos2.Add(juego);
                    }
                }

                if (juegos2.Count > 0)
                {
                    Suscripciones2.SuscripcionComponente componente = new Suscripciones2.SuscripcionComponente();
                    componente.Juegos = juegos2;
                    componente.Tipo = suscripcion;

                    suscripcionesPasadas.Add(componente);
                }
            }
        }
    }

    #endregion

    #region Buscador

    private string textoBuscador { get; set; }
    private bool mostrarBuscador { get; set; } = false;
    private string anchoBuscador => mostrarBuscador ? "width: fit-content;" : "width: 35px;";
    private string fondoBuscador = "background-color: var(--fondoEntrada);";
    private bool haEscrito = false;

    private void MostrarOcultarBuscador()
    {
        mostrarBuscador = !mostrarBuscador;
    }

    private async Task TextoCambiaBuscador()
    {
        await SuscripcionAbrir(suscripcionSeleccionada);

        if (haEscrito == false)
        {
            if (textoBuscador?.Trim().Length > 0)
            {
                haEscrito = true;
            }
        }
        else if (haEscrito == true)
        {
            if (textoBuscador?.Trim().Length == 0)
            {
                mostrarBuscador = false;
                haEscrito = false;
            }
        }
    }

    private void ClickBuscador()
    {
        fondoBuscador = "background-color: var(--fondoBotonPequeñoHover);";
    }

    private void PerderBuscador()
    {
        if (string.IsNullOrEmpty(textoBuscador) == true)
        {
            fondoBuscador = "background-color: var(--fondoEntrada);";
        }
    }

    #endregion
}
