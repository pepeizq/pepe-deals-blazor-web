@page "/wishlist2/"

@attribute [StreamRendering(true)]

@using APIs.Steam
@using BaseDatos.Usuarios
@using Juegos
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Microsoft.AspNetCore.Identity
@using Microsoft.JSInterop
@using pepeizqs_deals_blazor_web.Componentes.Interfaz
@using pepeizqs_deals_web.Data
@using System.Text.Json
@using System.Text
@using Tiendas2

@inject IHttpContextAccessor Contexto
@inject IJSRuntime JavaScript

@if (string.IsNullOrEmpty(perfilUsuarioId) == true)
{
	<Titulo tipo="@Titulo.Tipo.Deseados" idioma="@idioma" dominio="@dominio"/>
}

<script>
	window.downloadFileFromStream = async (fileName, contentStreamReference) => {
	const arrayBuffer = await contentStreamReference.arrayBuffer();
	const blob = new Blob([arrayBuffer]);
	const url = URL.createObjectURL(blob);
	const anchorElement = document.createElement('a');
	anchorElement.href = url;
	anchorElement.download = fileName ?? '';
	anchorElement.click();
	anchorElement.remove();
	URL.revokeObjectURL(url);
	}
</script>

<style>
	.deseado-imagen {
		width: 26%;
	}

	@@media (max-width: 800px) {
		.deseado-imagen {
			display: none;
		}
	}

	.deseado-minicaja {
		background: color-mix(in srgb, var(--fondoSubcabecera) 80%, var(--fondoSubsubcabecera) 20%);
		border: 2px solid var(--fondoSubcabecera);
		padding: 20px;
	}
</style>

<style>
	.cargando {
		width: 48px;
		height: 48px;
		border: 5px solid var(--colorTexto);
		border-bottom-color: transparent;
		border-radius: 50%;
		display: inline-block;
		box-sizing: border-box;
		animation: rotation 1s linear infinite;
	}

	@@keyframes rotation {
	0% {
	transform: rotate(0deg);
	}

	100% {
	transform: rotate(360deg);
	}
	}
</style>

<style>
	:root {
		--glaseadoBorde: #FFFFFF1A;
		--glaseadoFondo: rgba(41, 55, 81, 0.6);
		--noResultados: rgba(132, 32, 41, 0.5);
		--botonSeleccionado: rgba(13, 22, 33, 0.75);
	}

	.caja-deseados {
		display: flex;
		align-items: center;
		gap: 20px;
		padding: 5px;
		width: max-content;
		box-shadow: 0 22px 34px rgba(0, 0, 0, 0.25);
		background-color: var(--glaseadoFondo);
		background-blend-mode: overlay;
		border-radius: 100px;
		border: 2px solid var(--glaseadoBorde);
		backdrop-filter: blur(25px);
		flex-wrap: wrap;
	}

		.caja-deseados > button {
			display: inline-flex;
			align-items: center;
			flex: 0 0 auto; 
			padding: 15px 25px; 
		}

	.caja-deseados-animacion {
		opacity: 0;
		transform: scaleX(0);
		transform-origin: left;
		pointer-events: none;
		transition: all 0.5s ease, transform 0.2s ease;
	}

		.caja-deseados-animacion.visible {
			opacity: 1;
			transform: scaleX(1);
			pointer-events: auto;
		}
</style>

@if (string.IsNullOrEmpty(usuarioId) == false)
{
	if (cargado == false)
	{
		<div style="min-height: 200px; display: flex; align-items: center; justify-content: space-around;">
			<div class="cargando" />
		</div>		
	}
	else
	{
		if (deseadosGestor.Count == 0)
		{
			<div class="caja-deseados" style="background-color: var(--noResultados); justify-content: center; margin: 40px auto; padding: 20px; border-radius: 30px; max-width: 600px; flex-direction: column;">
				<div style="display: flex; align-items: center; gap: 30px;">
					<div style="width: 30px; height: 30px; flex-shrink: 0;">
						<svg class="svg-boton" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
							<path d="M528 320C528 205.1 434.9 112 320 112C205.1 112 112 205.1 112 320C112 434.9 205.1 528 320 528C434.9 528 528 434.9 528 320zM64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576C178.6 576 64 461.4 64 320zM320 240C302.3 240 288 254.3 288 272C288 285.3 277.3 296 264 296C250.7 296 240 285.3 240 272C240 227.8 275.8 192 320 192C364.2 192 400 227.8 400 272C400 319.2 364 339.2 344 346.5L344 350.3C344 363.6 333.3 374.3 320 374.3C306.7 374.3 296 363.6 296 350.3L296 342.2C296 321.7 310.8 307 326.1 302C332.5 299.9 339.3 296.5 344.3 291.7C348.6 287.5 352 281.7 352 272.1C352 254.4 337.7 240.1 320 240.1zM288 432C288 414.3 302.3 400 320 400C337.7 400 352 414.3 352 432C352 449.7 337.7 464 320 464C302.3 464 288 449.7 288 432z" />
						</svg>
					</div>

					<div>
						@Herramientas.Idiomas.BuscarTexto(idioma, "String21", "Wishlist")
					</div>
				</div>

				<a href="/account/sync/" class="boton-pequeño" style="width: fit-content; padding: 15px 25px; background: color-mix(in srgb, var(--noResultados) 35%, var(--fondoBotonPequeño));">
					@Herramientas.Idiomas.BuscarTexto(idioma, "String33", "Wishlist")
				</a>
			</div>
		}

		if (deseadosGestor.Count > 0)
		{
			<div style="display: flex; align-items: center; justify-content: center; margin-bottom: 10px; transition: transform 0.3s ease, opacity 0.3s ease; margin-left: auto; margin-right: auto;">
				<div class="caja-deseados">
					<button @onclick="(e => CambiarPestaña(e, 1))" @onmouseenter="CambiarFondoMinimos" @onmouseleave="RestaurarFondoMinimos" style="@fondoMinimos @backdropMinimos border: 0px; height: 50px; padding: 15px 25px; display: inline-flex; align-items: center; color: var(--colorTexto); border-radius: inherit; @(mostrarBuscador == true && pestañaMostrar != 1 ? "display: none;" : "")">
						<div class="caja-deseados-animacion @(mostrarBuscador == true && pestañaMostrar != 1 ? "" : "visible")">
							@string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String11", "Wishlist"), deseadosHistoricos?.Count)
						</div>
					</button>

					<button @onclick="(e => CambiarPestaña(e, 0))" @onmouseenter="CambiarFondoOfertas" @onmouseleave="RestaurarFondoOfertas" style="@fondoOfertas @backdropOfertas border: 0px; height: 50px; padding: 15px 25px; display: flex; align-items: center; color: var(--colorTexto); border-radius: inherit; @(mostrarBuscador == true && pestañaMostrar != 0 ? "display: none;" : "")">
						<div class="caja-deseados-animacion @(mostrarBuscador == true && pestañaMostrar != 0 ? "" : "visible")">
							@Herramientas.Idiomas.BuscarTexto(idioma, "String1", "Wishlist") (@deseadosOfertas?.Count)
						</div>
					</button>

					@if (string.IsNullOrEmpty(perfilUsuarioId) == true)
					{
						<button @onclick="(e => CambiarPestaña(e, 2))" @onmouseenter="CambiarFondoBundles" @onmouseleave="RestaurarFondoBundles" style="@fondoBundles @backdropBundles border: 0px; height: 50px; padding: 15px 25px; display: flex; align-items: center; color: var(--colorTexto); border-radius: inherit; @(mostrarBuscador == true && pestañaMostrar != 2 ? "display: none;" : "")">
							<div class="caja-deseados-animacion @(mostrarBuscador == true && pestañaMostrar != 2 ? "" : "visible")">
								@string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String29", "Wishlist"), deseadosBundles.Count)
							</div>
						</button>

						<button @onclick="(e => CambiarPestaña(e, 3))" @onmouseenter="CambiarFondoSuscripciones" @onmouseleave="RestaurarFondoSuscripciones" style="@fondoSuscripciones @backdropSuscripciones border: 0px; height: 50px; padding: 15px 25px; display: flex; align-items: center; color: var(--colorTexto); border-radius: inherit; @(mostrarBuscador == true && pestañaMostrar != 3 ? "display: none;" : "")">
							<div class="caja-deseados-animacion @(mostrarBuscador == true && pestañaMostrar != 3 ? "" : "visible")">
								@string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String28", "Wishlist"), deseadosSuscripciones.Count)
							</div>
						</button>
					}
				</div>

				@if (pestañaMostrar == 0 || pestañaMostrar == 1)
				{
					<div style="display: flex; align-items: center; gap: 25px; max-width: 500px; height: 35px; margin-left: 40px; @anchoBuscador">
						<button @onclick="MostrarOcultarBuscador" style="background: transparent; border: 0px;">
							<div style="width: 24px; height: 24px;">
								<svg class="svg-boton" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
									<path d="M480 272C480 317.9 465.1 360.3 440 394.7L566.6 521.4C579.1 533.9 579.1 554.2 566.6 566.7C554.1 579.2 533.8 579.2 521.3 566.7L394.7 440C360.3 465.1 317.9 480 272 480C157.1 480 64 386.9 64 272C64 157.1 157.1 64 272 64C386.9 64 480 157.1 480 272zM272 416C351.5 416 416 351.5 416 272C416 192.5 351.5 128 272 128C192.5 128 128 192.5 128 272C128 351.5 192.5 416 272 416z" />
								</svg>
							</div>
						</button>

						<div class="caja-deseados caja-deseados-animacion @(mostrarBuscador ? "visible" : "")">
							<input type="text" @bind-value="textoBuscador" @bind-value:event="oninput" @bind-value:after="TextoCambiaBuscador" @onclick="ClickBuscador" @onfocusout="PerderBuscador" class="entrada-texto" style="border-radius: inherit; color: var(--colorTexto); padding: 5px 15px; border: 0px; transition: background-color 1000ms linear; @fondoBuscador" placeholder="@Herramientas.Idiomas.BuscarTexto(idioma, "String7", "Wishlist")" />
						</div>
					</div>
				}
				
				<button @onclick="MostrarOcultarOrdenar" style="background: transparent; border: 0px; margin-left: 25px;">
					<div style="width: 24px; height: 24px;">
						<svg class="svg-boton" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
							<path d="M130.4 268.2C135.4 280.2 147 288 160 288L480 288C492.9 288 504.6 280.2 509.6 268.2C514.6 256.2 511.8 242.5 502.7 233.3L342.7 73.3C330.2 60.8 309.9 60.8 297.4 73.3L137.4 233.3C128.2 242.5 125.5 256.2 130.5 268.2zM130.4 371.7C125.4 383.7 128.2 397.4 137.3 406.6L297.3 566.6C309.8 579.1 330.1 579.1 342.6 566.6L502.6 406.6C511.8 397.4 514.5 383.7 509.5 371.7C504.5 359.7 492.9 352 480 352L160 352C147.1 352 135.4 359.8 130.4 371.8z" />
						</svg>
					</div>
				</button>

				<button @onclick="MostrarOcultarOpciones" style="background: transparent; border: 0px; margin-left: 25px;">
					<div style="width: 24px; height: 24px;">
						<svg class="svg-boton" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
							<path d="M259.1 73.5C262.1 58.7 275.2 48 290.4 48L350.2 48C365.4 48 378.5 58.7 381.5 73.5L396 143.5C410.1 149.5 423.3 157.2 435.3 166.3L503.1 143.8C517.5 139 533.3 145 540.9 158.2L570.8 210C578.4 223.2 575.7 239.8 564.3 249.9L511 297.3C511.9 304.7 512.3 312.3 512.3 320C512.3 327.7 511.8 335.3 511 342.7L564.4 390.2C575.8 400.3 578.4 417 570.9 430.1L541 481.9C533.4 495 517.6 501.1 503.2 496.3L435.4 473.8C423.3 482.9 410.1 490.5 396.1 496.6L381.7 566.5C378.6 581.4 365.5 592 350.4 592L290.6 592C275.4 592 262.3 581.3 259.3 566.5L244.9 496.6C230.8 490.6 217.7 482.9 205.6 473.8L137.5 496.3C123.1 501.1 107.3 495.1 99.7 481.9L69.8 430.1C62.2 416.9 64.9 400.3 76.3 390.2L129.7 342.7C128.8 335.3 128.4 327.7 128.4 320C128.4 312.3 128.9 304.7 129.7 297.3L76.3 249.8C64.9 239.7 62.3 223 69.8 209.9L99.7 158.1C107.3 144.9 123.1 138.9 137.5 143.7L205.3 166.2C217.4 157.1 230.6 149.5 244.6 143.4L259.1 73.5zM320.3 400C364.5 399.8 400.2 363.9 400 319.7C399.8 275.5 363.9 239.8 319.7 240C275.5 240.2 239.8 276.1 240 320.3C240.2 364.5 276.1 400.2 320.3 400z" />
						</svg>
					</div>
				</button>
			</div>







			<AuthorizeView>
				<Authorized>
					@if (string.IsNullOrEmpty(perfilUsuarioId) == true)
					{
						<div class="subcabecera" style="background-color: var(--fondoSubsubcabecera);">
							<div class="cuerpo-ancho" style="padding: 20px 0px;">
								<div style="display: flex; align-items: center; gap: 15px; flex-flow: wrap;">
									<button class="boton-pequeño" @onclick="OpcionesDescuentoMinimo" style="font-size: 14px; width: fit-content; padding: 6px 10px; border: 0px; color: var(--colorTextoVisitado);">
										<div style="display: flex; align-items: center; gap: 10px;" title="@Herramientas.Idiomas.BuscarTexto(idioma, "String30", "Wishlist")">
											@Herramientas.Idiomas.BuscarTexto(idioma, "String19", "Wishlist") (@minimoDescuento%)

											@if (enseñarDescuentoMinimo == false)
											{
												<div style="max-width: 9px;">
													<svg class="svg-icono" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">
														<path d="M137.4 374.6c12.5 12.5 32.8 12.5 45.3 0l128-128c9.2-9.2 11.9-22.9 6.9-34.9s-16.6-19.8-29.6-19.8L32 192c-12.9 0-24.6 7.8-29.6 19.8s-2.2 25.7 6.9 34.9l128 128z" />
													</svg>
												</div>
											}
											else
											{
												<div style="max-width: 9px;">
													<svg class="svg-icono" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">
														<path d="M182.6 137.4c-12.5-12.5-32.8-12.5-45.3 0l-128 128c-9.2 9.2-11.9 22.9-6.9 34.9s16.6 19.8 29.6 19.8l256 0c12.9 0 24.6-7.8 29.6-19.8s2.2-25.7-6.9-34.9l-128-128z" />
													</svg>
												</div>
											}
										</div>
									</button>

									<button class="boton-pequeño" @onclick="OpcionesPrecioMaximo" style="font-size: 14px; width: fit-content; padding: 6px 10px; border: 0px; color: var(--colorTextoVisitado);">
										<div style="display: flex; align-items: center; gap: 10px;" title="@Herramientas.Idiomas.BuscarTexto(idioma, "String31", "Wishlist")">
											@Herramientas.Idiomas.BuscarTexto(idioma, "String20", "Wishlist") (@maximoPrecio€)

											@if (enseñarPrecioMaximo == false)
											{
												<div style="max-width: 9px;">
													<svg class="svg-icono" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">
														<path d="M137.4 374.6c12.5 12.5 32.8 12.5 45.3 0l128-128c9.2-9.2 11.9-22.9 6.9-34.9s-16.6-19.8-29.6-19.8L32 192c-12.9 0-24.6 7.8-29.6 19.8s-2.2 25.7 6.9 34.9l128 128z" />
													</svg>
												</div>
											}
											else
											{
												<div style="max-width: 9px;">
													<svg class="svg-icono" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">
														<path d="M182.6 137.4c-12.5-12.5-32.8-12.5-45.3 0l-128 128c-9.2 9.2-11.9 22.9-6.9 34.9s16.6 19.8 29.6 19.8l256 0c12.9 0 24.6-7.8 29.6-19.8s2.2-25.7-6.9-34.9l-128-128z" />
													</svg>
												</div>
											}
										</div>
									</button>

									<button class="boton-pequeño" @onclick="OpcionesExportar" style="font-size: 14px; width: fit-content; padding: 6px 10px; border: 0px; color: var(--colorTextoVisitado);">
										<div style="display: flex; align-items: center; gap: 10px;">
											@Herramientas.Idiomas.BuscarTexto(idioma, "String24", "Wishlist")

											@if (enseñarExportar == false)
											{
												<div style="max-width: 9px;">
													<svg class="svg-icono" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">
														<path d="M137.4 374.6c12.5 12.5 32.8 12.5 45.3 0l128-128c9.2-9.2 11.9-22.9 6.9-34.9s-16.6-19.8-29.6-19.8L32 192c-12.9 0-24.6 7.8-29.6 19.8s-2.2 25.7 6.9 34.9l128 128z" />
													</svg>
												</div>
											}
											else
											{
												<div style="max-width: 9px;">
													<svg class="svg-icono" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512">
														<path d="M182.6 137.4c-12.5-12.5-32.8-12.5-45.3 0l-128 128c-9.2 9.2-11.9 22.9-6.9 34.9s16.6 19.8 29.6 19.8l256 0c12.9 0 24.6-7.8 29.6-19.8s2.2-25.7-6.9-34.9l-128-128z" />
													</svg>
												</div>
											}
										</div>
									</button>
								</div>

								@if (enseñarDescuentoMinimo == true)
								{
									<div class="deseado-minicaja" style="margin-top: 20px;">
										<div style="display: flex; align-items: center; gap: 30px;">
											<input type="range" min="1" max="91" step="5" value="@minimoDescuento" @onchange="@(e => CambiarMinimoDescuento(e))" class="deslizador">

											<label style="min-width: 65px; text-align: center;">@minimoDescuento%</label>
										</div>
									</div>
								}

								@if (enseñarPrecioMaximo == true)
								{
									<div class="deseado-minicaja" style="margin-top: 20px;">
										<div style="display: flex; align-items: center; gap: 30px;">
											<input type="range" min="5" max="90" value="@maximoPrecio" step="1" @onchange="@(e => CambiarMaximoPrecio(e))" class="deslizador">

											<label style="min-width: 65px; text-align: center;">@maximoPrecio€</label>
										</div>
									</div>
								}

								@if (enseñarExportar == true)
								{
									<div class="deseado-minicaja" style="margin-top: 20px;">
										<div style="font-size: 15px;">
											<div style="margin-bottom: 15px;">
												@Herramientas.Idiomas.BuscarTexto(idioma, "String26", "Wishlist")
											</div>

											<button @onclick="@(e => DescargarJson())" class="boton-pequeño" style="width: fit-content; padding: 10px 15px;">
												@Herramientas.Idiomas.BuscarTexto(idioma, "String25", "Wishlist")
											</button>
										</div>
									</div>
								}
							</div>
						</div>
					}
				</Authorized>
			</AuthorizeView>

			<div style="max-width: 1000px; margin: 20px auto;">
				@if (pestañaMostrar == 0 || pestañaMostrar == 1)
				{
					List<JuegoDeseadoMostrar> deseadosFinales = new List<JuegoDeseadoMostrar>();

					if (pestañaMostrar == 0 && deseadosOfertas != null)
					{
						deseadosFinales = deseadosOfertas;
					}

					if (pestañaMostrar == 1 && deseadosHistoricos != null)
					{
						deseadosFinales = deseadosHistoricos;
					}

					if (deseadosFinales?.Count > 0)
					{
						<Virtualize Context="juego" Items="deseadosFinales" ItemSize="alturaFila">
							<ItemContent>
								<div style="margin: 20px 0px; display: flex; align-items: center; position: relative;">
									@{
										string enlaceDeseado = Herramientas.EnlaceAcortador.Generar(juego.Precio.Enlace, juego.Precio.Tienda, usuarioPatreon, false);
									}
								
									<a href="@enlaceDeseado" target="_blank" class="boton-pequeño" style="background: radial-gradient(ellipse at top left, var(--fondoBotonPequeño), var(--fondoOscuro)); padding: 2px;">
										<div style="display: flex; align-items: stretch; justify-content: center; flex-direction: row;">
											<div class="deseado-imagen">
												@{
													string imagen = juego.Imagen;

													if (imagen.Contains(APIs.GOG.Juego.dominioImagenes) == true)
													{
														imagen = imagen.Replace("_glx_logo", null);
														imagen = imagen.Replace(".png", ".webp");
													}
												}

												<img src="@imagen" style="height: 100%; width: 100%;" />
											</div>

											<div style="width: 100%; padding: 0px 20px; display: flex; flex-direction: column; justify-content: center; gap: 10px;">
												<div>@juego.Nombre</div>

												<div style="display: flex; align-items: center; gap: 10px;">
													<div style="width: 20px; height: 20px; display: flex;">
														<img src="@Juegos.JuegoDRM2.SacarImagen(juego.DRM)" style="width: 100%; height: 100%;" />
													</div>

													@if (juego.Precio.Precio > 0)
													{
														List<Tiendas2.Tienda> tiendas = TiendasCargar.GenerarListado();

														foreach (var tienda in tiendas)
														{
															if (tienda.Id == juego.Precio.Tienda)
															{
																<div style="width: 20px; height: 20px; display: flex;">
																	<img src="@tienda.ImagenIcono" style="width: 100%; height: 100%;" />
																</div>

																break;
															}
														}
													}

													@if (string.IsNullOrEmpty(perfilUsuarioId) == true)
													{
														if (ultimaVisita < DateTime.Now && ultimaVisita < juego.Precio.FechaDetectado && juego.Historico == true)
														{
															<div style="text-align: center; font-size: 14px; padding: 5px 15px; background-color: var(--fondoAlerta);">
																@Herramientas.Idiomas.BuscarTexto(idioma, "String13", "Wishlist")
															</div>
														}
													}
												</div>
											</div>

											<div>
												<div style="display: flex; align-items: center;">
													<div style="text-align: center; padding: 10px 15px; margin: 0px; min-width: 65px; font-size: 18px; background-color: darkgreen;">
														@juego.Precio.Descuento.ToString()%
													</div>

													<div style="padding: 5px 15px; min-width: 110px; text-align: center; font-size: 18px;">
														@MensajeMinimo(juego.Precio, false)
													</div>
												</div>

												@if (juego.Historico == true)
												{
													<div style="text-align: center; font-size: 14px; padding: 5px 15px; background-color: var(--fondoAlerta);">
														@Herramientas.Idiomas.BuscarTexto(idioma, "String6", "Wishlist")
													</div>
												}
												else
												{
													<div style="text-align: center; font-size: 14px; padding: 5px; background-color: var(--fondoMinimo);">
														@juego.HistoricoPrecio
													</div>
												}
											</div>
										</div>
									</a>

									<AuthorizeView>
										<Authorized>
											@if (string.IsNullOrEmpty(perfilUsuarioId) == true && juego.Importado == false)
											{
												<div style="background-color: transparent; padding: 5px 10px; display: flex; align-items: center; gap: 10px; right: -100px; position: absolute;">
													<button @onclick="@(e => QuitarJuego(e, juego.Id, juego.DRM, juego))" style="width: fit-content; font-size: 14px; color: var(--colorEnlace); background: transparent; border: 0px; text-decoration: none; margin-left: auto;">
														@Herramientas.Idiomas.BuscarTexto(idioma, "String22", "Wishlist")
													</button>
												</div>
											}
										</Authorized>
									</AuthorizeView>		
								</div>
							</ItemContent>
						</Virtualize>
					}
				}
				else if (pestañaMostrar == 2)
				{
					if (deseadosBundles?.Count > 0)
					{
						<div>
							<Virtualize Context="juego" Items="deseadosBundles" ItemSize="alturaFila">
								<ItemContent>
									@if (juego.IdBundle > 0 && bundlesCache.TryGetValue(juego.IdBundle, out var bundle) && bundle != null)
									{
										string enlaceBundle = Herramientas.EnlaceAcortador.Generar(bundle.Enlace, bundle.BundleTipo, usuarioPatreon, false);

										<div style="margin: 20px 0px; display: flex; align-items: center; position: relative;">
											<a href="@enlaceBundle" target="_blank" class="boton-pequeño" style="background: radial-gradient(ellipse at top left, var(--fondoBotonPequeño), var(--fondoOscuro)); padding: 2px;">
												<div style="display: flex; align-items: stretch; justify-content: center; flex-direction: row;">
													<div class="deseado-imagen">
														@{
															string imagen = juego.Imagen;

															if (imagen.Contains(APIs.GOG.Juego.dominioImagenes) == true)
															{
																imagen = imagen.Replace("_glx_logo", null);
																imagen = imagen.Replace(".png", ".webp");
															}
														}

														<img src="@imagen" style="height: 100%; width: 100%;" />
													</div>

													<div style="width: 100%; padding: 5px 20px; display: flex; flex-direction: column; justify-content: center; gap: 10px;">
														<div>@juego.Nombre</div>

														<div style="display: flex; align-items: center;">
															<div style="width: 20px; height: 20px;">
																<img src="@Juegos.JuegoDRM2.SacarImagen(juego.DRM)" style="width: 100%; height: 100%;" />
															</div>

															<div style="width: 20px; height: 20px; margin-left: 10px;">
																<img src="@Bundles2.BundlesCargar.DevolverBundle(bundle.BundleTipo).ImagenIcono" style="width: 100%; height: 100%;" />
															</div>
														</div>
													</div>

													<div style="display: flex; align-items: center; justify-content: center; min-width: 175px; font-size: 18px;">
														<div style="padding: 5px 15px; text-align: center; font-size: 18px;">
															@if (bundle.Pick == true)
															{
																<div>
																	@Herramientas.Precios.Euro(decimal.Parse(bundle.Tiers[0].Precio))
																</div>

																<div style="font-size: 14px; margin-top: 5px;">
																	@if (bundle.Tiers[0].CantidadJuegos == 1)
																	{
																		@string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String15", "Wishlist"), bundle.Tiers[0].CantidadJuegos)
																	}
																	else if (bundle.Tiers[0].CantidadJuegos > 1)
																	{
																		@string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String16", "Wishlist"), bundle.Tiers[0].CantidadJuegos)
																	}
																</div>
															}
															else
															{
																foreach (var juegoBundle in bundle.Juegos)
																{
																	if (juegoBundle.JuegoId == juego.Id.ToString())
																	{
																		foreach (var tier in bundle.Tiers)
																		{
																			if (tier.Posicion == juegoBundle.Tier.Posicion)
																			{
																				<div>
																					@Herramientas.Precios.Euro(decimal.Parse(tier.Precio))
																				</div>

																				<div style="font-size: 14px; margin-top: 5px;">
																					@string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String17", "Wishlist"), tier.Posicion)
																				</div>

																				break;
																			}
																		}
																	}
																}
															}
														</div>
													</div>
												</div>
											</a>

											<AuthorizeView>
												<Authorized>
													@if (string.IsNullOrEmpty(perfilUsuarioId) == true && juego.Importado == false)
													{
														<div style="background-color: transparent; padding: 5px 10px; display: flex; align-items: center; gap: 10px; right: -100px; position: absolute;">
															<button @onclick="@(e => QuitarJuego(e, juego.Id, juego.DRM, juego))" style="width: fit-content; font-size: 14px; color: var(--colorEnlace); background: transparent; border: 0px; text-decoration: none; margin-left: auto;">
																@Herramientas.Idiomas.BuscarTexto(idioma, "String22", "Wishlist")
															</button>
														</div>
													}
												</Authorized>
											</AuthorizeView>
										</div>
									}
								</ItemContent>
							</Virtualize>
						</div>
					}
				}
				else if (pestañaMostrar == 3)
				{
					if (deseadosSuscripciones?.Count > 0)
					{
						<div>
							<Virtualize Context="juego" Items="deseadosSuscripciones" ItemSize="alturaFila">
								<ItemContent>
									@if (juego.IdSuscripcion > 0 && suscripcionesCache.TryGetValue(juego.IdSuscripcion, out var suscripcion) && suscripcion != null)
									{
										string enlaceSuscripcion = Herramientas.EnlaceAcortador.Generar(suscripcion.Enlace, suscripcion.Tipo, usuarioPatreon, false);

										<div style="margin: 20px 0px; display: flex; align-items: center; position: relative;">
											<a href="@enlaceSuscripcion" target="_blank" class="boton-pequeño" style="background: radial-gradient(ellipse at top left, var(--fondoBotonPequeño), var(--fondoOscuro)); padding: 2px;">
												<div style="display: flex; align-items: stretch; justify-content: center; flex-direction: row;">
													<div class="deseado-imagen">
														@{
															string imagen = juego.Imagen;

															if (imagen.Contains(APIs.GOG.Juego.dominioImagenes) == true)
															{
																imagen = imagen.Replace("_glx_logo", null);
																imagen = imagen.Replace(".png", ".webp");
															}
														}

														<img src="@imagen" style="height: 100%; width: 100%;" />
													</div>

													<div style="width: 100%; padding: 5px 20px;">
														<div style="margin-top: 5px;">@juego.Nombre</div>

														<div style="display: flex; align-items: center; margin-top: 5px;">
															<div style="width: 20px; height: 20px;">
																<img src="@Juegos.JuegoDRM2.SacarImagen(juego.DRM)" style="width: 100%; height: 100%;" />
															</div>

															<div style="width: 20px; height: 20px; margin-left: 10px;">
																<img src="@Suscripciones2.SuscripcionesCargar.DevolverSuscripcion(suscripcion.Tipo).ImagenIcono" style="width: 100%; height: 100%;" />
															</div>
														</div>
													</div>

													<div style="display: flex; align-items: center; justify-content: center; min-width: 175px; font-size: 18px;">
														<div style="padding: 5px 15px; text-align: center; font-size: 18px;">
															@Herramientas.Precios.Euro((decimal)Suscripciones2.SuscripcionesCargar.DevolverSuscripcion(suscripcion.Tipo).Precio)
														</div>
													</div>
												</div>
											</a>

											<AuthorizeView>
												<Authorized>
													@if (string.IsNullOrEmpty(perfilUsuarioId) == true && juego.Importado == false)
													{
														<div style="background-color: transparent; padding: 5px 10px; display: flex; align-items: center; gap: 10px; right: -100px; position: absolute;">
															<button @onclick="@(e => QuitarJuego(e, juego.Id, juego.DRM, juego))" style="width: fit-content; font-size: 14px; color: var(--colorEnlace); background: transparent; border: 0px; text-decoration: none; margin-left: auto;">
																@Herramientas.Idiomas.BuscarTexto(idioma, "String22", "Wishlist")
															</button>
														</div>
													}
												</Authorized>
											</AuthorizeView>
										</div>
									}
								</ItemContent>
							</Virtualize>
						</div>
					}
				}
			</div>
		}
	}
}

@if (mostrarOrdenar == true)
{
	<div class="opciones-panel">
		<div style="max-width: 500px; width: 100%; background-color: var(--fondoSubcabecera); border: 2px solid var(--fondoSubcabecera); margin: 20px auto; overflow-y: scroll; position: relative; justify-content: center; scrollbar-color: var(--fondoCodigo) var(--fondoOscuro); border-radius: 20px; box-shadow: 0px 4px 8px 0px rgba(0, 0, 0, 0.28),0px 0px 2px 0px rgba(0, 0, 0, 0.24);">
			<div style="display: flex; align-items: center; gap: 30px; padding: 20px 30px; background: color-mix(in srgb, var(--fondoSubcabecera) 55%, var(--fondoBotonPequeño)); justify-content: center;">
				<button class="boton-pequeño" @onclick="MostrarOcultarOrdenar" style="width: fit-content; padding: 10px 15px; position: absolute; left: 30px;">
					<div style="max-width: 24px; max-height: 24px;">
						<svg class="svg-icono" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
							<path d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.2 288 416 288c17.7 0 32-14.3 32-32s-14.3-32-32-32l-306.7 0L214.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z" />
						</svg>
					</div>
				</button>

				<div style="font-size: 20px;">
					@Herramientas.Idiomas.BuscarTexto(idioma, "String2", "Wishlist")
				</div>
			</div>

			<div style="padding: 30px; display: flex; flex-direction: column; gap: 20px;">
				<button class="boton-pequeño" style="padding: 15px 25px; text-align: center;" @onclick="OrdenarDetectado">
					@Herramientas.Idiomas.BuscarTexto(idioma, "String32", "Wishlist")
				</button>
				<button class="boton-pequeño" style="padding: 15px 25px; text-align: center;" @onclick="OrdenarReseñasPorcentaje">
					@Herramientas.Idiomas.BuscarTexto(idioma, "String3", "Wishlist")
				</button>
				<button class="boton-pequeño" style="padding: 15px 25px; text-align: center;" @onclick="OrdenarReseñasCantidad">
					@Herramientas.Idiomas.BuscarTexto(idioma, "String9", "Wishlist")
				</button>
				<button class="boton-pequeño" style="padding: 15px 25px; text-align: center;" @onclick="OrdenarNombreAZ">
					@Herramientas.Idiomas.BuscarTexto(idioma, "String10", "Wishlist")
				</button>
				<button class="boton-pequeño" style="padding: 15px 25px; text-align: center;" @onclick="OrdenarNombreZA">
					@Herramientas.Idiomas.BuscarTexto(idioma, "String14", "Wishlist")
				</button>

				@if (pestañaMostrar == 0 || pestañaMostrar == 1)
				{
					<button class="boton-pequeño" style="padding: 15px 25px; text-align: center;" @onclick="OrdenarPrecio">
						@Herramientas.Idiomas.BuscarTexto(idioma, "String4", "Wishlist")
					</button>
					<button class="boton-pequeño" style="padding: 15px 25px; text-align: center;" @onclick="OrdenarDescuento">
						@Herramientas.Idiomas.BuscarTexto(idioma, "String5", "Wishlist")
					</button>
				}
			</div>
		</div>
	</div>
}

@if (mostrarOpciones == true)
{
	<div class="opciones-panel">
		<div style="max-width: 800px; width: 100%; background-color: var(--fondoSubcabecera); border: 2px solid var(--fondoSubcabecera); margin: 20px auto; overflow-y: scroll; scrollbar-color: var(--fondoCodigo) var(--fondoOscuro); border-radius: 20px; box-shadow: 0px 4px 8px 0px rgba(0, 0, 0, 0.28),0px 0px 2px 0px rgba(0, 0, 0, 0.24);">
			<div style="display: flex; align-items: center; gap: 30px; padding: 20px 30px; background: color-mix(in srgb, var(--fondoSubcabecera) 55%, var(--fondoBotonPequeño));">
				<button class="boton-pequeño" @onclick="MostrarOcultarOpciones" style="width: fit-content; padding: 10px 15px;">
					<div style="max-width: 24px; max-height: 24px;">
						<svg class="svg-icono" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
							<path d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.2 288 416 288c17.7 0 32-14.3 32-32s-14.3-32-32-32l-306.7 0L214.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z" />
						</svg>
					</div>
				</button>

				<div style="font-size: 20px;">
					@Herramientas.Idiomas.BuscarTexto(idioma, "String10", "SteamDeck")
				</div>
			</div>

			<div style="display: flex; flex-direction: column; gap: 30px; padding: 30px;">
				
			</div>
		</div>
	</div>
}

@code {

	#nullable disable

	private string idioma = "en";
	private string usuarioId = null;
	private string dominio = null;

	private bool usuarioPatreon = false;
	[PersistentState] public Usuario opcionesDeseados { get; set; }
	[PersistentState] public DateTime ultimaVisita { get; set; }

	[Parameter]
	public string perfilUsuarioId { get; set; }

	private int pestañaMostrar = 0;

	[PersistentState] public List<JuegoDeseadoMostrar> deseadosGestor { get; set; }
	public List<JuegoDeseadoMostrar> deseadosOfertas = new List<JuegoDeseadoMostrar>();
	public List<JuegoDeseadoMostrar> deseadosHistoricos = new List<JuegoDeseadoMostrar>();
	[PersistentState] public List<JuegoDeseadoMostrar> deseadosBundles { get; set; }
	[PersistentState] public List<JuegoDeseadoMostrar> deseadosSuscripciones { get; set; }

	[PersistentState] public List<Bundles2.Bundle> bundlesActuales { get; set; }
	[PersistentState] public List<JuegoSuscripcion> suscripcionesActuales { get; set; }

	private string ordenamientoElegido = string.Empty;

	private int alturaFila = 82;

	private bool cargado = false;

	private Dictionary<int, Bundles2.Bundle> bundlesCache = new();
	private Dictionary<int, JuegoSuscripcion> suscripcionesCache = new();

	protected override async Task OnInitializedAsync()
	{
		Herramientas.ContextoUsuarioDatos datos = Herramientas.ContextoUsuario.Leer(Contexto);
		idioma = datos.Idioma;
		usuarioId = datos.UsuarioId;
		dominio = datos.Dominio;

		if (string.IsNullOrEmpty(usuarioId) == false)
		{
			idioma = await BaseDatos.Usuarios.Buscar.IdiomaSobreescribir(usuarioId);
			usuarioPatreon = Herramientas.Patreon.VerificarActivo(await BaseDatos.Usuarios.Buscar.FechaPatreon(usuarioId));
		}

		if (string.IsNullOrEmpty(perfilUsuarioId) == false)
		{
			usuarioId = perfilUsuarioId;
		}
	}

	protected override async Task OnAfterRenderAsync(bool primerRender)
	{
		if (primerRender == true)
		{
			if (string.IsNullOrEmpty(usuarioId) == false)
			{
				opcionesDeseados ??= await BaseDatos.Usuarios.Buscar.OpcionesDeseados(usuarioId);

				if (string.IsNullOrEmpty(perfilUsuarioId) == true)
				{
					if (string.IsNullOrEmpty(opcionesDeseados?.WishlistData) == false)
					{
						DeseadosDatos datos = JsonSerializer.Deserialize<DeseadosDatos>(opcionesDeseados?.WishlistData);

						if (datos != null)
						{
							if (datos.UltimaVisita != null)
							{
								ultimaVisita = (DateTime)datos.UltimaVisita;
							}
							else
							{
								ultimaVisita = DateTime.Now;
							}

							datos.Cantidad = 0;
							datos.UltimaVisita = DateTime.Now;

							await BaseDatos.Usuarios.Actualizar.Opcion("WishlistData", JsonSerializer.Serialize(datos), usuarioId);
						}
					}
				}

				if (opcionesDeseados.WishlistPosition != null)
				{
					pestañaMostrar = (int)opcionesDeseados.WishlistPosition;
				}

				await CambiarPestañaFondo(pestañaMostrar);

				if (deseadosGestor == null)
				{
					deseadosGestor = new List<JuegoDeseadoMostrar>();
				}

				deseadosGestor = await Herramientas.Deseados.LeerJuegos(usuarioId);

				#region Filtrado

				if (opcionesDeseados.WishlistOption3 == null)
				{
					minimoDescuento = 1;
				}
				else
				{
					if (opcionesDeseados.WishlistOption3 == 0 || opcionesDeseados.WishlistOption3 == null)
					{
						minimoDescuento = 1;
					}
					else if (opcionesDeseados.WishlistOption3 > 0)
					{
						minimoDescuento = opcionesDeseados.WishlistOption3;
					}
				}

				if (opcionesDeseados.WishlistOption4 == null)
				{
					maximoPrecio = 90;
				}
				else
				{
					if (opcionesDeseados.WishlistOption4 == 0 || opcionesDeseados.WishlistOption4 == null)
					{
						maximoPrecio = 90;
					}
					else if (opcionesDeseados.WishlistOption4 > 0)
					{
						maximoPrecio = opcionesDeseados.WishlistOption4;
					}
				}

				#endregion

				if (deseadosGestor?.Count > 0)
				{
					if (opcionesDeseados?.WishlistSort == null)
					{
						opcionesDeseados.WishlistSort = 3;
					}

					await ElegirOrdenamiento();
				}

				#region Bundles

				bundlesActuales ??= await BaseDatos.Bundles.Buscar.Actuales();

				if (bundlesActuales.Count > 0)
				{
					foreach (var bundle in bundlesActuales)
					{
						foreach (var bundleJuego in bundle.Juegos)
						{
							foreach (var deseado in deseadosGestor)
							{
								if (bundleJuego.JuegoId == deseado.Id.ToString() && bundleJuego.DRM == deseado.DRM)
								{
									JuegoDeseadoMostrar nuevoDeseadoBundle = new JuegoDeseadoMostrar();
									nuevoDeseadoBundle.Id = deseado.Id;
									nuevoDeseadoBundle.Nombre = deseado.Nombre;
									nuevoDeseadoBundle.IdBundle = bundle.Id;
									nuevoDeseadoBundle.DRM = deseado.DRM;
									nuevoDeseadoBundle.Imagen = deseado.Imagen;
									nuevoDeseadoBundle.Importado = deseado.Importado;

									if (deseadosBundles == null)
									{
										deseadosBundles = new List<JuegoDeseadoMostrar>();
									}

									bool añadir = true;

									if (deseadosBundles.Count > 0)
									{
										foreach (var yaEnLista in deseadosBundles)
										{
											if (yaEnLista.Id == nuevoDeseadoBundle.Id && yaEnLista.DRM == nuevoDeseadoBundle.DRM && yaEnLista.IdBundle == nuevoDeseadoBundle.IdBundle)
											{
												añadir = false;
												break;
											}
										}
									}

									if (añadir == true)
									{
										deseadosBundles.Add(nuevoDeseadoBundle);
									}
								}
							}
						}
					}
				}

				if (deseadosBundles?.Count > 0)
				{
					foreach (var juego in deseadosBundles)
					{
						if (juego.IdBundle > 0 && bundlesCache.ContainsKey(juego.IdBundle) == false)
						{
							bundlesCache[juego.IdBundle] = await BaseDatos.Bundles.Buscar.UnBundle(juego.IdBundle);
						}
					}
				}

				#endregion

				#region Suscripciones

				suscripcionesActuales ??= await BaseDatos.Suscripciones.Buscar.Actuales();

				if (suscripcionesActuales?.Count > 0)
				{
					foreach (var juegoSuscripcion in suscripcionesActuales)
					{
						foreach (var deseado in deseadosGestor)
						{
							if (juegoSuscripcion.JuegoId == deseado.Id && juegoSuscripcion.DRM == deseado.DRM)
							{
								JuegoDeseadoMostrar nuevoDeseadoSuscripcion = new JuegoDeseadoMostrar();
								nuevoDeseadoSuscripcion.Id = deseado.Id;
								nuevoDeseadoSuscripcion.Nombre = deseado.Nombre;
								nuevoDeseadoSuscripcion.IdSuscripcion = juegoSuscripcion.Id;
								nuevoDeseadoSuscripcion.DRM = deseado.DRM;
								nuevoDeseadoSuscripcion.Imagen = deseado.Imagen;
								nuevoDeseadoSuscripcion.Importado = deseado.Importado;

								if (deseadosSuscripciones == null)
								{
									deseadosSuscripciones = new List<JuegoDeseadoMostrar>();
								}

								bool añadir = true;

								if (deseadosSuscripciones.Count > 0)
								{
									foreach (var yaEnLista in deseadosSuscripciones)
									{
										if (yaEnLista.Id == nuevoDeseadoSuscripcion.Id && yaEnLista.DRM == nuevoDeseadoSuscripcion.DRM && yaEnLista.IdSuscripcion == nuevoDeseadoSuscripcion.IdSuscripcion)
										{
											añadir = false;
											break;
										}
									}
								}

								if (añadir == true)
								{
									deseadosSuscripciones.Add(nuevoDeseadoSuscripcion);
								}
							}
						}
					}
				}

				if (deseadosSuscripciones?.Count > 0)
				{
					foreach (var juego in deseadosSuscripciones)
					{
						if (juego.IdSuscripcion > 0 && suscripcionesCache.ContainsKey(juego.Id) == false)
						{
							suscripcionesCache[juego.IdSuscripcion] = await BaseDatos.Suscripciones.Buscar.Id(juego.IdSuscripcion);
						}
					}
				}

				#endregion
				cargado = true;
			}

			await InvokeAsync(StateHasChanged);
		}
	}

	private string CambiarEstilo(int pestañaClickeada)
	{
		if (pestañaClickeada == pestañaMostrar)
		{
			return "background-color: var(--botonSubcabecera); box-shadow: 0px 2px 4px 0px rgba(0, 0, 0, 0.25),0px 0px 1px 0px rgba(0, 0, 0, 0.25);";
		}
		else
		{
			return "background-color: transparent;";
		}
	}

	private async Task CambiarPestaña(MouseEventArgs e, int nuevaPestaña)
	{
		pestañaMostrar = nuevaPestaña;

		await CambiarPestañaFondo(nuevaPestaña);

		await BaseDatos.Usuarios.Actualizar.Opcion("WishlistPosition", pestañaMostrar, usuarioId);
	}

	private async Task CambiarPestañaFondo(int nuevaPestaña)
	{
		fondoMinimos = "background: transparent;";
		fondoOfertas = "background: transparent;";
		fondoBundles = "background: transparent;";
		fondoSuscripciones = "background: transparent;";

		if (nuevaPestaña == 1)
		{
			fondoMinimos = "background: var(--botonSeleccionado);";
		}
		else if (nuevaPestaña == 0)
		{
			fondoOfertas = "background: var(--botonSeleccionado);";
		}
		else if (nuevaPestaña == 2)
		{
			fondoBundles = "background: var(--botonSeleccionado);";
		}
		else if (nuevaPestaña == 3)
		{
			fondoSuscripciones = "background: var(--botonSeleccionado);";
		}
	}

	private JuegoPrecio SacarMinimo(Juegos.Juego juego, Juegos.JuegoDRM drm)
	{
		foreach (var minimo in juego.PrecioMinimosHistoricos)
		{
			if (drm == minimo.DRM)
			{
				return minimo;
			}
		}

		return null;
	}

	private string MensajeMinimo(JuegoPrecio precio, bool moneda)
	{
		if (precio != null)
		{
			if (precio.Moneda != Herramientas.JuegoMoneda.Euro && precio.PrecioCambiado == 0)
			{
				return Herramientas.Precios.Euro(Herramientas.Divisas.Cambio(precio.Precio, precio.Moneda));
			}
			else if (precio.Moneda != Herramientas.JuegoMoneda.Euro && precio.PrecioCambiado > 0)
			{
				return Herramientas.Precios.Euro(precio.PrecioCambiado);
			}

			return Herramientas.Precios.Euro(precio.Precio);
		}

		return null;
	}

	private async Task QuitarJuego(MouseEventArgs e, int juegoId, Juegos.JuegoDRM drm, JuegoDeseadoMostrar juegoMostrar)
	{
		Juegos.Juego juego = await BaseDatos.Juegos.Buscar.UnJuego(juegoId);

		if (juego != null)
		{
			await Herramientas.Deseados.CambiarEstado(usuarioId, juego, false, drm, false);
		}

		if (deseadosOfertas.Count > 0)
		{
			deseadosOfertas.Remove(juegoMostrar);
		}

		if (deseadosHistoricos.Count > 0)
		{
			deseadosHistoricos.Remove(juegoMostrar);
		}

		if (deseadosBundles.Count > 0)
		{
			deseadosBundles.Remove(juegoMostrar);
		}

		if (deseadosSuscripciones.Count > 0)
		{
			deseadosSuscripciones.Remove(juegoMostrar);
		}

		await InvokeAsync(StateHasChanged);
	}

	#region Ordenar

	private async Task OrdenarReseñasPorcentaje()
	{
		if (deseadosGestor != null)
		{
			ordenamientoElegido = Herramientas.Idiomas.BuscarTexto(idioma, "String3", "Wishlist");

			if (deseadosGestor.Count > 0)
			{
				deseadosOfertas.Clear();
				deseadosOfertas = Filtros(false);
				deseadosOfertas = deseadosOfertas?.AsParallel().OrderByDescending(x => int.Parse(x.ReseñasPorcentaje ??= "0")).ThenBy(x => x.Nombre).ToList();

				deseadosHistoricos.Clear();
				deseadosHistoricos = Filtros(true);
				deseadosHistoricos = deseadosHistoricos?.AsParallel().OrderByDescending(x => int.Parse(x.ReseñasPorcentaje ??= "0")).ThenBy(x => x.Nombre).ToList();

				deseadosBundles = deseadosBundles?.AsParallel().OrderByDescending(x => int.Parse(x.ReseñasPorcentaje ??= "0")).ThenBy(x => x.Nombre).ToList();
				deseadosSuscripciones = deseadosSuscripciones?.AsParallel().OrderByDescending(x => int.Parse(x.ReseñasPorcentaje ??= "0")).ThenBy(x => x.Nombre).ToList();
			}

			if (string.IsNullOrEmpty(usuarioId) == false)
			{
				opcionesDeseados.WishlistSort = 0;
			}

			if (string.IsNullOrEmpty(usuarioId) == false && string.IsNullOrEmpty(perfilUsuarioId) == true)
			{
				await BaseDatos.Usuarios.Actualizar.Opcion("WishlistSort", 0, usuarioId);
			}
		}
	}

	private async Task OrdenarReseñasCantidad()
	{
		if (deseadosGestor != null)
		{
			ordenamientoElegido = Herramientas.Idiomas.BuscarTexto(idioma, "String9", "Wishlist");

			if (deseadosGestor.Count > 0)
			{
				deseadosOfertas.Clear();
				deseadosOfertas = Filtros(false);
				deseadosOfertas = deseadosOfertas?.AsParallel().OrderByDescending(x => int.Parse(x.ReseñasCantidad ??= "0")).ThenBy(x => x.Nombre).ToList();

				deseadosHistoricos.Clear();
				deseadosHistoricos = Filtros(true);
				deseadosHistoricos = deseadosHistoricos?.AsParallel().OrderByDescending(x => int.Parse(x.ReseñasCantidad ??= "0")).ThenBy(x => x.Nombre).ToList();

				deseadosBundles = deseadosBundles?.AsParallel().OrderByDescending(x => int.Parse(x.ReseñasCantidad ??= "0")).ThenBy(x => x.Nombre).ToList();
				deseadosSuscripciones = deseadosSuscripciones?.AsParallel().OrderByDescending(x => int.Parse(x.ReseñasCantidad ??= "0")).ThenBy(x => x.Nombre).ToList();
			}

			if (string.IsNullOrEmpty(usuarioId) == false)
			{
				opcionesDeseados.WishlistSort = 1;
			}

			if (string.IsNullOrEmpty(usuarioId) == false && string.IsNullOrEmpty(perfilUsuarioId) == true)
			{
				await BaseDatos.Usuarios.Actualizar.Opcion("WishlistSort", 1, usuarioId);
			}
		}
	}

	private async Task OrdenarNombreAZ()
	{
		if (deseadosGestor != null)
		{
			ordenamientoElegido = Herramientas.Idiomas.BuscarTexto(idioma, "String10", "Wishlist");

			if (deseadosGestor.Count > 0)
			{
				deseadosOfertas.Clear();
				deseadosOfertas = Filtros(false);
				deseadosOfertas = deseadosOfertas?.AsParallel().OrderBy(x => x.Nombre).ToList();

				deseadosHistoricos.Clear();
				deseadosHistoricos = Filtros(true);
				deseadosHistoricos = deseadosHistoricos?.AsParallel().OrderBy(x => x.Nombre).ToList();

				deseadosBundles = deseadosBundles?.AsParallel().OrderBy(x => x.Nombre).ToList();
				deseadosSuscripciones = deseadosSuscripciones?.AsParallel().OrderBy(x => x.Nombre).ToList();
			}

			if (string.IsNullOrEmpty(usuarioId) == false)
			{
				opcionesDeseados.WishlistSort = 2;
			}

			if (string.IsNullOrEmpty(usuarioId) == false && string.IsNullOrEmpty(perfilUsuarioId) == true)
			{
				await BaseDatos.Usuarios.Actualizar.Opcion("WishlistSort", 2, usuarioId);
			}
		}
	}

	private async Task OrdenarNombreZA()
	{
		if (deseadosGestor != null)
		{
			ordenamientoElegido = Herramientas.Idiomas.BuscarTexto(idioma, "String14", "Wishlist");

			if (deseadosGestor.Count > 0)
			{
				deseadosOfertas.Clear();
				deseadosOfertas = Filtros(false);
				deseadosOfertas = deseadosOfertas?.AsParallel().OrderByDescending(x => x.Nombre).ToList();

				deseadosHistoricos.Clear();
				deseadosHistoricos = Filtros(true);
				deseadosHistoricos = deseadosHistoricos?.AsParallel().OrderByDescending(x => x.Nombre).ToList();

				deseadosBundles = deseadosBundles?.AsParallel().OrderByDescending(x => x.Nombre).ToList();
				deseadosSuscripciones = deseadosSuscripciones?.AsParallel().OrderByDescending(x => x.Nombre).ToList();
			}

			if (string.IsNullOrEmpty(usuarioId) == false)
			{
				opcionesDeseados.WishlistSort = 5;
			}

			if (string.IsNullOrEmpty(usuarioId) == false && string.IsNullOrEmpty(perfilUsuarioId) == true)
			{
				await BaseDatos.Usuarios.Actualizar.Opcion("WishlistSort", 5, usuarioId);
			}
		}
	}

	private async Task OrdenarPrecio()
	{
		if (deseadosGestor != null)
		{
			ordenamientoElegido = Herramientas.Idiomas.BuscarTexto(idioma, "String4", "Wishlist");

			if (deseadosGestor.Count > 0)
			{
				deseadosOfertas.Clear();
				deseadosOfertas = Filtros(false);
				deseadosOfertas = deseadosOfertas?.AsParallel().OrderBy(x => x.Precio.Precio).ThenBy(x => x.Nombre).ToList();

				deseadosHistoricos.Clear();
				deseadosHistoricos = Filtros(true);
				deseadosHistoricos = deseadosHistoricos?.AsParallel().OrderBy(x => x.Precio.Precio).ThenBy(x => x.Nombre).ToList();
			}

			if (string.IsNullOrEmpty(usuarioId) == false)
			{
				opcionesDeseados.WishlistSort = 3;
			}

			if (string.IsNullOrEmpty(usuarioId) == false && string.IsNullOrEmpty(perfilUsuarioId) == true)
			{
				await BaseDatos.Usuarios.Actualizar.Opcion("WishlistSort", 3, usuarioId);
			}
		}
	}

	private async Task OrdenarDescuento()
	{
		if (deseadosOfertas != null)
		{
			ordenamientoElegido = Herramientas.Idiomas.BuscarTexto(idioma, "String5", "Wishlist");

			if (deseadosGestor.Count > 0)
			{
				deseadosOfertas.Clear();
				deseadosOfertas = Filtros(false);
				deseadosOfertas = deseadosOfertas?.AsParallel().OrderByDescending(x => x.Precio.Descuento).ThenBy(x => x.Nombre).ToList();

				deseadosHistoricos.Clear();
				deseadosHistoricos = Filtros(true);
				deseadosHistoricos = deseadosHistoricos?.AsParallel().OrderByDescending(x => x.Precio.Descuento).ThenBy(x => x.Nombre).ToList();
			}

			if (string.IsNullOrEmpty(usuarioId) == false)
			{
				opcionesDeseados.WishlistSort = 4;
			}

			if (string.IsNullOrEmpty(usuarioId) == false && string.IsNullOrEmpty(perfilUsuarioId) == true)
			{
				await BaseDatos.Usuarios.Actualizar.Opcion("WishlistSort", 4, usuarioId);
			}
		}
	}

	private async Task OrdenarDetectado()
	{
		if (deseadosOfertas != null)
		{
			ordenamientoElegido = Herramientas.Idiomas.BuscarTexto(idioma, "String32", "Wishlist");

			if (deseadosGestor.Count > 0)
			{
				deseadosOfertas.Clear();
				deseadosOfertas = Filtros(false);
				deseadosOfertas = deseadosOfertas?.AsParallel().OrderByDescending(x => x.Precio.FechaDetectado).ThenBy(x => x.Nombre).ToList();

				deseadosHistoricos.Clear();
				deseadosHistoricos = Filtros(true);
				deseadosHistoricos = deseadosHistoricos?.AsParallel().OrderByDescending(x => x.Precio.FechaDetectado).ThenBy(x => x.Nombre).ToList();
			}

			if (string.IsNullOrEmpty(usuarioId) == false)
			{
				opcionesDeseados.WishlistSort = 6;
			}

			if (string.IsNullOrEmpty(usuarioId) == false && string.IsNullOrEmpty(perfilUsuarioId) == true)
			{
				await BaseDatos.Usuarios.Actualizar.Opcion("WishlistSort", 6, usuarioId);
			}
		}
	}

	#endregion

	#region Buscador

	private string textoBuscador { get; set; }
	private bool mostrarBuscador { get; set; } = false;
	private string anchoBuscador => mostrarBuscador ? "width: fit-content;" : "width: 35px;";
	private string fondoBuscador = "background-color: var(--fondoEntrada);";
	private bool haEscrito = false;

	private void MostrarOcultarBuscador()
	{
		mostrarBuscador = !mostrarBuscador;
	}

	private async Task TextoCambiaBuscador()
	{
		await ElegirOrdenamiento();

		if (haEscrito == false)
		{
			if (textoBuscador?.Trim().Length > 0)
			{
				haEscrito = true;
			}
		}
		else if (haEscrito == true)
		{
			if (textoBuscador?.Trim().Length == 0)
			{
				mostrarBuscador = false;
				haEscrito = false;
			}
		}
	}

	private void ClickBuscador()
	{
		fondoBuscador = "background-color: var(--fondoBotonPequeñoHover);";
	}

	private void PerderBuscador()
	{
		if (string.IsNullOrEmpty(textoBuscador) == true)
		{
			fondoBuscador = "background-color: var(--fondoEntrada);";
		}
	}

	#endregion

	#region Opciones

	private bool mostrarOpciones { get; set; } = false;

	private async Task MostrarOcultarOpciones()
	{
		mostrarOpciones = !mostrarOpciones;
	}

	private List<JuegoDeseadoMostrar> Filtros(bool historico)
	{
		mostrarOrdenar = false;

		List<JuegoDeseadoMostrar> juegosFiltrados = new List<JuegoDeseadoMostrar>();

		foreach (var juego in deseadosGestor)
		{
			bool historico2 = false;

			if (historico == true)
			{
				if (juego.Historico == true)
				{
					historico2 = true;
				}
			}
			else
			{
				historico2 = true;
			}

			if (historico2 == true)
			{
				bool buscador = false;

				if (string.IsNullOrEmpty(textoBuscador) == false)
				{
					if (Herramientas.Buscador.LimpiarNombre(juego.Nombre, true).Contains(Herramientas.Buscador.LimpiarNombre(textoBuscador, true)))
					{
						buscador = true;
					}
					else
					{
						buscador = false;
					}
				}
				else
				{
					buscador = true;
				}

				bool minimoDescuento2 = false;

				if (juego.Precio.Descuento >= minimoDescuento)
				{
					minimoDescuento2 = true;
				}

				bool maximoPrecio2 = false;

				if (juego.Precio.Precio <= maximoPrecio)
				{
					maximoPrecio2 = true;
				}

				if (buscador == true && minimoDescuento2 == true && maximoPrecio2 == true)
				{
					juegosFiltrados.Add(juego);
				}
			}
		}

		return juegosFiltrados;
	}

	private bool mostrarOrdenar = false;

	private async Task MostrarOcultarOrdenar()
	{
		mostrarOrdenar = !mostrarOrdenar;
	}

	private async Task ElegirOrdenamiento()
	{
		if (opcionesDeseados.WishlistSort == 0)
		{
			await OrdenarReseñasPorcentaje();
		}
		else if (opcionesDeseados.WishlistSort == 1)
		{
			await OrdenarReseñasCantidad();
		}
		else if (opcionesDeseados.WishlistSort == 2)
		{
			await OrdenarNombreAZ();
		}
		else if (opcionesDeseados.WishlistSort == 5)
		{
			await OrdenarNombreZA();
		}
		else if (opcionesDeseados.WishlistSort == 3)
		{
			await OrdenarPrecio();
		}
		else if (opcionesDeseados.WishlistSort == 4)
		{
			await OrdenarDescuento();
		}
		else if (opcionesDeseados.WishlistSort == 6)
		{
			await OrdenarDetectado();
		}
	}

	private int? minimoDescuento = 1;

	private async Task CambiarMinimoDescuento(ChangeEventArgs e)
	{
		minimoDescuento = int.Parse(e.Value.ToString());

		if (minimoDescuento != 1)
		{
			minimoDescuento = minimoDescuento - 1;
		}

		if (minimoDescuento != null)
		{
			opcionesDeseados.WishlistOption3 = minimoDescuento;

			await BaseDatos.Usuarios.Actualizar.Opcion("WishlistOption3", (int)minimoDescuento, usuarioId);
		}

		await ElegirOrdenamiento();
	}

	private decimal? maximoPrecio = 90;

	private async Task CambiarMaximoPrecio(ChangeEventArgs e)
	{
		maximoPrecio = decimal.Parse(e.Value.ToString());

		if (maximoPrecio != null)
		{
			opcionesDeseados.WishlistOption4 = maximoPrecio;

			await BaseDatos.Usuarios.Actualizar.Opcion("WishlistOption4", (decimal)maximoPrecio, usuarioId);
		}

		await ElegirOrdenamiento();
	}

	private async Task DescargarJson()
	{
		if (deseadosGestor?.Count > 0)
		{
			List<JuegoDeseadoExportar> deseadosExportar = new List<JuegoDeseadoExportar>();

			foreach (var deseadoGestor in deseadosGestor)
			{
				JuegoDeseadoExportar nuevoDeseadoExportar = new JuegoDeseadoExportar();
				nuevoDeseadoExportar.Nombre = deseadoGestor.Nombre;
				nuevoDeseadoExportar.Id = deseadoGestor.Id;
				nuevoDeseadoExportar.IdSteam = deseadoGestor.IdSteam;
				nuevoDeseadoExportar.IdGog = deseadoGestor.IdGog;
				nuevoDeseadoExportar.SlugEpic = deseadoGestor.SlugEpic;
				nuevoDeseadoExportar.DRM = deseadoGestor.DRM;

				deseadosExportar.Add(nuevoDeseadoExportar);
			}

			string contenido = JsonSerializer.Serialize(deseadosExportar);

			MemoryStream ficheroStream = new MemoryStream(Encoding.UTF8.GetBytes(contenido));

			string ficheroNombre = "wishlist.json";

			using var streamRef = new DotNetStreamReference(stream: ficheroStream);

			await JavaScript.InvokeVoidAsync("downloadFileFromStream", ficheroNombre, streamRef);
		}
	}

	private void OpcionesPestañas()
	{
		enseñarDescuentoMinimo = false;
		enseñarPrecioMaximo = false;
		enseñarExportar = false;
	}

	private bool enseñarDescuentoMinimo = false;

	private void OpcionesDescuentoMinimo()
	{
		if (enseñarDescuentoMinimo == false)
		{
			OpcionesPestañas();

			enseñarDescuentoMinimo = true;
		}
		else
		{
			enseñarDescuentoMinimo = false;
		}
	}

	private bool enseñarPrecioMaximo = false;

	private void OpcionesPrecioMaximo()
	{
		if (enseñarPrecioMaximo == false)
		{
			OpcionesPestañas();

			enseñarPrecioMaximo = true;
		}
		else
		{
			enseñarPrecioMaximo = false;
		}
	}

	private bool enseñarExportar = false;

	private void OpcionesExportar()
	{
		if (enseñarExportar == false)
		{
			OpcionesPestañas();

			enseñarExportar = true;
		}
		else
		{
			enseñarExportar = false;
		}
	}

	#endregion

	#region Abrir Oferta

	private async void AbrirOferta(MouseEventArgs e, string enlace)
	{
		await JavaScript.InvokeVoidAsync("open", enlace, "_blank");
	}

	#endregion

	#region Cabecera

	private string fondoMinimos = "background: transparent;";
	private string backdropMinimos = string.Empty;

	private async Task CambiarFondoMinimos()
	{
		backdropMinimos = "backdrop-filter: brightness(50%);";
	}

	private async Task RestaurarFondoMinimos()
	{
		backdropMinimos = string.Empty;
	}

	private string fondoOfertas = "background: transparent;";
	private string backdropOfertas = string.Empty;

	private async Task CambiarFondoOfertas()
	{
		backdropOfertas = "backdrop-filter: brightness(50%);";
	}

	private async Task RestaurarFondoOfertas()
	{
		backdropOfertas = string.Empty;
	}

	private string fondoBundles = "background: transparent;";
	private string backdropBundles = string.Empty;

	private async Task CambiarFondoBundles()
	{
		backdropBundles = "backdrop-filter: brightness(50%);";
	}

	private async Task RestaurarFondoBundles()
	{
		backdropBundles = string.Empty;
	}

	private string fondoSuscripciones = "background: transparent;";
	private string backdropSuscripciones = string.Empty;

	private async Task CambiarFondoSuscripciones()
	{
		backdropSuscripciones = "backdrop-filter: brightness(50%);";
	}

	private async Task RestaurarFondoSuscripciones()
	{
		backdropSuscripciones = string.Empty;
	}

	#endregion
}
