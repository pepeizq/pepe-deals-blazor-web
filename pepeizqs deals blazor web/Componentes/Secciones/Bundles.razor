@page "/bundles/"
@page "/bundles/{bundleSeleccionadoTexto}/"

@using APIs.Steam
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Web.Virtualization
@using Microsoft.AspNetCore.Identity
@using Microsoft.JSInterop
@using Microsoft.VisualBasic
@using pepeizqs_deals_blazor_web.Componentes.Interfaz
@using pepeizqs_deals_web.Data

@inject IHttpContextAccessor Contexto
@inject IJSRuntime JavaScript

@if (cargadoBundles == true)
{
	string titulo = Herramientas.Idiomas.BuscarTexto(idioma, "Title", "Bundle");
	string keywords = "bundles";

	if (bundlesActuales?.Count > 0)
	{
		if (bundlesActuales.Count == 1)
		{
			titulo = string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String16", "Bundle"), bundlesActuales.Count.ToString());
		}
		else if (bundlesActuales.Count > 1)
		{
			titulo = string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String17", "Bundle"), bundlesActuales.Count.ToString());
		}

		foreach (var bundleActual in bundlesActuales)
		{
			if (string.IsNullOrEmpty(bundleActual.Tienda) == false)
			{
				if (keywords.Contains(bundleActual.Tienda.ToLower()) == false)
				{
					keywords = keywords + ", " + bundleActual.Tienda.ToLower();
				}
			}
		}
	}
	else
	{
		titulo = Herramientas.Idiomas.BuscarTexto(idioma, "String18", "Bundle");
	}

	string contenidoJson = @"{
        ""@context"": ""https://schema.org"",
		""@type"": ""ItemList"",
		""name"": ""PC Game Bundles"",
		""numberOfItems"": ""@cantidad"",
        ""itemListOrder"": ""Descending""
	";

	contenidoJson = contenidoJson.Replace("@cantidad", (bundlesActuales?.Count > 0 ? bundlesActuales?.Count : 0).ToString());

	if (bundlesActuales?.Count > 0)
	{
		contenidoJson = contenidoJson + @",
			""itemListElement"": [";

		int i = 0;
		while (i < bundlesActuales?.Count)
		{
			if (i != 0)
			{
				contenidoJson = contenidoJson + ",";
			}

			contenidoJson = contenidoJson + @"{
				""@type"": ""ListItem"",
				""position"": ""@posicion"",
				""name"": ""@nombre"",
				""url"": ""@enlace"",
				""image"": ""@imagen""
			}";

			contenidoJson = contenidoJson.Replace("@posicion", (i + 1).ToString());
			contenidoJson = contenidoJson.Replace("@nombre", bundlesActuales[i].Nombre);
			contenidoJson = contenidoJson.Replace("@enlace", "https://" + dominio + "/bundle/" + bundlesActuales[i].Id.ToString() + "/" + Herramientas.EnlaceAdaptador.Nombre(bundlesActuales[i].Nombre) + "/");
			contenidoJson = contenidoJson.Replace("@imagen", bundlesActuales[i].Imagen);

			i += 1;
		}

		contenidoJson = contenidoJson + "]";
	}

	contenidoJson = contenidoJson + @"
			}";

	<Titulo tipo="@Titulo.Tipo.Bundles" idioma="@idioma" dominio="@dominio" tituloBundles="@titulo" keywords="@keywords" contenidoJsonBundles="@contenidoJson" />
}

<script>
	function enseñarTooltip(e, id) {
		var x = e.clientX,
			y = e.clientY;

		var tooltip = document.getElementById(id);

		if (screen.width / 2 > x) {
			tooltip.style.top = (y + 10) + 'px';
			tooltip.style.left = (x + 20) + 'px';
		}
		else {
			tooltip.style.top = (y - 10) + 'px';
			tooltip.style.left = (x - 20 - tooltip.getBoundingClientRect().width) + 'px';
		};
	}
</script>

<script>
	function moverScroll(id) {
		const yOffset = -90;
		const element = document.getElementById(id);
		const y = element.getBoundingClientRect().top + window.pageYOffset + yOffset;

		window.scrollTo({ top: y, behavior: 'smooth' });
	}
</script>

<script>
	window.ChangeUrl = function (url) {
		history.pushState(null, '', url);
	}
</script>

<style>
	.bundles-grid {
		gap: 40px;
	}

	@@media (max-width: 800px) {
		.bundles-grid {
			gap: 20px;
		}
	}
</style>

<style>
	:root {
		--glaseadoBorde: #FFFFFF1A;
		--glaseadoFondo: rgba(45, 47, 54, 0.70);
		--noResultados: rgba(132, 32, 41, 0.5);
		--botonSeleccionado: rgba(13, 22, 33, 0.75);
	}

	.caja-bundles {
		box-shadow: 0 22px 34px 0 rgba(0, 0, 0, 0.25);
		background-blend-mode: overlay;
		border-radius: 100px;
		border: 2px solid var(--glaseadoBorde);
		width: fit-content;
		background-color: var(--fondoSubcabecera);
		backdrop-filter: blur(25px);
		display: flex;
		align-items: center;
		gap: 20px;
		padding: 5px;
	}

	.caja-bundles-animacion {
		opacity: 0;
		transition: all 0.5s ease, transform .2s ease;
		pointer-events: none;
		transform: scaleX(0);
		transform-origin: left;
		max-width: 0;
	}

		.caja-bundles-animacion.visible {
			opacity: 1;
			pointer-events: auto;
			transform: scaleX(1);
			max-width: fit-content;
		}

	.boton-bundles {
		backdrop-filter: brightness(100%);
		transition: backdrop-filter 0.2s ease;
	}

		.boton-bundles:hover {
			backdrop-filter: brightness(50%);
		}
</style>

<style>
	.caja-archivo-contenido {
		background-color: var(--fondoSubsubcabecera);
		box-shadow: 0px 4px 8px 0px rgba(0, 0, 0, 0.28),0px 0px 2px 0px rgba(0, 0, 0, 0.24);
		border: 1px solid var(--glaseadoBorde);
		border-radius: 20px;
	}

	.caja-archivo-titulo {
		background: color-mix(in srgb, var(--fondoSubcabecera) 45%, var(--fondoBotonPequeño));
		padding: 20px 30px;
		border-top-left-radius: inherit;
		border-top-right-radius: inherit;
	}
</style>

@if (mostrarBundleSeleccionado == false)
{
	<div style="display: flex; align-items: center; justify-content: center; margin-top: 40px; transition: transform 0.3s ease, opacity 0.3s ease; flex-wrap: wrap;">
		<div class="caja-bundles">
			<button @onclick="@(e => CambiarTipo(e, Bundles2.BundleTipo.Desconocido, false))" class="boton-bundles" style="@CambiarEstilo(Bundles2.BundleTipo.Desconocido, false) border: 0px; height: 50px; padding: 15px 25px; display: inline-flex; align-items: center; color: var(--colorTexto); border-radius: inherit;">
				<div>
					<h1 style="font-size: 16px; margin: 0px;">
						@Herramientas.Idiomas.BuscarTexto(idioma, "Title", "Bundle")
					</h1>
				</div>
			</button>

			@if (tiposActuales.Count > 0 && mostrarArchivo == false && Herramientas.Bots.UserAgentEsBot(userAgent) == false)
			{
				foreach (var tipo in tiposActuales)
				{
					if (tipo != Bundles2.BundleTipo.Desconocido)
					{
						<button @onclick="@(e => CambiarTipo(e, tipo, false))" class="boton-bundles" style="@CambiarEstilo(tipo, false) border: 0px; height: 50px; padding: 15px 25px; display: inline-flex; align-items: center; color: var(--colorTexto); border-radius: inherit;">
							<img src="@Bundles2.BundlesCargar.DevolverBundle(tipo).ImagenIcono" style="width: 20px; height: 20px;" alt="@Bundles2.BundlesCargar.DevolverBundle(tipo).Nombre" />
						</button>
					}
				}
			}
		</div>

		@if (mostrarArchivo == false)
		{
			<div class="tooltip-juego" onmousemove="enseñarTooltip(event, 'tooltip-bundles-order')">
				<button @onclick="MostrarOcultarOrdenar" style="background: transparent; border: 0px; margin-left: 35px;">
					<div style="width: 24px; height: 24px;">
						<svg class="svg-boton" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
							<path d="M130.4 268.2C135.4 280.2 147 288 160 288L480 288C492.9 288 504.6 280.2 509.6 268.2C514.6 256.2 511.8 242.5 502.7 233.3L342.7 73.3C330.2 60.8 309.9 60.8 297.4 73.3L137.4 233.3C128.2 242.5 125.5 256.2 130.5 268.2zM130.4 371.7C125.4 383.7 128.2 397.4 137.3 406.6L297.3 566.6C309.8 579.1 330.1 579.1 342.6 566.6L502.6 406.6C511.8 397.4 514.5 383.7 509.5 371.7C504.5 359.7 492.9 352 480 352L160 352C147.1 352 135.4 359.8 130.4 371.8z" />
						</svg>
					</div>
				</button>

				<div id="tooltip-bundles-order" class="tooltip-relleno">
					<div style="margin: 8px; max-width: 300px; font-size: 14px;">
						@Herramientas.Idiomas.BuscarTexto(idioma, "String29", "Bundle")
					</div>
				</div>
			</div>
		}
		
		<div class="tooltip-juego" onmousemove="enseñarTooltip(event, 'tooltip-bundles-archive')">
			<button @onclick="@(e => CambiarTipo(e, Bundles2.BundleTipo.Desconocido, true))" style="@CambiarEstilo(Bundles2.BundleTipo.Desconocido, true) border: 0px; @(mostrarArchivo ? "margin-left: 35px;" : "margin-left: 25px;") padding: 10px 15px; border-radius: 10px; display: flex; align-items: center; gap: 10px;">
				<div style="width: 24px; height: 24px;">
					<svg class="svg-boton" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
						<path d="M64 128C64 110.3 78.3 96 96 96L544 96C561.7 96 576 110.3 576 128L576 160C576 177.7 561.7 192 544 192L96 192C78.3 192 64 177.7 64 160L64 128zM96 240L544 240L544 480C544 515.3 515.3 544 480 544L160 544C124.7 544 96 515.3 96 480L96 240zM248 304C234.7 304 224 314.7 224 328C224 341.3 234.7 352 248 352L392 352C405.3 352 416 341.3 416 328C416 314.7 405.3 304 392 304L248 304z" />
					</svg>
				</div>

				@if (mostrarArchivo == true)
				{
					<div style="color: var(--colorTexto);">
						@Herramientas.Idiomas.BuscarTexto(idioma, "String2", "Bundle")
					</div>
				}
			</button>

			<div id="tooltip-bundles-archive" class="tooltip-relleno">
				<div style="margin: 8px; max-width: 300px; font-size: 14px;">
					@Herramientas.Idiomas.BuscarTexto(idioma, "String2", "Bundle")
				</div>
			</div>
		</div>
	</div>

	@if (mostrarArchivo == false)
	{
		<div class="bundles-grid caja-archivo-contenido cuerpo-ancho" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; justify-items: center; margin-top: 40px; margin-bottom: 40px; padding: 30px;">
			@if (bundlesActuales?.Count > 0)
			{
				foreach (var bundle in bundlesActuales)
				{
					<button @onclick="@(e => SeleccionarBundle(e, bundle))" class="boton-pequeño" style="padding: 0px;">
						<div style="width: 100%; text-align: center; padding: 2px; height: 100%; display: flex; flex-direction: column; gap: 10px;">
							@if (bundle.BundleTipo == Bundles2.BundleTipo.HumbleBundle)
							{
								<img src="@Herramientas.Ficheros.Imagenes.ServidorExterno(bundle.ImagenNoticia, 395, 222)" style="max-width: 100%; height: 100%; object-fit: cover;" alt="@bundle.Nombre" />
							}
							else
							{
								<img src="@Herramientas.Ficheros.Imagenes.ServidorExterno(bundle.Imagen, 395, 222)" style="max-width: 100%; height: 100%; object-fit: cover;" alt="@bundle.Nombre" />
							}

							<div style="margin-top: auto; margin-bottom: 5px; text-align: center;">
								@MostrarFecha(bundle.FechaEmpieza, bundle.FechaTermina)
							</div>
						</div>
					</button>
				}
			}
		</div>
	}
	else
	{
		<div class="caja-archivo-contenido cuerpo-ancho" style="margin-top: 40px; margin-bottom: 40px; padding: 20px;">
			<div style="display: flex; align-items: start; gap: 15px; flex-wrap: wrap;">
				@foreach (var año in años)
				{
					<div>
						<button @onclick="@(e => CambiarAño(e, año))" class="boton-pequeño" style="padding: 6px 10px; width: fit-content;">
							@año
						</button>

						@if (añoSeleccionado == año)
						{
							<div style="background: var(--colorTexto); padding: 2px;" />
						}
					</div>
				}
			</div>

			@if (string.IsNullOrEmpty(añoSeleccionado) == false)
			{
				<hr />

				<div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
					<div style="padding: 6px 10px;">
						@añoSeleccionado:
					</div>

					@foreach (var bundleTipo in Bundles2.BundlesCargar.CargarBundles())
					{
						List<Bundles2.Bundle> bundlesAño = new List<Bundles2.Bundle>();

						if (bundlesPasados?.Count > 0)
						{
							foreach (var bundlePasado in bundlesPasados)
							{
								if (bundlePasado.FechaEmpieza.Year.ToString() == añoSeleccionado && bundleTipo == bundlePasado.BundleTipo)
								{
									bundlesAño.Add(bundlePasado);
								}
							}
						}

						if (bundlesAño.Count > 0)
						{
							<div>
								<a onclick="moverScroll('pasado-@bundleTipo.ToString()')" class="boton-pequeño" style="color: var(--colorTexto); text-decoration: none; cursor: pointer; padding: 6px 10px;">
									<div style="display: flex; align-items: center; gap: 10px;">
										<img src="@Herramientas.Ficheros.Imagenes.ServidorExterno(Bundles2.BundlesCargar.DevolverBundle(bundleTipo).ImagenIcono)" style="width: 22px; height: 22px;" alt="@Bundles2.BundlesCargar.DevolverBundle(bundleTipo).Tienda" />

										<div style="font-size: 14px;">
											@bundlesAño.Count.ToString()
										</div>
									</div>
								</a>
							</div>
						}
					}
				</div>
			}
		</div>

		@if (string.IsNullOrEmpty(añoSeleccionado) == false)
		{
			<div class="cuerpo-ancho" style="display: flex; flex-direction: column; gap: 40px; margin-top: 40px; margin-bottom: 40px;">
				@foreach (var bundleTipo in Bundles2.BundlesCargar.CargarBundles())
				{
					List<Bundles2.Bundle> bundlesAño = new List<Bundles2.Bundle>();

					if (bundlesPasados?.Count > 0)
					{
						foreach (var bundlePasado in bundlesPasados)
						{
							if (bundlePasado.FechaEmpieza.Year.ToString() == añoSeleccionado && bundleTipo == bundlePasado.BundleTipo)
							{
								bundlesAño.Add(bundlePasado);
							}
						}
					}

					if (bundlesAño.Count > 0)
					{
						<div class="caja-archivo-contenido">
							<div id="pasado-@bundleTipo.ToString()" class="caja-archivo-titulo">
								<img src="@Herramientas.Ficheros.Imagenes.ServidorExterno(Bundles2.BundlesCargar.DevolverBundle(bundleTipo).ImagenTienda)" alt="@Bundles2.BundlesCargar.DevolverBundle(bundleTipo).Tienda" style="max-width: 150px; max-height: 70px; object-fit: contain;" />
							</div>

							<div style="padding: 30px; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; justify-content: flex-start;">
								@{
									int i = 1;
									while (i < 13)
									{
										List<Bundles2.Bundle> bundlesMensual = new List<Bundles2.Bundle>();

										foreach (var bundle in bundlesAño)
										{
											if (bundle.FechaEmpieza.Month == i)
											{
												bundlesMensual.Add(bundle);
											}
										}

										if (bundlesMensual.Count > 0)
										{
											bundlesMensual = bundlesMensual.OrderBy(x => x.Nombre).ToList();

											<div>
												<label>@Herramientas.Idiomas.BuscarTexto(idioma, "Month." + i.ToString(), "Months") (@bundlesMensual.Count.ToString())</label>

												<ul>
													@foreach (var bundleMensual in bundlesMensual)
													{
														<li style="margin-bottom: 5px;">
															<a @onclick="@(e => SeleccionarBundle(e, bundleMensual))" class="enlace-falso">
																@bundleMensual.Nombre
															</a>
														</li>
													}
												</ul>
											</div>
										}

										i += 1;
									}
								}
							</div>
						</div>
					}
				}
			</div>
		}
	}
}
else
{
	if (bundleSeleccionado != null)
	{
		<div class="cuerpo-ancho" style="background-color: var(--fondoSubcabecera); border: 2px solid var(--glaseadoBorde); border-top-left-radius: 20px; border-top-right-radius: 20px; margin-top: 40px;">
			<div style="display: flex; align-items: center; gap: 30px; flex-wrap: nowrap; padding: 30px 40px;">
				<button @onclick="@(e => CerrarBundle(e))" class="boton-pequeño" style="width: fit-content; padding: 10px 15px;">
					<div style="max-width: 24px; max-height: 24px;">
						<svg class="svg-boton" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
							<path d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.2 288 416 288c17.7 0 32-14.3 32-32s-14.3-32-32-32l-306.7 0L214.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z" />
						</svg>
					</div>
				</button>
				
				<div>
					<img src="@Bundles2.BundlesCargar.DevolverBundle(bundleSeleccionado.BundleTipo).ImagenIcono" style="max-width: 30px; max-height: 30px;" alt="Icon" />
				</div>

				<h1 style="font-size: 20px; margin: 0px; line-height: 30px;">
					@bundleSeleccionado.Nombre
				</h1>

				<div style="margin-left: auto; display: flex; justify-content: right;">
					@MostrarFecha(bundleSeleccionado.FechaEmpieza, bundleSeleccionado.FechaTermina)
				</div>
			</div>
		</div>

		if (DateTime.Now < bundleSeleccionado.FechaTermina)
		{
			string enlaceBundle = bundleSeleccionado.Enlace;

			if (Herramientas.Bots.UserAgentEsBot(userAgent) == false)
			{
				enlaceBundle = Herramientas.EnlaceAcortador.Generar(bundleSeleccionado.Enlace, bundleSeleccionado.BundleTipo, usuarioPatreon, false);
			}

			<div class="cuerpo-ancho" style="position: sticky; top: var(--alturaCabecera); z-index: 1000;">
				<a href="@enlaceBundle" target="_blank" class="boton-pequeño" style="text-align: center; padding: 20px; font-size: 20px; border: 1px solid rgba(0,255,255,0.15);">
					@Herramientas.Idiomas.BuscarTexto(idioma, "String3", "Bundle")
				</a>
			</div>
		}

		<Bundle bundleId="@bundleSeleccionado.Id" tipo="@Bundle.Tipo.Bundles" />
	}
}

@if (mostrarOrdenar == true)
{
	<div class="opciones-panel">
		<div style="max-width: 500px; width: 100%; background-color: var(--fondoSubcabecera); border: 2px solid var(--fondoSubcabecera); margin: 20px auto; overflow-y: scroll; position: relative; justify-content: center; scrollbar-color: var(--fondoCodigo) var(--fondoOscuro); border-radius: 20px; box-shadow: 0px 4px 8px 0px rgba(0, 0, 0, 0.28),0px 0px 2px 0px rgba(0, 0, 0, 0.24);">
			<div style="display: flex; align-items: center; gap: 30px; padding: 20px 30px; background: color-mix(in srgb, var(--fondoSubcabecera) 55%, var(--fondoBotonPequeño)); justify-content: center;">
				<button class="boton-pequeño" @onclick="MostrarOcultarOrdenar" style="width: fit-content; padding: 10px 15px; position: absolute; left: 30px;">
					<div style="max-width: 24px; max-height: 24px;">
						<svg class="svg-icono" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
							<path d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.2 288 416 288c17.7 0 32-14.3 32-32s-14.3-32-32-32l-306.7 0L214.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z" />
						</svg>
					</div>
				</button>

				<div style="font-size: 20px;">
					@Herramientas.Idiomas.BuscarTexto(idioma, "String29", "Bundle")
				</div>
			</div>

			<div style="padding: 30px; display: flex; flex-direction: column; gap: 20px;">
				<button class="boton-pequeño" style="padding: 15px 25px; text-align: center;" @onclick="@(e => ElegirOrdenamiento(e, 0))">
					@Herramientas.Idiomas.BuscarTexto(idioma, "String30", "Bundle")
				</button>
				<button class="boton-pequeño" style="padding: 15px 25px; text-align: center;" @onclick="@(e => ElegirOrdenamiento(e, 1))">
					@Herramientas.Idiomas.BuscarTexto(idioma, "String31", "Bundle")
				</button>
				<button class="boton-pequeño" style="padding: 15px 25px; text-align: center;" @onclick="@(e => ElegirOrdenamiento(e, 2))">
					@Herramientas.Idiomas.BuscarTexto(idioma, "String32", "Bundle")
				</button>
				<button class="boton-pequeño" style="padding: 15px 25px; text-align: center;" @onclick="@(e => ElegirOrdenamiento(e, 3))">
					@Herramientas.Idiomas.BuscarTexto(idioma, "String33", "Bundle")
				</button>
			</div>
		</div>
	</div>
}

@code {

	#nullable disable

	private string idioma = "en";
	private string usuarioId = null;
	private string userAgent = null;
	private string dominio = null;

	private bool usuarioPatreon = false;
	private bool usuarioAdmin = false;

	[PersistentState] public List<Bundles2.Bundle> bundlesActuales { get; set; }
	[PersistentState] public List<Bundles2.Bundle> bundlesPasados { get; set; }
	private Bundles2.Bundle bundleSeleccionado = new Bundles2.Bundle();
	private bool mostrarBundleSeleccionado = false;

	[Parameter]
	public string bundleSeleccionadoTexto { get; set; }

	private List<string> años = new List<string>();
	private string añoSeleccionado = string.Empty;
	private bool cargadoBundles = false;

	protected override async Task OnInitializedAsync()
	{
		Herramientas.ContextoUsuarioDatos datos = Herramientas.ContextoUsuario.Leer(Contexto);
		idioma = datos.Idioma;
		usuarioId = datos.UsuarioId;
		userAgent = datos.UserAgent;
		dominio = datos.Dominio;

		if (string.IsNullOrEmpty(usuarioId) == false)
		{
			idioma = await BaseDatos.Usuarios.Buscar.IdiomaSobreescribir(usuarioId);
			usuarioPatreon = Herramientas.Patreon.VerificarActivo(await BaseDatos.Usuarios.Buscar.FechaPatreon(usuarioId));
			usuarioAdmin = await BaseDatos.Usuarios.Buscar.RolDios(usuarioId);
		}

		//--------------------------------------------------------------------

		DateTime arranque = new DateTime(2010, 1, 1);

		int i = 0;
		while (i < 100)
		{
			if (arranque.Year != DateTime.Now.Year)
			{
				años.Add(arranque.Year.ToString());
				arranque = arranque.AddYears(1);
			}
			i += 1;
		}

		años.Add(DateTime.Now.Year.ToString());
		años.Reverse();

		//--------------------------------------------------------------------

		int ordenamientoUsuario = 0;

		if (string.IsNullOrEmpty(usuarioId) == false)
		{
			ordenamientoUsuario = await BaseDatos.Usuarios.Buscar.BundlesOrden(usuarioId);
		}

		await CargarBundles(ordenamientoUsuario);

		//--------------------------------------------------------------------

		if (string.IsNullOrEmpty(bundleSeleccionadoTexto) == false)
		{
			foreach (var bundleTipo in Bundles2.BundlesCargar.CargarBundles())
			{
				if (bundleTipo != Bundles2.BundleTipo.Desconocido)
				{
					if (bundleTipo.ToString().ToLower() == bundleSeleccionadoTexto)
					{
						tipoSeleccionado = bundleTipo;
						break;
					}
				}
			}
		}
	}

	protected override async Task OnAfterRenderAsync(bool primerRender)
	{
		if (primerRender == true)
		{
			if (tipoSeleccionado != Bundles2.BundleTipo.Desconocido)
			{
				await CambiarTipo(tipoSeleccionado, false);
			}
		}
	}

	[PersistentState] public string ordenamientoElegido { get; set; }
	[PersistentState] public int ordenamientoNumero2 { get; set; }

	private bool mostrarOrdenar = false;

	private async Task MostrarOcultarOrdenar()
	{
		mostrarOrdenar = !mostrarOrdenar;
	}

	private async void ElegirOrdenamiento(MouseEventArgs e, int nuevoNumero)
	{
		await CargarBundles(nuevoNumero);
	}

	private async Task CargarBundles(int ordenamientoNumero)
	{
		bundlesActuales = await BaseDatos.Bundles.Buscar.Actuales(ordenamientoNumero, tipoSeleccionado);

		cargadoBundles = true;

		if (bundlesActuales?.Count > 0)
		{
			bundleSeleccionado = null;

			foreach (var bundle in bundlesActuales)
			{
				bool añadirTipo = true;

				if (tiposActuales.Count > 0)
				{
					foreach (var tipoActual in tiposActuales)
					{
						if (tipoActual == bundle.BundleTipo)
						{
							añadirTipo = false;
						}
					}
				}

				if (añadirTipo == true)
				{
					tiposActuales.Add(bundle.BundleTipo);
				}
			}
		}

		if (tiposActuales.Count > 0)
		{
			tiposActuales = tiposActuales.OrderBy(x => (int)x).ToList();
		}

		ordenamientoNumero2 = ordenamientoNumero;

		if (ordenamientoNumero == 0)
		{
			ordenamientoElegido = Herramientas.Idiomas.BuscarTexto(idioma, "String30", "Bundle");
		}
		else if (ordenamientoNumero == 1)
		{
			ordenamientoElegido = Herramientas.Idiomas.BuscarTexto(idioma, "String31", "Bundle");
		}
		else if (ordenamientoNumero == 2)
		{
			ordenamientoElegido = Herramientas.Idiomas.BuscarTexto(idioma, "String32", "Bundle");
		}
		else if (ordenamientoNumero == 3)
		{
			ordenamientoElegido = Herramientas.Idiomas.BuscarTexto(idioma, "String33", "Bundle");
		}

		if (string.IsNullOrEmpty(usuarioId) == false)
		{
			await BaseDatos.Usuarios.Actualizar.Opcion("BundlesSort", ordenamientoNumero, usuarioId);
		}
	}

	private Bundles2.BundleTipo tipoSeleccionado = Bundles2.BundleTipo.Desconocido;
	private List<Bundles2.BundleTipo> tiposActuales = new List<Bundles2.BundleTipo>();
	private bool mostrarArchivo = false;

	private async Task CambiarTipo(MouseEventArgs e, Bundles2.BundleTipo nuevoTipo, bool esArchivo)
	{
		await CambiarTipo(nuevoTipo, esArchivo);
	}

	private async Task CambiarTipo(Bundles2.BundleTipo nuevoTipo, bool esArchivo)
	{
		mostrarArchivo = esArchivo;

		if (esArchivo == false)
		{
			tipoSeleccionado = nuevoTipo;
			bundlesActuales = await BaseDatos.Bundles.Buscar.Actuales(ordenamientoNumero2, nuevoTipo);

			if (nuevoTipo != Bundles2.BundleTipo.Desconocido)
			{
				await JavaScript.InvokeVoidAsync("ChangeUrl", "/bundles/" + nuevoTipo.ToString().ToLower() + "/");
			}
			else
			{
				await JavaScript.InvokeVoidAsync("ChangeUrl", "/bundles/");
			}
		}
		else
		{
			añoSeleccionado = DateTime.Now.Year.ToString();
			bundlesPasados = await BaseDatos.Bundles.Buscar.Año(añoSeleccionado);
		}

		await InvokeAsync(StateHasChanged);
	}

	private string CambiarEstilo(Bundles2.BundleTipo nuevoTipo, bool esArchivo)
	{
		if (mostrarArchivo == true && esArchivo == true)
		{
			if (nuevoTipo != Bundles2.BundleTipo.Desconocido)
			{
				return "background-color: transparent;";
			}
			else
			{
				return "background: var(--botonSeleccionado);";
			}
		}
		else
		{
			if (tipoSeleccionado == nuevoTipo && mostrarArchivo == false && esArchivo == false)
			{
				return "background: var(--botonSeleccionado);";
			}
			else
			{
				return "background-color: transparent;";
			}
		}
	}

	#region Archivo

	private async Task CambiarAño(MouseEventArgs e, string nuevoAño)
	{
		añoSeleccionado = nuevoAño;

		bundlesPasados = await BaseDatos.Bundles.Buscar.Año(añoSeleccionado);
	}

	private string MostrarFecha(DateTime fechaEmpieza, DateTime fechaTermina)
	{
		if (fechaTermina.Year > 2022)
		{
			TimeSpan diferenciaTiempo = fechaTermina.Subtract(DateTime.Now);

			if (diferenciaTiempo.Days > 1)
			{
				return string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String4", "Bundle"), diferenciaTiempo.Days);
			}
			else if (diferenciaTiempo.Days == 1)
			{
				return string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String5", "Bundle"), diferenciaTiempo.Days);
			}
			else if (diferenciaTiempo.Days == 0 && diferenciaTiempo.Minutes > 0)
			{
				return string.Format(Herramientas.Idiomas.BuscarTexto(idioma, "String6", "Bundle"), diferenciaTiempo.Days);
			}
		}

		return Herramientas.Idiomas.BuscarTexto(idioma, "String7", "Bundle") + " • " + fechaEmpieza.Day.ToString() + "/" + fechaEmpieza.Month.ToString() + "/" + fechaEmpieza.Year.ToString() + " • " + fechaTermina.Day.ToString() + "/" + fechaTermina.Month.ToString() + "/" + fechaTermina.Year.ToString();
	}

	#endregion

	private async Task SeleccionarBundle(MouseEventArgs e, Bundles2.Bundle nuevoBundle)
	{
		bundleSeleccionado = nuevoBundle;

		foreach (var juego in bundleSeleccionado.Juegos)
		{
			if (string.IsNullOrEmpty(juego.JuegoId) == false)
			{
				juego.Juego = await BaseDatos.Juegos.Buscar.UnJuego(juego.JuegoId);
			}
		}

		mostrarBundleSeleccionado = true;

		await JavaScript.InvokeVoidAsync("moverScroll", "cuerpazo");
		await JavaScript.InvokeVoidAsync("ChangeUrl", "/bundle/" + bundleSeleccionado.Id.ToString() + "/" + Herramientas.EnlaceAdaptador.Nombre(bundleSeleccionado.Nombre) + "/");
	}

	private async void CerrarBundle(MouseEventArgs e)
	{
		mostrarBundleSeleccionado = false;

		await JavaScript.InvokeVoidAsync("moverScroll", "cuerpazo");
		await JavaScript.InvokeVoidAsync("ChangeUrl", "/bundles/");
	}

	private async void AbrirBundle(MouseEventArgs e, string enlace)
	{
		await JavaScript.InvokeVoidAsync("open", enlace, "_blank");
	}
}