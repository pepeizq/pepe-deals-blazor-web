@page "/bundle/{bundleId:int}/{bundleNombre?}/"

@using APIs.Steam
@using Herramientas.Bundles
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.JSInterop
@using Microsoft.VisualBasic
@using pepeizqs_deals_blazor_web.Componentes.Interfaz
@using pepeizqs_deals_web.Data

@inject IHttpContextAccessor Contexto
@inject IJSRuntime JavaScript

@if (bundle != null)
{
	if (tipo == Tipo.Bundle)
	{
		string titulo = bundle.Nombre + " • " + bundle.Tienda;
		string descripcion = string.Empty;
		string enlace = "https://" + dominio + "/bundle/" + bundle.Id.ToString() + "/" + Herramientas.EnlaceAdaptador.Nombre(bundle.Nombre) + "/";
		string imagen = string.Empty;

		if (bundle.Tiers?.Count > 0 && string.IsNullOrEmpty(bundle.Tiers[0].Precio) == false)
		{
			string precio = bundle.Tiers[0].Precio.ToString();
			precio = precio.Replace(".", ",");
			precio = precio.Trim() + "€";

			if (bundle.Pick == false)
			{
				descripcion = Herramientas.Idiomas.BuscarTexto(idioma, "String22", "Bundle") + " " + precio;
			}
			else
			{
				descripcion = Herramientas.Idiomas.BuscarTexto(idioma, "String23", "Bundle") + " " + precio;
			}
		}

		if (string.IsNullOrEmpty(bundle.ImagenNoticia) == false)
		{
			if (bundle.ImagenNoticia.Contains("https://") == true)
			{
				imagen = bundle.ImagenNoticia;
			}
		}

		string[] keywordsEnBruto = Herramientas.Buscador.LimpiarNombre(bundle.Nombre, false).Split(' ');
		List<string> keywordsLista = new List<string>();
		keywordsLista.AddRange(keywordsEnBruto);

		string keywords = "bundle";

		foreach (string keyword in keywordsLista)
		{
			if (keyword.Length > 3)
			{
				keywords = keywords + ", " + keyword;
			}
		}

		if (bundle.Juegos?.Count > 0)
		{
			foreach (var juego in bundle.Juegos)
			{
				if (juego != null)
				{
					if (string.IsNullOrEmpty(juego.Nombre) == false)
					{
						string[] keywordsEnBrutoJuego = Herramientas.Buscador.LimpiarNombre(juego.Nombre, false).Split(' ');
						List<string> keywordsListaJuego = new List<string>();
						keywordsListaJuego.AddRange(keywordsEnBrutoJuego);

						foreach (string keyword in keywordsListaJuego)
						{
							if (keywords.Contains(keyword) == false && keyword.Length > 3)
							{
								keywords = keywords + ", " + keyword;
							}
						}
					}
				}
			}
		}

		string nombreJson = bundle.Nombre.Replace(Strings.ChrW(34).ToString(), null) + " " + bundle.Tienda.Replace(Strings.ChrW(34).ToString(), null);
		string descripcionJson = descripcion.Replace(Strings.ChrW(34).ToString(), null);
		string fechaJson = bundle.FechaEmpieza.ToString("yyyy-MM-dd");
		string estadoJson = "https://schema.org/InStock";

		if (DateTime.Now > bundle.FechaTermina)
		{
			estadoJson = "https://schema.org/Discontinued";
		}

		bundle?.Tiers?.Sort(delegate (Bundles2.BundleTier t1, Bundles2.BundleTier t2)
		{
			return t1.Posicion.CompareTo(t2.Posicion);
		});

		string precioBajoJson = bundle?.Tiers?.First()?.Precio?.ToString() ?? "0";
		string precioAltoJson = bundle?.Tiers?.Last()?.Precio?.ToString() ?? "0";
		int cantidadTiersJson = bundle?.Tiers?.Count ?? 0;

		decimal reseñasMediaJson = 1;
		int reseñasCantidadJson = 10;

		if (bundle?.Juegos?.Count > 0)
		{
			foreach (var juego in bundle.Juegos)
			{
				if (juego.Juego == null)
				{
					juego.Juego = juegosBundlePrecargados.TryGetValue(int.Parse(juego.JuegoId), out var juegoPrecargado) ? juegoPrecargado : null;
				}

				if (juego.Juego != null)
				{
					reseñasMediaJson = (reseñasMediaJson + decimal.Parse(juego.Juego.Analisis.Porcentaje) / 20) / 2;

					if (reseñasMediaJson < 1)
					{
						reseñasMediaJson = 1;
					}

					reseñasCantidadJson = reseñasCantidadJson + int.Parse(juego.Juego.Analisis.Cantidad.Replace(",", null));

					if (reseñasCantidadJson < 10)
					{
						reseñasCantidadJson = 10;
					}
				}
			}
		}

		string contenidoJson = @"{
			""@context"": ""https://schema.org/"",
			""@type"": ""Product"",
			""name"": ""@nombreJson"",
			""description"": ""@descripcionJson"",
			""url"": ""@enlace"",
			""sku"": ""@bundleId"",
			""image"": {
				""@type"": ""ImageObject"",
				""url"": ""@imagen"",
				""contentUrl"": ""@imagen"",
				""name"": ""@nombreJson"",
				""caption"": ""@nombreJson""
			},
			""productionDate"": ""@fechaJson"",
			""offers"": {
				""@type"": ""AggregateOffer"",
				""availability"": ""@estadoJson"",
				""priceCurrency"": ""EUR"",
				""price"": @precioBajoJson,
				""url"": ""@enlace"",
				""offerCount"": @cantidadTiersJson,
				""lowPrice"": @precioBajoJson,
				""highPrice"": @precioAltoJson
			},
			""aggregateRating"": {
				""@type"": ""AggregateRating"",
				""ratingValue"": @reseñasMediaJson,
				""ratingCount"": @reseñasCantidadJson
			}
		}";

		contenidoJson = contenidoJson.Replace("@nombreJson", nombreJson);
		contenidoJson = contenidoJson.Replace("@descripcionJson", descripcionJson);
		contenidoJson = contenidoJson.Replace("@enlace", enlace);
		contenidoJson = contenidoJson.Replace("@bundleId", bundle?.Id.ToString());
		contenidoJson = contenidoJson.Replace("@imagen", imagen);
		contenidoJson = contenidoJson.Replace("@fechaJson", fechaJson);
		contenidoJson = contenidoJson.Replace("@estadoJson", estadoJson);
		contenidoJson = contenidoJson.Replace("@precioBajoJson", precioBajoJson);
		contenidoJson = contenidoJson.Replace("@precioAltoJson", precioAltoJson);
		contenidoJson = contenidoJson.Replace("@cantidadTiersJson", cantidadTiersJson.ToString());
		contenidoJson = contenidoJson.Replace("@reseñasMediaJson", reseñasMediaJson.ToString());
		contenidoJson = contenidoJson.Replace("@reseñasCantidadJson", reseñasCantidadJson.ToString());

		<Titulo tipo="@Titulo.Tipo.Bundle" idioma="@idioma" dominio="@dominio" tituloBundle="@titulo" descripcionBundle="@descripcion" enlaceBundle="@enlace"
				imagenBundle="@imagen" keywords="@keywords" contenidoJsonBundle="@contenidoJson"/>
	}
}

<script>
	window.clipboardCopy = {
		copyText: function(text) {
			navigator.clipboard.writeText(text);
		}
	};
</script>

@if (enseñarAlerta == true)
{
	<div style="width: fit-content; background-color: var(--fondoAlerta); color: var(--colorTexto); padding: 10px 15px; margin: 30px; top: var(--alturaCabecera); left: 0; position: fixed; z-index: 1001; border: 2px solid var(--fondoSubcabecera); box-shadow: 0px 4px 8px 0px rgba(0, 0, 0, 0.28),0px 0px 2px 0px rgba(0, 0, 0, 0.24);">
		<div style="display: flex; align-items: center; gap: 10px;">
			<div>
				@Herramientas.Idiomas.BuscarTexto(idioma, "String2", "Clipboard")
			</div>

			<button @onclick="CerrarAvisoClipboard" class="boton-pequeño" style="display: flex; padding: 0px; background-color: transparent; width: fit-content; box-shadow: none;">
				<div style="width: 20px; height: 20px;">
					<svg class="svg-boton" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
						<path d="M183.1 137.4C170.6 124.9 150.3 124.9 137.8 137.4C125.3 149.9 125.3 170.2 137.8 182.7L275.2 320L137.9 457.4C125.4 469.9 125.4 490.2 137.9 502.7C150.4 515.2 170.7 515.2 183.2 502.7L320.5 365.3L457.9 502.6C470.4 515.1 490.7 515.1 503.2 502.6C515.7 490.1 515.7 469.8 503.2 457.3L365.8 320L503.1 182.6C515.6 170.1 515.6 149.8 503.1 137.3C490.6 124.8 470.3 124.8 457.8 137.3L320.5 274.7L183.1 137.4z" />
					</svg>
				</div>
			</button>
		</div>
	</div>
}

<script>
	window.ChangeUrl = function (url) {
		history.pushState(null, '', url);
	}
</script>

<style>
	.bundle-tabla {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
		grid-gap: 30px;
	}

	.bundle-espacio {
		padding: 30px;
	}

	.bundle-espacio2 {
		gap: 40px;
	}

	.bundle-espacio3 {
		padding: 15px 30px;
	}

	@@media (max-width: 900px) {
		.bundle-tabla {
			grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
			grid-gap: 10px;
		}

		.bundle-espacio {
			padding: 10px;
		}

		.bundle-espacio2 {
			gap: 20px;
		}

		.bundle-espacio3 {
			padding: 10px 20px;
		}
	}
</style>

<style>
	.caja-bundle-contenido {
		background-color: var(--fondoSubsubcabecera);
		box-shadow: 0px 4px 8px 0px rgba(0, 0, 0, 0.28),0px 0px 2px 0px rgba(0, 0, 0, 0.24);
	}

	.caja-bundle-mensaje {
		background: color-mix(in srgb, var(--fondoSubcabecera) 45%, var(--fondoBotonPequeño));
		border: 1px solid var(--fondoSubsubcabecera);
		box-shadow: 0px 4px 8px 0px rgba(0, 0, 0, 0.28),0px 0px 2px 0px rgba(0, 0, 0, 0.24);
	}
</style>

@if (bundle != null)
{
	if (tipo == Tipo.Bundle)
	{
		if (usuarioAdmin == true)
		{
			<pepeizqs_deals_blazor_web.Componentes.Admin.Bundle idioma="@idioma" bundleId="@bundle.Id" />
		}

		<div class="subcabecera">
			<div class="cuerpo-ancho sub-subcabecera">
				<div style="height: 40px; padding: 0px 20px;">
					<img src="@Herramientas.Ficheros.Imagenes.ServidorExterno(Bundles2.BundlesCargar.DevolverBundle(bundle.BundleTipo).ImagenTienda)" style="height: 100%;" alt="@bundle.Nombre" />
				</div>

				<h1 style="font-size: 18px; padding: 0px 20px; margin: 0px;">
					@bundle.Nombre
				</h1>

				<div style="font-size: 16px; padding: 0px 20px; margin-left: auto;">
					@bundle.FechaEmpieza.Day.ToString()/@bundle.FechaEmpieza.Month.ToString()/@bundle.FechaEmpieza.Year.ToString() • @bundle.FechaTermina.Day.ToString()/@bundle.FechaTermina.Month.ToString()/@bundle.FechaTermina.Year.ToString()
				</div>
			</div>
        </div>

		@if (DateTime.Now < bundle.FechaTermina)
		{
            string enlaceBundle = bundle.Enlace;

			if (Herramientas.Bots.UserAgentEsBot(userAgent) == false)
			{
				enlaceBundle = Herramientas.EnlaceAcortador.Generar(bundle.Enlace, bundle.BundleTipo, usuarioPatreon, false);
			}

			<div class="cuerpo-ancho" style="position: sticky; top: var(--alturaCabecera); z-index: 1000;">
				<a href="@enlaceBundle" target="_blank" class="boton-pequeño" style="text-align: center; padding: 20px; font-size: 20px; border: 1px solid rgba(0,255,255,0.15);">
					@Herramientas.Idiomas.BuscarTexto(idioma, "String26", "Bundle")
				</a>
			</div>
		}
	}

	if (tipo == Tipo.Noticia)
	{
		string enlaceBundle = bundle.Enlace;

		if (Herramientas.Bots.UserAgentEsBot(userAgent) == false)
		{
			enlaceBundle = Herramientas.EnlaceAcortador.Generar(bundle.Enlace, bundle.BundleTipo, usuarioPatreon, false);
		}

		<div class="cuerpo-ancho" style="position: sticky; top: var(--alturaCabecera); z-index: 1000; width: 100%;">
			<a href="@enlaceBundle" target="_blank" class="boton-pequeño" style="text-align: center; padding: 20px; font-size: 20px; border: 1px solid rgba(0,255,255,0.15);">
				@Herramientas.Idiomas.BuscarTexto(idioma, "String26", "Bundle")
			</a>
		</div>
	}

	if (bundle.Tiers != null)
	{
		decimal totalMinimos = 0;
		string marginBundle = "margin: 40px 0px;";

		if (tipo == Tipo.Noticia || tipo == Tipo.Juego)
		{
			marginBundle = "margin: 40px 0px 0px 0px;";
		}

		<div style="@marginBundle">
			@if (bundle.Tiers.Count > 0)
			{
				int i = 0;

				foreach (var tier in OrdenarTiers(bundle.Tiers))
				{
					string marginFinal = string.Empty;

					if (tier.Posicion != bundle.Tiers.Count && bundle.Pick == false)
					{
						marginFinal = "margin-bottom: 40px;";

						if (tipo == Tipo.Juego)
						{
							marginFinal = "margin-bottom: 20px;";
						}
					}

					List<Bundles2.BundleJuego> juegosTier = new List<Bundles2.BundleJuego>();

					if (bundle.Juegos?.Count > 0)
					{
						foreach (var juego in bundle.Juegos)
						{
							if (juego.Tier != null)
							{
								if (juego.Tier.Posicion == tier.Posicion)
								{
									juegosTier.Add(juego);
								}
							}
						}
					}

					if (juegosTier?.Count > 0)
					{
						juegosTier = juegosTier.OrderBy(x => x.Nombre).ToList();

						foreach (var juego in juegosTier)
						{
							if (juego.Juego?.Tipo == Juegos.JuegoTipo.DLC)
							{
								if (string.IsNullOrEmpty(juego.Juego?.Maestro) == false)
								{
									if (juego.Juego?.Maestro != "no")
									{
										foreach (var juego2 in juegosTier)
										{
											if (juego2.JuegoId == juego.Juego?.Maestro)
											{
												if (juego2.DLCs == null)
												{
													juego2.DLCs = new List<string>();
												}

												bool añadir = true;

												if (juego2.DLCs.Count > 0)
												{
													foreach (var dlc in juego2.DLCs)
													{
														if (dlc == juego.JuegoId)
														{
															añadir = false;
															break;
														}
													}
												}

												if (añadir == true)
												{
													juego2.DLCs.Add(juego.JuegoId);
												}
											}
										}
									}
								}
							}
						}

						if (bundle.Pick == true)
						{
							<div class="caja-bundle-contenido cuerpo-ancho bundle-espacio bundle-espacio2" style="border-radius: 0px; font-size: 18px; display: flex; align-items: center; flex-direction: row; justify-content: center; margin-bottom: 30px;">
								@foreach (var tier2 in OrdenarTiers(bundle.Tiers))
								{
									<div class="caja-bundle-mensaje bundle-espacio3" style="text-align: center; display: flex; align-items: center; gap: 5px;">
										@if (tier2.CantidadJuegos == 1)
										{
											<label>@tier2.CantidadJuegos.ToString() @Herramientas.Idiomas.BuscarTexto(idioma, "String21", "Bundle") • @Herramientas.Precios.Euro(decimal.Parse(tier2.Precio))</label>
										}
										else if (tier2.CantidadJuegos > 1)
										{
											<label>@tier2.CantidadJuegos.ToString() @Herramientas.Idiomas.BuscarTexto(idioma, "String8", "Bundle") • @Herramientas.Precios.Euro(decimal.Parse(tier2.Precio))</label>
											<label>/</label>
											<label style="font-size: 14px;">@Herramientas.Precios.Euro(decimal.Parse(tier2.Precio) / tier2.CantidadJuegos) (@Herramientas.Idiomas.BuscarTexto(idioma, "String20", "Bundle"))</label>
										}
									</div>
								}
							</div>
						}

						string espacioFondo = "margin-bottom: 40px;";

						if (i == bundle.Tiers.Count - 1 || bundle.Pick == true )
						{
							espacioFondo = string.Empty;
						}

						<div class="caja-bundle-contenido cuerpo-ancho bundle-espacio" style="@espacioFondo">
							@if (bundle.Pick == false)
							{
								<div class="caja-bundle-mensaje" style="font-size: 18px; padding: 20px; margin-bottom: 30px;">
									<div style="margin-bottom: 5px;">
										Tier @tier.Posicion: @Herramientas.Precios.Euro(decimal.Parse(tier.Precio))
									</div>

									@foreach (var juego in juegosTier)
									{
										if (juego.Juego?.PrecioMinimosHistoricos != null)
										{
											foreach (var historico in juego.Juego.PrecioMinimosHistoricos)
											{
												if (historico.DRM == juego.DRM)
												{
													if (historico.PrecioCambiado > 0)
													{
														totalMinimos = totalMinimos + historico.PrecioCambiado;
													}
													else
													{
														totalMinimos = totalMinimos + historico.Precio;
													}

													break;
												}
											}
										}
									}

									<div style="font-size: 14px;">
										@Herramientas.Idiomas.BuscarTexto(idioma, "String14", "Bundle"): @Herramientas.Precios.Euro(totalMinimos)
									</div>
								</div>
							}

							<div class="bundle-tabla">
								@foreach (var juego in juegosTier)
								{
									bool mostrar = true;

									if (juego.Juego?.Tipo == Juegos.JuegoTipo.DLC)
									{
										if (string.IsNullOrEmpty(juego.Juego.Maestro) == false)
										{
											if (juego.Juego.Maestro != "no")
											{
												foreach (var juego2 in juegosTier)
												{
													if (juego2.JuegoId == juego.Juego.Maestro)
													{
														mostrar = false;
													}
												}
											}
										}
									}

									if (mostrar == true)
									{
										<CajaJuego idioma="@idioma" juego="juego.Juego" drmBundle="juego.DRM" dlcsBundle="juego.DLCs" juegosUsuario="@juegosUsuario" idBundle="@bundleId"
												   tipo="Interfaz.CajaJuego.Tipo.Bundle" usuarioDeseadosSteam="@deseadosUsuario?.SteamWishlist" usuarioDeseadosGog="@deseadosUsuario?.GogWishlist" usuarioDeseadosWeb="@deseadosUsuario?.Wishlist" userAgent="@userAgent" />
									}
								}
							</div>
						</div>

						if (bundle.Pick == true)
						{
							break;
						}
					}

					i += 1;
				}
			}

			@if (bundle.FechaTermina > DateTime.Now)
			{
				if (tipo == Tipo.Bundle || tipo == Tipo.Bundles || tipo == Tipo.Noticia)
				{
					<div class="caja-bundle-contenido cuerpo-ancho" style="margin-top: 40px; width: 100%;">
						<div class="caja-bundle-mensaje" style="padding: 20px;">
							@Herramientas.Idiomas.BuscarTexto(idioma, "String34", "Bundle")
						</div>

						<div style="padding: 20px; display: flex; flex-direction: column; gap: 20px;">
							<div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
								<button @onclick="GenerarBBCode" class="boton-pequeño" style="width: fit-content; padding: 10px 30px;">
									<div style="display: flex; flex-direction: column; gap: 10px; text-align: center;">
										BBCode
									</div>
								</button>

								<button @onclick="GenerarReddit" class="boton-pequeño" style="width: fit-content; padding: 10px 30px;">
									<div style="display: flex; flex-direction: column; gap: 10px; text-align: center;">
										Reddit
									</div>
								</button>

								<button @onclick="GenerarMarkdown" class="boton-pequeño" style="width: fit-content; padding: 10px 30px;">
									<div style="display: flex; flex-direction: column; gap: 10px; text-align: center;">
										Markdown
									</div>
								</button>
							</div>

							@if (string.IsNullOrEmpty(contenidoCajaClipboard) == false)
							{
								<div style="display: flex; flex-direction: column; gap: 20px;">
									<div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
										<button @onclick="CopiarAlClipboard" class="boton-pequeño" style="width: fit-content; padding: 5px 10px;">
											<div style="width: 22px; height: 22px; display: flex;">
												<svg style="fill: var(--colorTexto);" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
													<path d="M480 400L288 400C279.2 400 272 392.8 272 384L272 128C272 119.2 279.2 112 288 112L421.5 112C425.7 112 429.8 113.7 432.8 116.7L491.3 175.2C494.3 178.2 496 182.3 496 186.5L496 384C496 392.8 488.8 400 480 400zM288 448L480 448C515.3 448 544 419.3 544 384L544 186.5C544 169.5 537.3 153.2 525.3 141.2L466.7 82.7C454.7 70.7 438.5 64 421.5 64L288 64C252.7 64 224 92.7 224 128L224 384C224 419.3 252.7 448 288 448zM160 192C124.7 192 96 220.7 96 256L96 512C96 547.3 124.7 576 160 576L352 576C387.3 576 416 547.3 416 512L416 496L368 496L368 512C368 520.8 360.8 528 352 528L160 528C151.2 528 144 520.8 144 512L144 256C144 247.2 151.2 240 160 240L176 240L176 192L160 192z" />
												</svg>
											</div>
										</button>
									</div>

									<textarea class="entrada-texto" rows="8">
									@contenidoCajaClipboard
								</textarea>
								</div>
							}
						</div>
					</div>

					if (bundle.Pick == false)
					{
						<div class="caja-bundle-contenido cuerpo-ancho" style="margin-top: 40px; width: 100%;">
							<div class="caja-bundle-mensaje" style="padding: 20px;">
								@Herramientas.Idiomas.BuscarTexto(idioma, "String35", "Bundle")
							</div>

							<div style="padding: 20px; display: flex; flex-direction: column; gap: 20px;">
								@if (valoraciones == null)
								{
									<button @onclick="GenerarValoraciones" class="boton-pequeño" style="width: fit-content; padding: 10px 30px;">
										<div style="display: flex; flex-direction: column; gap: 10px; text-align: center;">
											@Herramientas.Idiomas.BuscarTexto(idioma, "String36", "Bundle")
										</div>
									</button>
								}
								else
								{
									if (valoraciones.Count > 0)
									{
										valoraciones = valoraciones.OrderBy(v => v.Nombre).ToList();

										foreach (var valoracion in valoraciones)
										{
											<div>
												@valoracion.Nombre (@Herramientas.Precios.Euro(valoracion.Valoracion))
											</div>
										}
									}
								}
							</div>
						</div>
					}
				}
			}
		</div>
	}
}

@code {

	#nullable disable

	private string idioma = "en";
	private string usuarioId = null;
	private string userAgent = null;
	private string dominio = null;

	[PersistentState] public Herramientas.UsuarioListadosJuegos juegosUsuario { get; set; }
	[PersistentState] public Usuario deseadosUsuario { get; set; }
	private bool usuarioPatreon = false;
	private bool usuarioAdmin = false;

	[Parameter]
	public int bundleId { get; set; }

	[Parameter]
	public string bundleNombre { get; set; }

	[Parameter]
	public Tipo tipo { get; set; } = Tipo.Bundle;

	[PersistentState] public Bundles2.Bundle bundle { get; set; }

	protected override async Task OnInitializedAsync()
	{
		Herramientas.ContextoUsuarioDatos datos = Herramientas.ContextoUsuario.Leer(Contexto);
		idioma = datos.Idioma;
		usuarioId = datos.UsuarioId;
		userAgent = datos.UserAgent;
		dominio = datos.Dominio;

		if (string.IsNullOrEmpty(usuarioId) == false)
		{
			idioma = await BaseDatos.Usuarios.Buscar.IdiomaSobreescribir(usuarioId);
			juegosUsuario ??= await Herramientas.UsuarioJuegos.Cargar(usuarioId);
			deseadosUsuario ??= await BaseDatos.Usuarios.Buscar.DeseadosTiene(usuarioId);
			usuarioPatreon = Herramientas.Patreon.VerificarActivo(await BaseDatos.Usuarios.Buscar.FechaPatreon(usuarioId));
			usuarioAdmin = await BaseDatos.Usuarios.Buscar.RolDios(usuarioId);
		}

		bundle ??= await BaseDatos.Bundles.Buscar.UnBundle(bundleId);
	}

	private Dictionary<int, Juegos.Juego> juegosBundlePrecargados = new();

	protected override async Task OnParametersSetAsync()
	{
		if (bundle?.Juegos != null)
		{
			juegosBundlePrecargados.Clear();

			foreach (var item in bundle.Juegos)
			{
				if (item != null)
				{
					if (!juegosBundlePrecargados.ContainsKey(int.Parse(item.JuegoId)))
					{
						var juego = await BaseDatos.Juegos.Buscar.UnJuego(item.JuegoId);
						juegosBundlePrecargados[int.Parse(item.JuegoId)] = juego;
					}
				}
			}
		}
	}

	protected override async Task OnAfterRenderAsync(bool primerRender)
	{
		if (primerRender == true)
		{
			if (bundle == null)
			{
				bundle ??= await BaseDatos.Bundles.Buscar.UnBundle(bundleId);
			}

			if (bundle != null)
			{
				if (tipo == Tipo.Bundle && string.IsNullOrEmpty(bundleNombre) == true)
				{
					await JavaScript.InvokeVoidAsync("ChangeUrl", "/bundle/" + bundle.Id.ToString() + "/" + Herramientas.EnlaceAdaptador.Nombre(bundle.Nombre) + "/");
				}

				if (bundle?.Juegos?.Count > 0)
				{
					foreach (var juego in bundle.Juegos)
					{
						if (string.IsNullOrEmpty(juego.JuegoId) == false)
						{
							juego.Juego = await BaseDatos.Juegos.Buscar.UnJuego(juego.JuegoId);
							juego.Imagen = juego.Juego.Imagenes.Header_460x215;
						}
					}
				}
			}	

			await InvokeAsync(StateHasChanged);
		}
	}

	public enum Tipo
	{
		Bundle,
		Bundles,
		Juego,
		Noticia
	}

	private List<Bundles2.BundleTier> OrdenarTiers(List<Bundles2.BundleTier> tiers)
	{
		if (tiers != null)
		{
			tiers.Sort(delegate (Bundles2.BundleTier t1, Bundles2.BundleTier t2)
			{
				return t1.Posicion.CompareTo(t2.Posicion);
			});
		}

		return tiers;
	}

	private async void AbrirBundle(MouseEventArgs e, string enlace)
	{
		await JavaScript.InvokeVoidAsync("open", enlace, "_blank");
	}

	#region Herramientas

	private List<JuegoValoracion> valoraciones = null;

	private async Task GenerarValoraciones(MouseEventArgs e)
	{
		valoraciones = await Herramientas.Bundles.ValorEstimado.Generar(bundle);
	}

	private string contenidoCajaClipboard = null;

	private async Task GenerarBBCode(MouseEventArgs e)
	{
		contenidoCajaClipboard = await Herramientas.Bundles.BBCode.Generar(idioma, bundle);
	}

	private async Task GenerarReddit(MouseEventArgs e)
	{
		contenidoCajaClipboard = await Herramientas.RedesSociales.Reddit.Bundle(bundle);
	}

	private async Task GenerarMarkdown(MouseEventArgs e)
	{
		contenidoCajaClipboard = await Herramientas.Bundles.Markdown.Generar(idioma, bundle);
	}

	#endregion

	#region Portapapeles

	private bool enseñarAlerta = false;
	private PeriodicTimer cronometro = null;
	private int cronometroContador = 0;
	private int cronometroLimite = 10;

	private async void CopiarAlClipboard()
	{
		enseñarAlerta = true;
		await JavaScript.InvokeVoidAsync("clipboardCopy.copyText", contenidoCajaClipboard);

		cronometroContador = 0;
		cronometro = new PeriodicTimer(TimeSpan.FromSeconds(1));

		while (await cronometro.WaitForNextTickAsync())
		{
			cronometroContador += 1;

			if (cronometroContador > cronometroLimite)
			{
				enseñarAlerta = false;
				cronometro.Dispose();
				await InvokeAsync(StateHasChanged);
			}
		}
	}

	private void CerrarAvisoClipboard()
	{
		enseñarAlerta = false;
		cronometroContador = 0;

		if (cronometro != null)
		{
			cronometro.Dispose();
		}
	}

	#endregion
}
