@page "/streaming/"
@page "/streaming/{streamingSeleccionadoTexto}/"

@using Juegos
@using System.Text.Json
@using pepeizqs_deals_blazor_web.Componentes.Interfaz
@using pepeizqs_deals_web.Data

@inject IHttpContextAccessor Contexto
@inject IJSRuntime JavaScript

@if (streamingSeleccionado != Streaming2.StreamingTipo.Desconocido)
{
    <Titulo tipo="@Titulo.Tipo.Streaming" idioma="@idioma" dominio="@dominio" tituloStreaming="@Streaming2.StreamingCargar.DevolverStreaming(streamingSeleccionado).Nombre" enlaceStreaming="@Herramientas.EnlaceAdaptador.Nombre(streamingSeleccionado.ToString().ToLower())" />
}
else
{
    <Titulo tipo="@Titulo.Tipo.Streaming" idioma="@idioma" dominio="@dominio" />
}

<script>
    function enseñarTooltip(e, id) {
        var x = e.clientX,
            y = e.clientY;

        var tooltip = document.getElementById(id);

        if (screen.width / 2 > x) {
            tooltip.style.top = (y + 10) + 'px';
            tooltip.style.left = (x + 20) + 'px';
        }
        else {
            tooltip.style.top = (y - 10) + 'px';
            tooltip.style.left = (x - 20 - tooltip.getBoundingClientRect().width) + 'px';
        };
    }
</script>

<script>
    window.ChangeUrl = function (url) {
        history.pushState(null, '', url);
    }
</script>

<style>
    .streaming-grid {
        gap: 30px;
    }

    .streaming-grid {
        padding: 30px;
        gap: 30px;
    }

    @@media (max-width: 800px) {
        .streaming-grid {
            gap: 15px;
        }

        .streaming-grid {
            padding: 15px;
            gap: 15px;
        }
    }
</style>

<style>
    :root {
        --glaseadoBorde: #FFFFFF1A;
        --glaseadoFondo: rgba(45, 47, 54, 0.70);
        --noResultados: rgba(132, 32, 41, 0.5);
        --botonSeleccionado: rgba(13, 22, 33, 0.75);
    }

    .caja-streaming {
        box-shadow: 0 22px 34px 0 rgba(0, 0, 0, 0.25);
        background-blend-mode: overlay;
        border-radius: 100px;
        border: 2px solid var(--glaseadoBorde);
        width: fit-content;
        background-color: var(--fondoSubcabecera);
        backdrop-filter: blur(25px);
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 5px;
    }

    .caja-streaming-animacion {
        opacity: 0;
        transition: all 0.5s ease, transform .2s ease;
        pointer-events: none;
        transform: scaleX(0);
        transform-origin: left;
        max-width: 0;
    }

        .caja-streaming-animacion.visible {
            opacity: 1;
            pointer-events: auto;
            transform: scaleX(1);
            max-width: fit-content;
        }

    .boton-streaming {
        transition: backdrop-filter 0.2s ease;
    }

        .boton-streaming:hover {
            backdrop-filter: brightness(50%);
        }
</style>

<style>
    .caja-streaming-contenido {
        background-color: var(--fondoSubsubcabecera);
        box-shadow: 0px 4px 8px 0px rgba(0, 0, 0, 0.28),0px 0px 2px 0px rgba(0, 0, 0, 0.24);
        border: 1px solid var(--glaseadoBorde);
        border-radius: 20px;
    }

    .caja-streaming-titulo {
        background: color-mix(in srgb, var(--fondoSubcabecera) 45%, var(--fondoBotonPequeño));
        padding: 20px 30px;
        border-top-left-radius: inherit;
        border-top-right-radius: inherit;
    }
</style>

<div style="display: flex; align-items: center; justify-content: center; margin-top: 40px; transition: transform 0.3s ease, opacity 0.3s ease; flex-wrap: wrap;">
	<div class="caja-streaming">
        <button @onclick="@(e => StreamingAbrir(e, Streaming2.StreamingTipo.Desconocido))" class="boton-bundles" style="@CambiarEstilo(Streaming2.StreamingTipo.Desconocido) border: 0px; height: 50px; padding: 15px 25px; display: inline-flex; align-items: center; color: var(--colorTexto); border-radius: inherit;">
            <div>
                <h1 style="font-size: 16px; margin: 0px;">
                    @Herramientas.Idiomas.BuscarTexto(idioma, "String1", "Streaming")
                </h1>
            </div>
        </button>

        @if (Herramientas.Bots.UserAgentEsBot(userAgent) == false)
        {
            if (streamingSeleccionado == Streaming2.StreamingTipo.Desconocido)
            {
                foreach (var streaming in Streaming2.StreamingCargar.GenerarListado())
                {
                    if (streaming.Id != Streaming2.StreamingTipo.Desconocido)
                    {
                        <button @onclick="@(e => StreamingAbrir(e, streaming.Id))" class="boton-streaming" style="@CambiarEstilo(streaming.Id) border: 0px; height: 50px; padding: 15px 25px; display: inline-flex; align-items: center; color: var(--colorTexto); border-radius: inherit;">
                            <img src="@streaming.ImagenIcono" style="width: 20px; height: 20px;" alt="@streaming.Nombre" />
						</button>
                    }
                }
            }
            else
            {
                var elegido = Streaming2.StreamingCargar.DevolverStreaming(streamingSeleccionado);

                <button @onclick="@(e => StreamingAbrir(e, elegido.Id))" class="boton-streaming" style="@CambiarEstilo(elegido.Id) border: 0px; height: 50px; padding: 15px 25px; display: inline-flex; align-items: center; gap: 10px; color: var(--colorTexto); border-radius: inherit;">
                    <img src="@elegido.ImagenIcono" style="width: 20px; height: 20px;" alt="@elegido.Nombre" />

                    <div>
                        @elegido.Nombre
                    </div>
                </button>
            }
        }
    </div>

    @if (streamingSeleccionado != Streaming2.StreamingTipo.Desconocido)
    {
        if (string.IsNullOrEmpty(usuarioId) == false)
        {
            <div class="tooltip-juego" onmousemove="enseñarTooltip(event, 'tooltip-streaming-show')">
                <button @onclick="MostrarOcultarMostrar" style="background: transparent; border: 0px; margin-left: 30px; color: var(--colorTexto);">
                    @Herramientas.Idiomas.BuscarTexto(idioma, "String6", "Streaming")
                </button>

                <div id="tooltip-streaming-show" class="tooltip-relleno">
                    <div style="margin: 8px; max-width: 300px; font-size: 14px;">
                        @Herramientas.Idiomas.BuscarTexto(idioma, "String6", "Streaming")
                    </div>
                </div>
            </div>
        }

        <div class="tooltip-juego" onmousemove="enseñarTooltip(event, 'tooltip-streaming-order')">
            <button @onclick="MostrarOcultarOrdenar" style="background: transparent; border: 0px; margin-left: 30px;">
                <div style="width: 24px; height: 24px;">
                    <svg class="svg-boton" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                        <path d="M130.4 268.2C135.4 280.2 147 288 160 288L480 288C492.9 288 504.6 280.2 509.6 268.2C514.6 256.2 511.8 242.5 502.7 233.3L342.7 73.3C330.2 60.8 309.9 60.8 297.4 73.3L137.4 233.3C128.2 242.5 125.5 256.2 130.5 268.2zM130.4 371.7C125.4 383.7 128.2 397.4 137.3 406.6L297.3 566.6C309.8 579.1 330.1 579.1 342.6 566.6L502.6 406.6C511.8 397.4 514.5 383.7 509.5 371.7C504.5 359.7 492.9 352 480 352L160 352C147.1 352 135.4 359.8 130.4 371.8z" />
                    </svg>
                </div>
            </button>

            <div id="tooltip-streaming-order" class="tooltip-relleno">
                <div style="margin: 8px; max-width: 300px; font-size: 14px;">
                    @Herramientas.Idiomas.BuscarTexto(idioma, "String2", "Streaming")
                </div>
            </div>
        </div>

        <div style="display: flex; align-items: center; gap: 25px; max-width: 500px; height: 45px; margin-left: 30px; @anchoBuscador">
            <div class="tooltip-juego" onmousemove="enseñarTooltip(event, 'tooltip-streaming-search')">
                <button @onclick="MostrarOcultarBuscador" style="background: transparent; border: 0px;">
                    <div style="width: 24px; height: 24px;">
                        <svg class="svg-boton" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                            <path d="M480 272C480 317.9 465.1 360.3 440 394.7L566.6 521.4C579.1 533.9 579.1 554.2 566.6 566.7C554.1 579.2 533.8 579.2 521.3 566.7L394.7 440C360.3 465.1 317.9 480 272 480C157.1 480 64 386.9 64 272C64 157.1 157.1 64 272 64C386.9 64 480 157.1 480 272zM272 416C351.5 416 416 351.5 416 272C416 192.5 351.5 128 272 128C192.5 128 128 192.5 128 272C128 351.5 192.5 416 272 416z" />
                        </svg>
                    </div>
                </button>

                <div id="tooltip-streaming-search" class="tooltip-relleno">
                    <div style="margin: 8px; max-width: 300px; font-size: 14px;">
                        @Herramientas.Idiomas.BuscarTexto(idioma, "String10", "Streaming")
                    </div>
                </div>
            </div>

            <div class="caja-streaming caja-streaming-animacion @(mostrarBuscador ? "visible" : "")">
                <input type="text" @bind-value="textoBuscador" @bind-value:event="oninput" @bind-value:after="TextoCambiaBuscador" @onclick="ClickBuscador" @onfocusout="PerderBuscador" class="entrada-texto" style="border-radius: inherit; color: var(--colorTexto); padding: 5px 15px; border: 0px; transition: background-color 1000ms linear; @fondoBuscador" placeholder="@Herramientas.Idiomas.BuscarTexto(idioma, "String10", "Streaming")" />
            </div>
        </div>
    }
</div>

@if (streamingSeleccionado == Streaming2.StreamingTipo.Desconocido)
{
    <div class="cuerpo-ancho caja-streaming-contenido" style="margin-top: 40px; margin-bottom: 40px; display: flex; flex-direction: column;">
        <div class="caja-streaming-titulo" style="padding: 30px; display: flex; align-items: center; gap: 30px;">
            <div style="min-width: 30px; height: 30px;">
                <svg class="svg-boton" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                    <path d="M528 320C528 205.1 434.9 112 320 112C205.1 112 112 205.1 112 320C112 434.9 205.1 528 320 528C434.9 528 528 434.9 528 320zM64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576C178.6 576 64 461.4 64 320zM320 240C302.3 240 288 254.3 288 272C288 285.3 277.3 296 264 296C250.7 296 240 285.3 240 272C240 227.8 275.8 192 320 192C364.2 192 400 227.8 400 272C400 319.2 364 339.2 344 346.5L344 350.3C344 363.6 333.3 374.3 320 374.3C306.7 374.3 296 363.6 296 350.3L296 342.2C296 321.7 310.8 307 326.1 302C332.5 299.9 339.3 296.5 344.3 291.7C348.6 287.5 352 281.7 352 272.1C352 254.4 337.7 240.1 320 240.1zM288 432C288 414.3 302.3 400 320 400C337.7 400 352 414.3 352 432C352 449.7 337.7 464 320 464C302.3 464 288 449.7 288 432z" />
                </svg>
            </div>

            <div>
                @Herramientas.Idiomas.BuscarTexto(idioma, "String12", "Streaming")
            </div>
        </div>

        <div class="streaming-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 40px; padding: 40px;">
            @foreach (var streaming in Streaming2.StreamingCargar.GenerarListado())
            {
                <button @onclick="@(e => StreamingAbrir(e, streaming.Id))" class="boton-pequeño suscripcion-grid" style="display: flex; flex-direction: column; align-items: center; padding: 20px;">
                    <div style="width: 220px; height: 50px; display: flex; justify-content: center;">
                        <img src="@Herramientas.Ficheros.Imagenes.ServidorExterno(streaming.ImagenLogo, 200, 50)" alt="@streaming.Nombre" style="max-width: 100%; max-height: 100%; object-fit: contain;" />
                    </div>
                </button>
            }
        </div>
    </div>
}
else
{
    <div class="cuerpo-ancho" style="max-width: 1000px; margin-top: 40px; margin-bottom: 40px;">
        @if (juegos?.Count > 0)
        {
            <div class="caja-streaming-contenido" style="padding: 20px 25px; display: flex; flex-direction: column; gap: 20px;">
                <Virtualize Context="juego" Items="@juegos">
                    <a class="boton-pequeño" style="padding: 0px;" href="/game/@juego.Id.ToString()/@Herramientas.EnlaceAdaptador.Nombre(juego.Nombre)/" target="_self">
                        <div style="width: 100%; display: flex; align-items: center; gap: 20px;">
                            <div style="width: 161px; height: 60px;">
                                <img src="@Herramientas.Ficheros.Imagenes.ServidorExterno(juego.Imagenes.Capsule_231x87)" style="max-width: 100%; height: 100%;" alt="@juego.Nombre" />
                            </div>

                            <div>
                                @juego.Nombre
                            </div>

                            @if (juego.DRMs2?.Count > 0)
                            {
                                <div style="margin-left: auto; margin-right: 10px; display: flex; align-items: center; gap: 5px;">
                                    @foreach (var drm in juego.DRMs2)
                                    {
                                        string fondoColor = string.Empty;

                                        if (drm.UsuarioTiene == true)
                                        {
                                            fondoColor = "background-color: var(--fondoBien);";
                                        }

                                        <div style="padding: 10px; @fondoColor">
                                            <img src="@JuegoDRM2.SacarImagen(drm.DRM)" style="width: 26px; height: 26px;" />
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </a>
                </Virtualize>
            </div>
        }
        else
        {
            <div class="caja-streaming" style="background-color: var(--noResultados); display: flex; align-items: center; gap: 30px; justify-content: center; margin: 40px auto; padding: 20px; border-radius: 30px; max-width: 600px;">
                <div style="width: 30px; height: 30px; flex-shrink: 0;">
                    <svg class="svg-boton" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                        <path d="M528 320C528 205.1 434.9 112 320 112C205.1 112 112 205.1 112 320C112 434.9 205.1 528 320 528C434.9 528 528 434.9 528 320zM64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576C178.6 576 64 461.4 64 320zM320 240C302.3 240 288 254.3 288 272C288 285.3 277.3 296 264 296C250.7 296 240 285.3 240 272C240 227.8 275.8 192 320 192C364.2 192 400 227.8 400 272C400 319.2 364 339.2 344 346.5L344 350.3C344 363.6 333.3 374.3 320 374.3C306.7 374.3 296 363.6 296 350.3L296 342.2C296 321.7 310.8 307 326.1 302C332.5 299.9 339.3 296.5 344.3 291.7C348.6 287.5 352 281.7 352 272.1C352 254.4 337.7 240.1 320 240.1zM288 432C288 414.3 302.3 400 320 400C337.7 400 352 414.3 352 432C352 449.7 337.7 464 320 464C302.3 464 288 449.7 288 432z" />
                    </svg>
                </div>

                <div>
                    @Herramientas.Idiomas.BuscarTexto(idioma, "String13", "Streaming")
                </div>
            </div>
        }
    </div>
}

@if (mostrarMostrar == true)
{
    <div class="opciones-panel">
        <div style="max-width: 500px; width: 100%; background-color: var(--fondoSubcabecera); border: 2px solid var(--fondoSubcabecera); margin: 20px auto; overflow-y: scroll; position: relative; justify-content: center; scrollbar-color: var(--fondoCodigo) var(--fondoOscuro); border-radius: 20px; box-shadow: 0px 4px 8px 0px rgba(0, 0, 0, 0.28),0px 0px 2px 0px rgba(0, 0, 0, 0.24);">
            <div style="display: flex; align-items: center; gap: 30px; padding: 20px 30px; background: color-mix(in srgb, var(--fondoSubcabecera) 55%, var(--fondoBotonPequeño)); justify-content: center;">
                <button class="boton-pequeño" @onclick="MostrarOcultarMostrar" style="width: fit-content; padding: 10px 15px; position: absolute; left: 30px;">
                    <div style="max-width: 24px; max-height: 24px;">
                        <svg class="svg-icono" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                            <path d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.2 288 416 288c17.7 0 32-14.3 32-32s-14.3-32-32-32l-306.7 0L214.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z" />
                        </svg>
                    </div>
                </button>

                <div style="font-size: 20px;">
                    @Herramientas.Idiomas.BuscarTexto(idioma, "String6", "Streaming")
                </div>
            </div>

            <div style="padding: 30px; display: flex; flex-direction: column; gap: 20px;">
                <button class="boton-pequeño" style="padding: 15px 25px; text-align: center;" @onclick="@(e => Mostrar(e, 0))">
                    @Herramientas.Idiomas.BuscarTexto(idioma, "String7", "Streaming")
                </button>
                <button class="boton-pequeño" style="padding: 15px 25px; text-align: center;" @onclick="@(e => Mostrar(e, 1))">
                    @Herramientas.Idiomas.BuscarTexto(idioma, "String8", "Streaming")
                </button>
                <button class="boton-pequeño" style="padding: 15px 25px; text-align: center;" @onclick="@(e => Mostrar(e, 2))">
                    @Herramientas.Idiomas.BuscarTexto(idioma, "String9", "Streaming")
                </button>
            </div>
        </div>
    </div>
}

@if (mostrarOrdenar == true)
{
    <div class="opciones-panel">
        <div style="max-width: 500px; width: 100%; background-color: var(--fondoSubcabecera); border: 2px solid var(--fondoSubcabecera); margin: 20px auto; overflow-y: scroll; position: relative; justify-content: center; scrollbar-color: var(--fondoCodigo) var(--fondoOscuro); border-radius: 20px; box-shadow: 0px 4px 8px 0px rgba(0, 0, 0, 0.28),0px 0px 2px 0px rgba(0, 0, 0, 0.24);">
            <div style="display: flex; align-items: center; gap: 30px; padding: 20px 30px; background: color-mix(in srgb, var(--fondoSubcabecera) 55%, var(--fondoBotonPequeño)); justify-content: center;">
                <button class="boton-pequeño" @onclick="MostrarOcultarOrdenar" style="width: fit-content; padding: 10px 15px; position: absolute; left: 30px;">
                    <div style="max-width: 24px; max-height: 24px;">
                        <svg class="svg-icono" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                            <path d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.2 288 416 288c17.7 0 32-14.3 32-32s-14.3-32-32-32l-306.7 0L214.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z" />
                        </svg>
                    </div>
                </button>

                <div style="font-size: 20px;">
                    @Herramientas.Idiomas.BuscarTexto(idioma, "String2", "Streaming")
                </div>
            </div>

            <div style="padding: 30px; display: flex; flex-direction: column; gap: 20px;">
                <button class="boton-pequeño" style="padding: 15px 25px; text-align: center;" @onclick="@(e => OrdenarPor(e, 0))">
                    @Herramientas.Idiomas.BuscarTexto(idioma, "String3", "Streaming")
                </button>
                <button class="boton-pequeño" style="padding: 15px 25px; text-align: center;" @onclick="@(e => OrdenarPor(e, 1))">
                    @Herramientas.Idiomas.BuscarTexto(idioma, "String4", "Streaming")
                </button>
                <button class="boton-pequeño" style="padding: 15px 25px; text-align: center;" @onclick="@(e => OrdenarPor(e, 2))">
                    @Herramientas.Idiomas.BuscarTexto(idioma, "String5", "Streaming")
                </button>
            </div>
        </div>
    </div>
}

@code {

    #nullable disable

    private string idioma = "en";
    private string usuarioId = null;
    private string userAgent = null;
    private string dominio = null;

    [PersistentState] public Herramientas.UsuarioListadosJuegos juegosUsuario { get; set; }
    [PersistentState] public Usuario deseadosUsuario { get; set; }

    [Parameter] public string streamingSeleccionadoTexto { get; set; }
    public Streaming2.StreamingTipo streamingSeleccionado { get; set; } = Streaming2.StreamingTipo.Desconocido;

    [PersistentState] public List<JuegoStreaming> juegos { get; set; }
    public int ordenarPor { get; set; } = 0;
    public int mostrar { get; set; } = 0;

    protected override async Task OnInitializedAsync()
    {
        Herramientas.ContextoUsuarioDatos datos = Herramientas.ContextoUsuario.Leer(Contexto);
        idioma = datos.Idioma;
        usuarioId = datos.UsuarioId;
        userAgent = datos.UserAgent;
        dominio = datos.Dominio;

        if (string.IsNullOrEmpty(usuarioId) == false)
        {
            idioma = await BaseDatos.Usuarios.Buscar.IdiomaSobreescribir(usuarioId);
            juegosUsuario ??= await Herramientas.UsuarioJuegos.Cargar(usuarioId);
            deseadosUsuario ??= await BaseDatos.Usuarios.Buscar.DeseadosTiene(usuarioId);
        }

        if (string.IsNullOrEmpty(streamingSeleccionadoTexto) == false)
        {
            foreach (var streaming in Streaming2.StreamingCargar.GenerarListado())
            {
                if (streaming.Id != Streaming2.StreamingTipo.Desconocido)
                {
                    if (Herramientas.EnlaceAdaptador.Nombre(streaming.Id.ToString().ToLower()) == streamingSeleccionadoTexto)
                    {
                        streamingSeleccionado = streaming.Id;
                        break;
                    }
                }
            }

            if (streamingSeleccionado != Streaming2.StreamingTipo.Desconocido)
            {
                await StreamingAbrir(streamingSeleccionado);
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool primerRender)
    {
        if (primerRender == true)
        {
            if (streamingSeleccionado != Streaming2.StreamingTipo.Desconocido)
            {
                await CambiarEnlace(streamingSeleccionado);
            }
        }
    }

    private async Task StreamingAbrir(MouseEventArgs e, Streaming2.StreamingTipo streaming)
    {
        streamingSeleccionado = streaming;

        if (streaming != Streaming2.StreamingTipo.Desconocido)
        {
            await CambiarEnlace(streaming);
            await StreamingAbrir(streaming);
        }
        else
        {
            await JavaScript.InvokeVoidAsync("ChangeUrl", "/streaming/"); 
        }
    }

    private async Task StreamingAbrir(Streaming2.StreamingTipo streaming)
    {
        streamingSeleccionado = streaming;

        juegos = await BaseDatos.Streaming.Buscar.BuscarJuegos("streaming" + Herramientas.EnlaceAdaptador.Nombre(streaming.ToString().ToLower()), ordenarPor, textoBuscador);

        if (juegos?.Count > 0)
        {
            foreach (var juego in juegos)
            {
                if (juego.DRMs.Contains("[") == true && juego.DRMs.Contains("]") == true)
                {
                    List<string> drms = JsonSerializer.Deserialize<List<string>>(juego?.DRMs ?? "") ?? new List<string>();

                    if (drms?.Count > 0)
                    {
                        foreach (var drm in drms)
                        {
                            JuegoStreamingDRM nuevoDRM = new JuegoStreamingDRM();
                            nuevoDRM.DRM = JuegoDRM2.Traducir(drm);

                            if (nuevoDRM.DRM != JuegoDRM.NoEspecificado)
                            {
                                if (juego.DRMs2 == null)
                                {
                                    juego.DRMs2 = new List<JuegoStreamingDRM>();
                                }

                                if (string.IsNullOrEmpty(usuarioId) == false)
                                {
                                    Juegos.Juego nuevoJuego = new Juegos.Juego();
                                    nuevoJuego.IdSteam = juego.IdSteam;
                                    nuevoJuego.IdGog = juego.IdGog;

                                    bool usuarioTieneJuego = Herramientas.UsuarioJuegos.ComprobarSiTiene(juegosUsuario, nuevoJuego, nuevoDRM.DRM);

                                    nuevoDRM.UsuarioTiene = usuarioTieneJuego;
                                }

                                juego.DRMs2.Add(nuevoDRM);
                            }
                        }
                    }
                }
                else
                {
                    if (juego.DRMs2 == null)
                    {
                        juego.DRMs2 = new List<JuegoStreamingDRM>();
                    }

                    JuegoStreamingDRM nuevoDRM = new JuegoStreamingDRM();
                    nuevoDRM.DRM = JuegoDRM2.Traducir(juego.DRMs);

                    if (nuevoDRM.DRM != JuegoDRM.NoEspecificado)
                    {
                        if (string.IsNullOrEmpty(usuarioId) == false)
                        {
                            Juegos.Juego nuevoJuego = new Juegos.Juego();
                            nuevoJuego.IdSteam = juego.IdSteam;
                            nuevoJuego.IdGog = juego.IdGog;

                            bool usuarioTieneJuego = Herramientas.UsuarioJuegos.ComprobarSiTiene(juegosUsuario, nuevoJuego, nuevoDRM.DRM);

                            nuevoDRM.UsuarioTiene = usuarioTieneJuego;
                        }

                        juego.DRMs2.Add(nuevoDRM);
                    }
                }
            }

            juegos = juegos.GroupBy(j => j.Id).Select(grupo =>
            {
                var juegoBase = grupo.First();

                juegoBase.DRMs2 = grupo
                    .Where(j => j.DRMs2 != null)
                    .SelectMany(j => j.DRMs2)
                    .GroupBy(d => d.DRM)
                    .Select(g => g.First())
                    .ToList();

                return juegoBase;
            }).ToList();

            if (mostrar == 1)
            {
                juegos = juegos
                    .Where(j => j.DRMs2 != null && j.DRMs2.Any(d => d.UsuarioTiene))
                    .ToList();
            }
            else if (mostrar == 2)
            {
                juegos = juegos
                    .Where(j => j.DRMs2 != null && j.DRMs2.All(d => d.UsuarioTiene == false))
                    .ToList();
            }
        }
    }

    private async Task CambiarEnlace(Streaming2.StreamingTipo streaming)
    {
        await JavaScript.InvokeVoidAsync("ChangeUrl", $"/streaming/{Herramientas.EnlaceAdaptador.Nombre(streaming.ToString().ToLower())}/");
    }

    private string CambiarEstilo(Streaming2.StreamingTipo nuevoTipo)
    {
        if (nuevoTipo != streamingSeleccionado)
        {
            return "background-color: transparent;";
        }
        else
        {
            return "background-color: var(--botonSeleccionado);";
        }
    }

    private bool mostrarOrdenar = false;

    private async Task MostrarOcultarOrdenar()
    {
        mostrarOrdenar = !mostrarOrdenar;
    }

    private async Task OrdenarPor(MouseEventArgs e, int nuevoOrdenar)
    {
        ordenarPor = nuevoOrdenar;

        await StreamingAbrir(streamingSeleccionado);
    }

    private bool mostrarMostrar = false;

    private async Task MostrarOcultarMostrar()
    {
        mostrarMostrar = !mostrarMostrar;
    }

    private async Task Mostrar(MouseEventArgs e, int nuevoMostrar)
    {
        mostrar = nuevoMostrar;

        await StreamingAbrir(streamingSeleccionado);
    }

    #region Buscador

    private string textoBuscador { get; set; }
    private bool mostrarBuscador { get; set; } = false;
    private string anchoBuscador => mostrarBuscador ? "width: fit-content;" : "width: 35px;";
    private string fondoBuscador = "background-color: var(--fondoEntrada);";
    private bool haEscrito = false;

    private void MostrarOcultarBuscador()
    {
        mostrarBuscador = !mostrarBuscador;
    }

    private async Task TextoCambiaBuscador()
    {
        await StreamingAbrir(streamingSeleccionado);

        if (haEscrito == false)
        {
            if (textoBuscador?.Trim().Length > 0)
            {
                haEscrito = true;
            }
        }
        else if (haEscrito == true)
        {
            if (textoBuscador?.Trim().Length == 0)
            {
                mostrarBuscador = false;
                haEscrito = false;
            }
        }
    }

    private void ClickBuscador()
    {
        fondoBuscador = "background-color: var(--fondoBotonPequeñoHover);";
    }

    private void PerderBuscador()
    {
        if (string.IsNullOrEmpty(textoBuscador) == true)
        {
            fondoBuscador = "background-color: var(--fondoEntrada);";
        }
    }

    #endregion
}
